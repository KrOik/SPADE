<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="css/translation-component.css">
    <script src="js/translation-component.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- 预连接优化 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://unpkg.com">
    
    <!-- 关键CSS优先加载 -->
    <link rel="preload" href="css/iconfont.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="css/style.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    
    <!-- 图标和外部CSS -->
    <link rel="shortcut icon" href="source/img/favicon.ico">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    
    <!-- 回退样式表 -->
    <noscript>
        <link rel="stylesheet" href="css/iconfont.css">
        <link rel="stylesheet" href="css/style.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    </noscript>
    
    <title>SPADE Peptide Details</title>
    
    <!-- 延迟加载的脚本 -->
    <script>
        // 延迟加载非关键脚本
        window.addEventListener('load', function() {
            const scripts = [
                'js/anti-crawler-protection.js',
                'js/data-obfuscator.js',
                'js/quick-notes.js',
                'js/reading-progress.js'
            ];
            
            scripts.forEach((src, index) => {
                setTimeout(() => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.async = true;
                    
                    // 特殊处理快速笔记脚本
                    if (src === 'js/quick-notes.js') {
                        script.onload = function() {
                            console.log('Quick Notes loaded successfully');
                            // 确保快速笔记按钮事件绑定
                            setTimeout(initQuickNotesButton, 100);
                        };
                        script.onerror = function() {
                            console.warn('Quick Notes failed to load');
                        };
                    }
                    
                    // 特殊处理阅读进度脚本
                    if (src === 'js/reading-progress.js') {
                        script.onload = function() {
                            console.log('Reading Progress script loaded successfully');
                            console.log('window.ReadingProgressComponent:', window.ReadingProgressComponent);
                            // 组件会自动初始化，我们只需要等待并验证
                            setTimeout(() => {
                                if (window.readingProgressComponent) {
                                    console.log('阅读进度组件自动初始化成功');
                                    // 增强视觉效果配置
                                    window.readingProgressComponent.setTheme({
                                        primary: '#00D4FF',
                                        secondary: '#FF006E'
                                    });
                                    
                                    // 增强进度条视觉效果
                                    enhanceProgressBarVisibility();
                                } else {
                                    console.log('自动初始化失败，尝试手动初始化');
                                    initReadingProgress();
                                }
                            }, 500);
                        };
                        script.onerror = function(error) {
                            console.error('Reading Progress script failed to load:', error);
                            console.error('Script src:', src);
                        };
                    }
                    
                    document.head.appendChild(script);
                }, index * 100);
            });
        });
        
        // 初始化阅读进度组件
        function initReadingProgress() {
            console.log('开始初始化阅读进度组件...');
            console.log('可用的全局对象:', Object.keys(window).filter(key => key.toLowerCase().includes('reading')));
            
            // 等待DOM完全加载和组件可用
            const tryInitialize = () => {
                // 检查多种可能的组件名称
                const possibleComponents = [
                    'ReadingProgressComponent',
                    'ReadingProgress', 
                    'readingProgress'
                ];
                
                let ComponentClass = null;
                for (const name of possibleComponents) {
                    if (window[name] && typeof window[name] === 'function') {
                        ComponentClass = window[name];
                        console.log(`找到组件构造函数: ${name}`);
                        break;
                    }
                }
                
                if (ComponentClass) {
                    try {
                        // 使用找到的组件构造函数初始化
                        const readingProgress = new ComponentClass({
                            visibilityThreshold: 100, // 滚动100px后显示
                            scrollDuration: 300,
                            progressBar: {
                                position: 'header-bottom',
                                height: 4,
                                zIndex: 9999
                            },
                            theme: {
                                primary: '#00D4FF',
                                secondary: '#FF006E'
                            },
                            autoInit: true,
                            debug: true
                        });
                        
                        console.log('Reading Progress component initialized successfully');
                        
                        // 保存实例到全局变量以便调试
                        window.readingProgressInstance = readingProgress;
                        
                        return true;
                    } catch (error) {
                        console.error('Failed to initialize Reading Progress:', error);
                        console.error('Error details:', error.stack);
                        return false;
                    }
                } else {
                    console.warn('Reading Progress component not found. Available window properties:', 
                        Object.keys(window).filter(key => key.toLowerCase().includes('reading')));
                    return false;
                }
            };
            
            // 立即尝试初始化
            if (!tryInitialize()) {
                // 如果失败，等待一段时间后重试
                let retryCount = 0;
                const maxRetries = 15;
                const retryInterval = setInterval(() => {
                    retryCount++;
                    console.log(`尝试初始化阅读进度组件 (${retryCount}/${maxRetries})`);
                    
                    if (tryInitialize() || retryCount >= maxRetries) {
                        clearInterval(retryInterval);
                        if (retryCount >= maxRetries) {
                            console.error('阅读进度组件初始化失败，已达到最大重试次数');
                            console.error('最终检查 - 可用的window属性:', Object.keys(window).filter(key => key.toLowerCase().includes('reading')));
                        }
                    }
                }, 300);
            }
        }
        
        // 初始化快速笔记按钮
        function initQuickNotesButton() {
            const notesBtn = document.getElementById('quick-notes-btn');
            if (notesBtn && window.quickNotes) {
                notesBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.quickNotes.toggle();
                });
                
                // 添加图标样式
                const icon = notesBtn.querySelector('i');
                if (icon) {
                    icon.style.transition = 'all 0.2s ease';
                    notesBtn.addEventListener('mouseenter', () => {
                        icon.style.transform = 'scale(1.1)';
                    });
                    notesBtn.addEventListener('mouseleave', () => {
                        icon.style.transform = 'scale(1)';
                    });
                }
                
                console.log('Quick Notes button initialized');
            } else {
                console.warn('Quick Notes button or component not found');
            }
        }
        
        // 增强进度条视觉效果 - 升级版
        function enhanceProgressBarVisibility() {
            console.log('开始增强进度条视觉效果（升级版）...');
            
            // 等待进度条元素创建
            setTimeout(() => {
                const progressContainer = document.querySelector('.reading-progress-bar-container');
                const progressBar = document.querySelector('.reading-progress-bar');
                const progressFill = document.querySelector('.reading-progress-fill');
                
                if (progressContainer && progressBar && progressFill) {
                    console.log('找到进度条元素，开始升级视觉效果...');
                    
                    // 创建百分比显示元素
                    const percentageEl = document.createElement('div');
                    percentageEl.className = 'progress-percentage';
                    percentageEl.textContent = '0%';
                    
                    // 增强容器样式 - 立体玻璃质感
                    progressContainer.style.cssText += `
                        height: 12px !important;
                        background: rgba(255,255,255,0.1) !important;
                        backdrop-filter: blur(16px) !important;
                        border-radius: 8px !important;
                        box-shadow:
                            0 4px 6px -1px rgba(0,0,0,0.1),
                            inset 0 2px 4px -1px rgba(255,255,255,0.1) !important;
                        position: relative !important;
                        overflow: visible !important;
                        border: 1px solid rgba(255,255,255,0.2) !important;
                    `;
                    
                    // 增强进度条背景
                    progressBar.style.cssText += `
                        height: 12px !important;
                        background: rgba(0,0,0,0.05) !important;
                        border-radius: 8px !important;
                        position: relative !important;
                        overflow: hidden !important;
                    `;
                    
                    // 增强进度填充样式 - 三色霓虹渐变
                    progressFill.style.cssText += `
                        height: 12px !important;
                        background: linear-gradient(
                            90deg,
                            rgba(0,212,255,1) 0%,
                            rgba(9,9,121,1) 35%,
                            rgba(255,0,212,1) 100%
                        ) !important;
                        border-radius: 8px !important;
                        position: relative !important;
                        overflow: hidden !important;
                        box-shadow: 
                            0 0 25px rgba(0, 212, 255, 0.9),
                            0 0 50px rgba(255, 0, 212, 0.7),
                            inset 0 2px 4px rgba(255, 255, 255, 0.3) !important;
                    `;
                    
                    // 设置百分比显示样式
                    percentageEl.style.cssText = `
                        position: absolute !important;
                        right: 10px !important;
                        top: 50% !important;
                        transform: translateY(-50%) !important;
                        color: white !important;
                        font-weight: bold !important;
                        font-size: 10px !important;
                        text-shadow: 0 2px 4px rgba(0,0,0,0.5) !important;
                        z-index: 10 !important;
                        pointer-events: none !important;
                    `;
                    
                    // 将百分比元素添加到容器
                    progressContainer.appendChild(percentageEl);
                    
                    // 添加高级动态效果样式
                    const style = document.createElement('style');
                    style.textContent = `
                        /* 流动光效 */
                        .reading-progress-fill::after {
                            content: '' !important;
                            position: absolute !important;
                            top: 0 !important;
                            left: 0 !important;
                            right: 0 !important;
                            bottom: 0 !important;
                            background: linear-gradient(
                                90deg,
                                transparent 0%,
                                rgba(255,255,255,0.4) 50%,
                                transparent 100%
                            ) !important;
                            animation: shine 2s infinite !important;
                            border-radius: 8px !important;
                        }
                        
                        @keyframes shine {
                            0% { transform: translateX(-100%) !important; }
                            100% { transform: translateX(200%) !important; }
                        }
                        
                        /* 智能呼吸效果 */
                        .reading-progress-fill {
                            animation: breath 3s ease-in-out infinite, progressGlow 2s ease-in-out infinite alternate !important;
                        }
                        
                        @keyframes breath {
                            0% { transform: scaleX(1) !important; opacity: 0.8 !important; }
                            50% { transform: scaleX(1.02) !important; opacity: 1 !important; }
                            100% { transform: scaleX(1) !important; opacity: 0.8 !important; }
                        }
                        
                        @keyframes progressGlow {
                            0% {
                                filter: brightness(1) saturate(1.2) !important;
                                box-shadow: 
                                    0 0 25px rgba(0, 212, 255, 0.9),
                                    0 0 50px rgba(255, 0, 212, 0.7),
                                    inset 0 2px 4px rgba(255, 255, 255, 0.3) !important;
                            }
                            100% {
                                filter: brightness(1.4) saturate(1.6) !important;
                                box-shadow: 
                                    0 0 35px rgba(0, 212, 255, 1),
                                    0 0 60px rgba(255, 0, 212, 0.9),
                                    0 0 80px rgba(9, 9, 121, 0.5),
                                    inset 0 2px 6px rgba(255, 255, 255, 0.5) !important;
                            }
                        }
                        
                        /* 容器增强效果 */
                        .reading-progress-bar-container {
                            backdrop-filter: blur(16px) !important;
                            border-bottom: 1px solid rgba(0, 212, 255, 0.4) !important;
                            transition: all 0.3s ease !important;
                        }
                        
                        .reading-progress-bar-container:hover {
                            box-shadow:
                                0 6px 8px -1px rgba(0,0,0,0.15),
                                inset 0 3px 6px -1px rgba(255,255,255,0.15) !important;
                        }
                        
                        /* 百分比动态颜色 */
                        .progress-percentage {
                            transition: color 0.3s ease !important;
                        }
                        
                        /* 响应式优化 */
                        @media (max-width: 768px) {
                            .reading-progress-bar-container {
                                height: 16px !important;
                                border-radius: 12px !important;
                            }
                            .reading-progress-bar,
                            .reading-progress-fill {
                                height: 16px !important;
                                border-radius: 12px !important;
                            }
                            .progress-percentage {
                                font-size: 12px !important;
                                right: 8px !important;
                            }
                            .reading-progress-fill::after {
                                animation-duration: 1.5s !important;
                            }
                        }
                        
                        /* 高性能优化 */
                        .reading-progress-fill,
                        .reading-progress-fill::after {
                            will-change: transform, opacity, filter !important;
                        }
                    `;
                    document.head.appendChild(style);
                    
                    // 监听滚动事件，更新百分比显示和颜色
                    let lastProgress = 0;
                    const updateProgress = () => {
                        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                        const documentHeight = document.documentElement.scrollHeight - window.innerHeight;
                        const progress = Math.min(100, Math.max(0, (scrollTop / documentHeight) * 100));
                        
                        if (Math.abs(progress - lastProgress) > 0.5) { // 避免频繁更新
                            percentageEl.textContent = `${Math.round(progress)}%`;
                            // 动态颜色变化
                            const hue = progress * 1.2; // 0-120度色相变化
                            percentageEl.style.color = `hsl(${hue}, 80%, 90%)`;
                            lastProgress = progress;
                        }
                    };
                    
                    // 使用requestAnimationFrame优化性能
                    let ticking = false;
                    const scrollHandler = () => {
                        if (!ticking) {
                            requestAnimationFrame(() => {
                                updateProgress();
                                ticking = false;
                            });
                            ticking = true;
                        }
                    };
                    
                    window.addEventListener('scroll', scrollHandler, { passive: true });
                    
                    console.log('进度条视觉效果升级完成 - 立体玻璃质感 + 动态百分比');
                } else {
                    console.warn('未找到进度条元素，稍后重试...');
                    // 如果元素还没创建，稍后重试
                    setTimeout(enhanceProgressBarVisibility, 1000);
                }
            }, 1000);
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900&display=swap');
        
        /* 现代清爽的配色方案 */
        :root {
            --primary-bg: #ffffff;
            --secondary-bg: #f8f9fa;
            --accent: #4f46e5;
            --accent-light: #6366f1;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --border-light: #e5e7eb;
            --shadow-light: rgba(0, 0, 0, 0.05);
            --shadow-medium: rgba(0, 0, 0, 0.1);
            --backdrop: rgba(0, 0, 0, 0.4);
            --sidebar-bg: #f1f5f9;
            --hover-bg: #f8fafc;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        html, body {
            min-height: 100vh;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: var(--text-primary);
            line-height: 1.6;
            font-weight: 400;
            overflow-x: hidden;
        }

        /* 现代导航栏样式 */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(to bottom, rgba(43, 16, 85, 0.98) 0%, rgba(43, 16, 85, 0.9) 100%);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 32px;
            transition: background 0.3s ease;
            z-index: 10000;
        }

        .logo-container {
            position: relative;
            display: inline-block;
            align-items: center;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: #fff;
            font-weight: 800;
            font-size: 1.6em;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .nav-brand img {
            height: 30px;
            width: 30px;
            border-radius: 8px;
            margin-right: 10px;
        }

        .nav-subtitle {
            color: #fff;
            font-size: 0.6em;
            font-weight: 400;
            line-height: 1.2;
            margin-top: 2px;
        }

        .team-link {
            font-size: 0.6em;
            color: rgba(255, 255, 255, 0.8);
            display: block;
            margin-top: 5px;
            letter-spacing: 1px;
            text-decoration: underline;
            transition: color 0.3s ease;
        }

        .team-link:hover {
            color: #fff;
        }

        .nav-menu {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: auto;
            list-style: none;
        }

        .nav-menu li {
            list-style: none;
        }

        .nav-menu a {
            text-decoration: none;
            color: #fff;
            font-weight: 500;
            font-size: 14px;
            padding: 6px 15px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .nav-menu a:hover,
        .nav-menu a.active {
            background: rgba(255, 255, 255, 0.9);
            color: #2b1055;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        /* 移动端菜单按钮 */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5em;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .mobile-menu-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        /* 快速笔记按钮文本控制 */
        .notes-text {
            display: none;
        }

        /* 移动端菜单显示时的快速笔记按钮 */
        .nav-menu.active .notes-trigger {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 12px 16px;
        }

        .nav-menu.active .notes-trigger i {
            margin-right: 8px;
        }

        .nav-menu.active .notes-text {
            display: inline;
        }

        /* 桌面端隐藏文本，移动端显示 */
        @media (max-width: 768px) {
            .nav-menu .notes-text {
                display: inline;
            }
        }

        /* 智能阅读进度条 */
        .reading-progress-container {
            position: fixed;
            top: 64px;
            left: 280px;
            right: 0;
            height: 6px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            z-index: 999;
            display: flex;
            align-items: center;
            padding: 0 16px;
            transition: all 0.3s ease;
        }

        .progress-track {
            flex: 1;
            height: 4px;
            background: rgba(0, 0, 0, 0.08);
            border-radius: 2px;
            position: relative;
            margin-right: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .progress-track:hover {
            height: 6px;
            background: rgba(0, 0, 0, 0.12);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--accent-light) 100%);
            border-radius: 2px;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 8px;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 0 2px 2px 0;
            animation: progressShine 2s ease-in-out infinite;
        }

        @keyframes progressShine {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        .progress-milestones {
            position: absolute;
            top: -2px;
            left: 0;
            right: 0;
            height: 8px;
            pointer-events: none;
        }

        .milestone {
            position: absolute;
            width: 2px;
            height: 8px;
            background: rgba(79, 70, 229, 0.4);
            border-radius: 1px;
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.2s ease;
        }

        .milestone:hover {
            background: var(--accent);
            width: 3px;
            height: 10px;
            top: -3px;
        }

        .milestone::after {
            content: attr(data-label);
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .milestone:hover::after {
            opacity: 1;
            visibility: visible;
        }

        .progress-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .progress-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.2);
        }

        .progress-btn:hover {
            background: var(--accent-light);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .progress-btn:active {
            transform: translateY(0);
        }

        .progress-percentage {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent);
            min-width: 35px;
            text-align: center;
        }

        /* 现代质感侧边栏 */
        .sidebar {
            position: fixed;
            top: 80px;
            left: 0;
            width: 280px;
            height: calc(100vh - 80px);
            background: linear-gradient(180deg, rgba(43, 16, 85, 0.95) 0%, rgba(43, 16, 85, 0.9) 100%);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            z-index: 100;
            overflow-y: auto;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 导航搜索容器 */
        .nav-search-container {
            padding: 20px 16px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-search-box {
            position: relative;
            margin-bottom: 12px;
        }

        .nav-search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        .nav-search-box input {
            width: 100%;
            padding: 10px 40px 10px 36px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            font-size: 13px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.2s ease;
        }

        .nav-search-box input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .nav-search-box input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.15);
        }

        .search-clear {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }

        .search-clear.visible {
            opacity: 1;
            visibility: visible;
        }

        .search-clear:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .nav-controls {
            display: flex;
            gap: 6px;
        }

        .nav-control-btn {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .nav-control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .nav-control-btn i {
            font-size: 10px;
        }

        .sidebar-nav {
            padding: 16px 0 20px;
            list-style: none;
        }

        .sidebar-nav li {
            margin-bottom: 2px;
            padding: 0 16px;
        }

        .sidebar-nav li.nav-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 16px 20px;
            padding: 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            text-decoration: none;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            font-size: 14px;
            border-radius: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            outline: none;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #ffffff 0%, rgba(255, 255, 255, 0.8) 100%);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 10px 0 0 10px;
        }

        .nav-item:hover,
        .nav-item:focus {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .nav-item:hover::before,
        .nav-item:focus::before {
            width: 3px;
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 12px rgba(255, 255, 255, 0.1);
        }

        .nav-item.active::before {
            width: 3px;
        }

        /* 移除current-reading样式，避免与active样式冲突 */
        /* .nav-item.current-reading {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            box-shadow: 0 3px 16px rgba(255, 255, 255, 0.15);
        }

        .nav-item.current-reading::before {
            width: 4px;
        } */

        /* 重新设计的Back to Search按钮 - 光环描边效果 */
        .nav-item.back-link {
            color: #00D4FF;
            margin-top: 16px;
            padding: 12px 16px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(0, 212, 255, 0.05));
            border: 1px solid rgba(0, 212, 255, 0.3);
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 
                0 0 0 0 rgba(0, 212, 255, 0.4),
                0 2px 8px rgba(0, 212, 255, 0.2);
        }

        .nav-item.back-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 212, 255, 0.1));
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 12px;
        }

        .nav-item.back-link::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #00D4FF, #FF006E, #00D4FF);
            background-size: 200% 200%;
            border-radius: 14px;
            z-index: -1;
            opacity: 0;
            animation: none;
            transition: opacity 0.3s ease;
        }

        .nav-item.back-link:hover {
            color: white;
            transform: translateY(-2px) scale(1.02);
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.3), rgba(0, 212, 255, 0.15));
            border-color: rgba(0, 212, 255, 0.6);
            box-shadow: 
                0 0 0 4px rgba(0, 212, 255, 0.3),
                0 8px 25px rgba(0, 212, 255, 0.4),
                0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .nav-item.back-link:hover::before {
            opacity: 1;
        }

        .nav-item.back-link:hover::after {
            opacity: 1;
            animation: borderGlow 2s ease-in-out infinite;
        }

        .nav-item.back-link:active {
            transform: translateY(0) scale(0.98);
            transition: all 0.1s ease;
        }

        /* 焦点状态样式 */
        .nav-item.back-link:focus {
            outline: none;
            box-shadow: 
                0 0 0 3px rgba(0, 212, 255, 0.5),
                0 0 0 6px rgba(0, 212, 255, 0.3),
                0 0 0 9px rgba(0, 212, 255, 0.1);
        }

        /* 键盘导航时的特殊效果 */
        .nav-item.back-link:focus-visible {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.4), rgba(0, 212, 255, 0.2));
            border-color: rgba(0, 212, 255, 0.8);
            color: white;
        }

        /* 光环动画效果 */
        @keyframes borderGlow {
            0%, 100% {
                background-position: 0% 50%;
                opacity: 0.8;
            }
            50% {
                background-position: 100% 50%;
                opacity: 1;
            }
        }

        /* 呼吸效果 */
        @keyframes breath {
            0%, 100% {
                box-shadow: 
                    0 0 0 0 rgba(0, 212, 255, 0.4),
                    0 2px 8px rgba(0, 212, 255, 0.2);
            }
            50% {
                box-shadow: 
                    0 0 0 2px rgba(0, 212, 255, 0.6),
                    0 4px 12px rgba(0, 212, 255, 0.3);
            }
        }

        .nav-item.back-link {
            animation: breath 3s ease-in-out infinite;
        }

        /* 添加脉冲效果增强可见性 */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
            }
        }

        /* 在hover时暂停呼吸动画，启动脉冲动画 */
        .nav-item.back-link:hover {
            animation: none;
        }

        .nav-item.back-link:hover::after {
            animation: borderGlow 2s ease-in-out infinite, pulse 1s ease-in-out infinite;
        }

        /* 图标特殊效果 */
        .nav-item.back-link .icon {
            color: #00D4FF;
            transition: all 0.3s ease;
        }

        .nav-item.back-link:hover .icon {
            color: white;
            transform: translateX(-3px) scale(1.1);
        }

        /* 文字特殊效果 */
        .nav-item.back-link .text {
            color: inherit;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .nav-item.back-link:hover .text {
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        /* 点击状态样式 */
        .nav-item.back-link.clicking {
            animation: clickEffect 0.3s ease-out;
        }

        @keyframes clickEffect {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(0.95);
            }
            100% {
                transform: scale(1);
            }
        }

        /* 加载状态样式 */
        .nav-item.back-link.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .nav-item.back-link.loading .icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 工具提示样式 */
        .nav-item.back-link {
            position: relative;
        }

        .nav-item.back-link .tooltip-text {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 120%;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }

        .nav-item.back-link .tooltip-text::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }

        .nav-item.back-link:hover .tooltip-text {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-5px);
        }

        .nav-item.filtered-out {
            display: none;
        }

        .nav-item .icon {
            font-size: 16px;
            width: 18px;
            text-align: center;
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }

        .nav-item:hover .icon,
        .nav-item:focus .icon {
            transform: scale(1.1);
        }

        .nav-item .text {
            font-weight: inherit;
            letter-spacing: 0.01em;
            flex: 1;
        }

        .section-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: transparent;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .nav-item.has-new-data .section-indicator {
            background: #ef4444;
            animation: pulse 2s infinite;
        }

        .nav-item.high-priority .section-indicator {
            background: #f59e0b;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* 快捷键提示 */
        .keyboard-shortcuts {
            position: absolute;
            bottom: 16px;
            left: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .shortcuts-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.9);
        }

        .shortcut-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .shortcut-item:last-child {
            margin-bottom: 0;
        }

        .shortcut-item kbd {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 10px;
            margin-right: 8px;
            min-width: 20px;
            text-align: center;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            color: white;
        }

        /* 增强的里程碑样式 */
        .milestone.passed {
            background: var(--accent);
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
        }

        .milestone.current {
            background: var(--accent-light);
            width: 4px;
            height: 12px;
            top: -4px;
            box-shadow: 0 3px 8px rgba(79, 70, 229, 0.4);
        }

        /* 搜索高亮 */
        .nav-item.search-highlight {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        /* 无搜索结果提示 */
        .no-search-results {
            padding: 20px 16px;
            text-align: center;
            color: var(--text-muted);
            font-style: italic;
            font-size: 13px;
        }

        /* 加载状态优化 */
        .nav-item.loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* 平滑过渡 */
        .sidebar-nav li {
            transition: all 0.3s ease;
        }

        .sidebar-nav li.filtered-out {
            opacity: 0;
            transform: translateX(-10px);
            max-height: 0;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        /* 主内容区域 */
        .main-content {
            margin-left: 280px;
            margin-top: 80px; /* 为页眉留出空间 */
            padding: 32px;
            min-height: calc(100vh - 80px);
            transition: margin-left 0.3s ease;
        }

        .content-wrapper {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* 现代语言选择器 */
        .language-selector {
            position: fixed;
            right: 20px;
            top: 90px; /* 稍微下移以避开header */
            z-index: 10000;
        }

        .language-current {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            background: rgba(43, 16, 85, 0.95);
            border-radius: 50px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            overflow: hidden;
        }

        .language-current i {
            font-size: 18px;
            color: white;
            margin-right: 0;
            transition: margin 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .language-current span {
            max-width: 0;
            opacity: 0;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .language-selector:hover .language-current {
            padding-right: 15px;
            border-radius: 10px;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .language-selector:hover .language-current i {
            margin-right: 8px;
        }

        .language-selector:hover .language-current span {
            max-width: 120px;
            opacity: 1;
            padding-left: 5px;
        }

        .language-options {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(43, 16, 85, 0.95);
            border-radius: 10px;
            border-top-right-radius: 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            width: 180px;
            max-height: 350px;
            overflow-y: auto;
            transform: translateY(-10px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .language-selector:hover .language-options {
            display: block;
            transform: translateY(0);
            opacity: 1;
            animation: fadeDown 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }

        @keyframes fadeDown {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .language-options a {
            display: block;
            padding: 10px 15px;
            color: white;
            text-decoration: none;
            transition: background 0.2s ease;
            border-radius: 5px;
            margin: 5px;
        }

        .language-options a:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .language-options a:last-child {
            margin-bottom: 10px;
        }

        .language-options a:first-child {
            margin-top: 10px;
        }

        .language-options::-webkit-scrollbar {
            width: 5px;
        }

        .language-options::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .language-options::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
        }

        /* 页面标题 */
        .page-title {
            color: var(--text-primary);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-light);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .top-nav {
                padding: 12px 16px;
            }

            .mobile-menu-btn {
                display: block;
            }

            .nav-menu {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                background: rgba(43, 16, 85, 0.95);
                backdrop-filter: blur(20px);
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                flex-direction: column;
                align-items: center;
                padding: 16px 0;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            }

            .nav-menu.active {
                display: flex;
            }

            .nav-menu li {
                margin: 8px 0;
            }

            .nav-subtitle {
                display: none;
            }

            .logo-container .nav-subtitle {
                display: none;
            }

            /* 移动端阅读进度条 */
            .reading-progress-container {
                left: 0;
                height: 4px;
                padding: 0 12px;
            }

            .progress-track {
                margin-right: 8px;
            }

            .progress-btn {
                width: 24px;
                height: 24px;
                font-size: 10px;
            }

            .progress-percentage {
                font-size: 11px;
                min-width: 30px;
            }

            .milestone {
                width: 1px;
                height: 6px;
            }

            .milestone:hover {
                width: 2px;
                height: 8px;
                top: -2px;
            }

            .milestone::after {
                font-size: 10px;
                padding: 2px 6px;
                bottom: 10px;
            }

            /* 移动端侧边栏 */
            .sidebar {
                transform: translateX(-100%);
                width: 100%;
                max-width: 320px;
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(20px);
                z-index: 1;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            /* 移动端导航搜索 */
            .nav-search-container {
                padding: 16px 12px 12px;
            }

            .nav-search-box input {
                padding: 8px 32px 8px 32px;
                font-size: 14px;
            }

            .nav-control-btn {
                padding: 8px 10px;
                font-size: 12px;
            }

                    /* 移动端导航项 */
        .sidebar-nav {
            padding: 12px 0 120px; /* 为快捷键提示和Back to Search按钮留出空间 */
        }

        .sidebar-nav li {
            padding: 0 12px;
        }

        .nav-item {
            padding: 14px 16px;
            font-size: 15px;
        }

        .nav-item .icon {
            font-size: 18px;
            width: 20px;
        }

        /* 移动端Back to Search按钮优化 */
        .nav-item.back-link {
            margin-top: 20px;
            padding: 16px 20px;
            font-size: 16px;
        }

        .nav-item.back-link .icon {
            font-size: 20px;
            width: 24px;
        }

        .nav-item.back-link .text {
            font-size: 16px;
            font-weight: 700;
        }

            /* 移动端Back to Search按钮优化 */
            .nav-item.back-link {
                margin: 16px 8px 8px 8px;
                padding: 14px 16px;
                border-radius: 10px;
            }

            .nav-item.back-link:hover {
                transform: translateY(-1px) scale(1.01);
            }

            .nav-item.back-link .icon {
                font-size: 16px;
            }

            /* 移动端快捷键提示 */
            .keyboard-shortcuts {
                bottom: 12px;
                left: 12px;
                right: 12px;
                padding: 10px;
            }

            .shortcut-item {
                flex-wrap: wrap;
                margin-bottom: 6px;
            }

            .shortcut-item kbd {
                font-size: 11px;
                padding: 3px 8px;
                margin-right: 6px;
                margin-bottom: 2px;
            }

            /* 移动端主内容 */
            .main-content {
                margin-left: 0;
                padding: 16px;
                margin-top: 68px; /* 为移动端进度条留出空间 */
            }

            .language-selector {
                top: 90px;
                right: 16px;
            }

            .page-title {
                font-size: 24px;
                margin-bottom: 24px;
            }

            /* 移动端覆盖层增强 */
            .mobile-overlay.show {
                backdrop-filter: blur(4px);
            }

            .module {
                padding: 20px 16px;
                margin-bottom: 20px;
                border-radius: 12px;
            }

            .module-title {
                font-size: 18px;
                margin-bottom: 16px;
                padding-bottom: 12px;
            }

            .info-table {
                border-radius: 6px;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            .info-table th,
            .info-table td {
                padding: 10px 12px;
                font-size: 13px;
                min-width: 120px;
            }

            .info-table th {
                width: 140px;
                font-size: 12px;
            }

                        /* 移动端简化布局 - 只显示内容值 */
            @media (max-width: 768px) {
                .info-table {
                    border: none;
                    background: transparent;
                    box-shadow: none;
                }

                .info-table,
                .info-table tbody {
                    display: block;
                    width: 100%;
                }

                .info-table tr {
                    display: block;
                    background: #ffffff;
                    border: 1px solid rgba(0, 0, 0, 0.08);
                    border-radius: 8px;
                    margin-bottom: 12px;
                    padding: 16px;
                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
                    transition: box-shadow 0.2s ease;
                }

                .info-table tr:hover {
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                }

                .info-table th {
                    display: none;
                }

                .info-table td {
                    display: block;
                    width: 100%;
                    border: none;
                    padding: 0;
                    text-align: left;
                    min-height: auto;
                    word-wrap: break-word;
                    overflow-wrap: break-word;
                    font-size: 14px;
                    line-height: 1.6;
                    color: var(--text-primary);
                }

                .info-table td:before {
                    display: none;
                }

                     /* 移动端滚动内容优化 */
                     .scrollable-content {
                         max-height: 250px;
                         padding: 16px;
                         border-radius: 8px;
                     }

                     .organism-item {
                         padding: 10px 12px;
                         margin-bottom: 6px;
                         border-radius: 6px;
                     }

                     .organism-name {
                         font-size: 13px;
                     }

                     .organism-susceptibility {
                         font-size: 11px;
                         padding: 3px 6px;
                         min-width: 50px;
                     }

                     /* 活性标签移动端优化 */
                     .activity-tag {
                         padding: 6px 10px;
                         font-size: 11px;
                         margin: 2px 3px 2px 0;
                         display: inline-block;
                         max-width: 100%;
                         white-space: nowrap;
                         overflow: hidden;
                         text-overflow: ellipsis;
                     }

                     /* 序列显示移动端优化 */
                     .sequence {
                         padding: 12px 14px;
                         font-size: 12px;
                         letter-spacing: 1px;
                         border-radius: 8px;
                     }

                     /* 文献条目移动端优化 */
                     .literature-item {
                         padding: 16px;
                         margin-bottom: 16px;
                         border-radius: 12px;
                     }

                     .literature-buttons {
                         flex-direction: column;
                         gap: 8px;
                     }

                     .literature-link {
                         width: 100%;
                         justify-content: center;
                         padding: 10px 16px;
                     }
                 }

                 /* 超小屏幕额外优化 */
                 @media (max-width: 360px) {
                     .info-table tr {
                         padding: 12px;
                         margin-bottom: 10px;
                     }

                     .module {
                         padding: 16px 12px;
                     }

                     .module-title {
                         font-size: 16px;
                     }
                 }
             }

        /* 移动端覆盖层 */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--backdrop);
            z-index: 99;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .mobile-overlay.show {
            display: block;
            opacity: 1;
        }

        /* 现代全局滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.04);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.6) 0%, rgba(99, 102, 241, 0.7) 100%);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
        }

        /* 简约模块样式 */
        .module {
            background: #ffffff;
            border-radius: 12px;
            padding: 28px;
            margin-bottom: 24px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
            transition: box-shadow 0.2s ease;
        }

        .module:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .module-title {
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }

        .info-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 8px;
            overflow: hidden;
            background: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .info-table td,
        .info-table th {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .info-table th {
            font-weight: 600;
            color: var(--text-primary);
            background: #f8fafc;
            width: 180px;
            font-size: 13px;
            border-right: 1px solid rgba(0, 0, 0, 0.08);
        }

        .info-table th:first-child {
            border-top-left-radius: 8px;
        }

        .info-table th:last-child {
            border-top-right-radius: 8px;
            border-right: none;
        }

        .info-table tbody tr {
            transition: background-color 0.15s ease;
        }

        .info-table tbody tr:hover {
            background: #f8fafc;
        }

        .info-table tbody tr:last-child td {
            border-bottom: none;
        }

        .info-table tbody tr:last-child td:first-child {
            border-bottom-left-radius: 8px;
        }

        .info-table tbody tr:last-child td:last-child {
            border-bottom-right-radius: 8px;
        }

        .info-table td {
            color: var(--text-primary);
            font-weight: 400;
            font-size: 14px;
            line-height: 1.5;
        }

        /* 错误和加载状态 */
        .error-message {
            color: #ef4444;
            font-size: 18px;
            text-align: center;
            margin: 100px auto;
            padding: 20px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 60vh;
            text-align: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-light);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        .loading-text {
            color: var(--text-muted);
            font-size: 14px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }





        /* 现代活性标签 */
        .activity-tag {
            display: inline-block;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin: 4px 6px 4px 0;
            box-shadow: 
                0 2px 4px rgba(79, 70, 229, 0.2),
                0 1px 2px rgba(0, 0, 0, 0.1);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.02em;
        }

        .activity-tag:hover {
            transform: translateY(-1px);
            box-shadow: 
                0 4px 8px rgba(79, 70, 229, 0.3),
                0 2px 4px rgba(0, 0, 0, 0.15);
        }

        /* 现代序列显示 */
        .sequence {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 16px 20px;
            border-radius: 12px;
            letter-spacing: 1.5px;
            font-size: 14px;
            line-height: 1.8;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 
                inset 0 1px 3px rgba(0, 0, 0, 0.06),
                0 1px 2px rgba(0, 0, 0, 0.04);
            overflow-x: auto;
            white-space: nowrap;
            color: #1e293b;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .sequence:hover {
            box-shadow: 
                inset 0 1px 3px rgba(0, 0, 0, 0.08),
                0 2px 8px rgba(0, 0, 0, 0.08);
        }

        /* 目标生物样式 */
        .organism-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .organism-item {
            display: flex;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 8px;
            margin-bottom: 4px;
        }
        
        .organism-item:hover {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.04) 0%, rgba(99, 102, 241, 0.06) 100%);
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        
        .organism-item:last-child {
            border-bottom: none;
        }
        
        .organism-name {
            font-weight: 500;
            flex: 1;
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.4;
        }
        
        .organism-susceptibility {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.1) 0%, rgba(99, 102, 241, 0.15) 100%);
            color: var(--accent);
            font-weight: 600;
            margin-left: 12px;
            min-width: 60px;
            text-align: center;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            border: 1px solid rgba(79, 70, 229, 0.1);
        }
        

        
        /* 现代滚动内容 */
        .scrollable-content {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 12px;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            box-shadow: 
                inset 0 1px 3px rgba(0, 0, 0, 0.04),
                0 1px 2px rgba(0, 0, 0, 0.02);
        }

        /* 现代滚动条样式 */
        .scrollable-content::-webkit-scrollbar {
            width: 8px;
        }

        .scrollable-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.04);
            border-radius: 4px;
            margin: 4px;
        }

        .scrollable-content::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--accent-light) 0%, var(--accent) 100%);
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
        }

        /* 快速笔记按钮样式 */
        .notes-trigger {
            transition: all 0.2s ease;
            position: relative;
        }

        .notes-trigger:hover {
            background: var(--hover-bg);
            color: var(--accent);
            transform: scale(1.05);
        }

        .notes-trigger:active {
            transform: scale(0.95);
        }

        /* 屏幕阅读器专用文本 */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* 快速笔记组件在card页面的特定样式 */
        .qn-container {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            z-index: 10000 !important; /* 确保在侧边栏之上 */
        }

        /* 移动端适配 - 避免与侧边栏冲突 */
        @media (max-width: 768px) {
            .qn-container {
                right: 10px !important;
                left: 10px !important;
                width: auto !important;
                max-width: calc(100vw - 20px) !important;
            }
            
            .qn-container.minimized {
                width: auto !important;
                max-width: 250px !important;
                right: 10px !important;
                left: auto !important;
            }
        }

        /* 确保快速笔记不会被侧边栏遮挡 */
        @media (min-width: 769px) {
            .qn-container {
                right: 30px !important;
                /* 避免与侧边栏重叠 */
                max-width: calc(100vw - 320px) !important;
            }
        }

        /* 相似序列样式 */
        .similar-sequences-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .similar-sequence-item {
            background: linear-gradient(145deg, #ffffff 0%, #fafbfc 100%);
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .similar-sequence-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent) 0%, var(--accent-light) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .similar-sequence-item:hover {
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.12),
                0 8px 24px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
            border-color: rgba(79, 70, 229, 0.1);
        }

        .similar-sequence-item:hover::before {
            opacity: 1;
        }

        .similar-seq-info {
            margin-bottom: 16px;
        }

        .id-similarity-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .similar-seq-id {
            font-weight: 600;
            color: var(--accent);
            font-size: 16px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        }

        .similarity-score {
            background: var(--accent);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);
        }

        .similar-sequence {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 12px 16px;
            border-radius: 8px;
            letter-spacing: 1px;
            font-size: 13px;
            line-height: 1.6;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.06);
            overflow-x: auto;
            white-space: nowrap;
            color: #1e293b;
            font-weight: 500;
        }

        .similar-seq-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 12px;
        }

        .view-similar-btn {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .view-similar-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(79, 70, 229, 0.3);
        }

        .view-similar-btn:active {
            transform: translateY(0);
        }

        .view-similar-btn i {
            font-size: 12px;
        }

        /* 移动端相似序列优化 */
        @media (max-width: 768px) {
            .similar-sequence-item {
                padding: 16px;
            }

            .id-similarity-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .similar-sequence {
                font-size: 12px;
                padding: 10px 12px;
                letter-spacing: 0.5px;
            }

            .view-similar-btn {
                width: 100%;
                justify-content: center;
                padding: 10px 16px;
            }
        }

        /* 现代文献样式 */
        .literature-item {
            margin-bottom: 20px;
            padding: 24px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 16px;
            background: linear-gradient(145deg, #ffffff 0%, #fafbfc 100%);
            box-shadow: 
                0 1px 3px rgba(0, 0, 0, 0.06),
                0 2px 6px rgba(0, 0, 0, 0.04);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .literature-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent) 0%, var(--accent-light) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .literature-item:hover {
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.12),
                0 8px 24px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
            border-color: rgba(79, 70, 229, 0.1);
        }

        .literature-item:hover::before {
            opacity: 1;
        }

        .literature-item:last-child {
            margin-bottom: 0;
        }

        .literature-number {
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .literature-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            line-height: 1.4;
        }

        .literature-author {
            margin-bottom: 8px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .literature-reference {
            font-style: italic;
            margin-bottom: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .literature-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .literature-link {
            color: white;
            text-decoration: none;
            font-weight: 600;
            border-radius: 8px;
            padding: 8px 16px;
            display: inline-flex;
            align-items: center;
            font-size: 13px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            letter-spacing: 0.01em;
        }
        
        .literature-link:hover {
            text-decoration: none;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* 3D结构查看器 */
        .structure-viewer {
            width: 100%;
            height: 300px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            margin: 12px 0;
            background: var(--secondary-bg);
        }
        
        .structure-link {
            display: inline-block;
            margin: 8px 0;
            padding: 8px 16px;
            background: var(--accent);
            color: white;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .structure-link:hover {
            background: var(--accent-light);
        }
        
        .no-structure {
            padding: 24px;
            text-align: center;
            color: var(--text-muted);
            font-style: italic;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            border: 1px dashed rgba(0, 0, 0, 0.1);
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- 采用search页面风格的导航栏 -->
    <nav class="top-nav">
        <div class="logo-container">
            <a href="#" class="nav-brand">
                <img src="./source/img/logo.png" alt="SPADE Logo">
                SPADE
            </a>
            <div class="nav-subtitle">System for Antimicrobial Peptide<br>Management and Database</div>
            <!-- <a href="https://2025.igem.wiki/xjtlu - software" class="team-link" target="_blank" rel="noopener noreferrer">Belongs to 2025-XJTLU-Software</a> -->
        </div>
        
        <button class="mobile-menu-btn" id="mobile-menu-btn">
            <i class="fas fa-bars"></i>
        </button>
        
        <ul class="nav-menu">
            <li><a href="home.html">Home</a></li>
            <li><a href="search.html">Search</a></li>
            <li><a href="tools.html">Tools</a></li>
            <li><a href="statistics.html">Statistics</a></li>
            <li><a href="#" id="quick-notes-btn" title="Quick Notes" class="notes-trigger">
                <i class="fas fa-sticky-note"></i>
                <span class="notes-text">Notes</span>
            </a></li>
        </ul>
    </nav>

    <!-- 语言选择器 -->
    <!-- <div class="language-selector">
        <div class="language-current" id="currentLang">
            <i class="fas fa-globe"></i>
            <span id="currentLangText">English</span>
        </div>
        <div class="language-options">
            <a href="#" data-lang="en" class="no-translate">English</a>
            <a href="#" data-lang="zh-Hans" class="no-translate">中文</a>
        </div>
    </div> -->



    <!-- 智能导航栏 -->
    <aside class="sidebar" id="sidebar">
        <!-- 导航搜索框 -->
        <div class="nav-search-container">
            <div class="nav-search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="nav-search" placeholder="Search sections..." aria-label="Search navigation sections">
                <button class="search-clear" id="search-clear" title="Clear search" aria-label="Clear search">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="nav-controls">
                <button class="nav-control-btn" id="collapse-all" title="Collapse All" aria-label="Collapse all sections">
                    <i class="fas fa-compress-alt"></i>
                </button>
                <button class="nav-control-btn" id="expand-all" title="Expand All" aria-label="Expand all sections">
                    <i class="fas fa-expand-alt"></i>
                </button>
            </div>
        </div>

        <ul class="sidebar-nav" role="navigation" aria-label="Page sections">
            <li>
                <a href="#general" class="nav-item active" data-section="general" role="menuitem" tabindex="0" aria-describedby="general-desc">
                    <span class="icon"><i class="fas fa-info-circle"></i></span>
                    <span class="text">General Information</span>
                    <span class="section-indicator" aria-hidden="true"></span>
                    <span id="general-desc" class="sr-only">Basic peptide information including ID, name, and sequence</span>
                </a>
            </li>
            <li>
                <a href="#activity" class="nav-item" data-section="activity" role="menuitem" tabindex="-1" aria-describedby="activity-desc">
                    <span class="icon"><i class="fas fa-flask"></i></span>
                    <span class="text">Activity Information</span>
                    <span class="section-indicator" aria-hidden="true"></span>
                    <span id="activity-desc" class="sr-only">Biological activity and target organism data</span>
                </a>
            </li>
            <li>
                <a href="#structure" class="nav-item" data-section="structure" role="menuitem" tabindex="-1" aria-describedby="structure-desc">
                    <span class="icon"><i class="fas fa-dna"></i></span>
                    <span class="text">Structural Information</span>
                    <span class="section-indicator" aria-hidden="true"></span>
                    <span id="structure-desc" class="sr-only">3D structure and modification details</span>
                </a>
            </li>
            <li>
                <a href="#properties" class="nav-item" data-section="properties" role="menuitem" tabindex="-1" aria-describedby="properties-desc">
                    <span class="icon"><i class="fas fa-atom"></i></span>
                    <span class="text">Physicochemical Properties</span>
                    <span class="section-indicator" aria-hidden="true"></span>
                    <span id="properties-desc" class="sr-only">Chemical and physical property calculations</span>
                </a>
            </li>
            <li>
                <a href="#comments" class="nav-item" data-section="comments" role="menuitem" tabindex="-1" aria-describedby="comments-desc">
                    <span class="icon"><i class="fas fa-comment"></i></span>
                    <span class="text">Comments Information</span>
                    <span class="section-indicator" aria-hidden="true"></span>
                    <span id="comments-desc" class="sr-only">Additional notes and functional descriptions</span>
                </a>
            </li>
            <li>
                <a href="#similar" class="nav-item" data-section="similar" role="menuitem" tabindex="-1" aria-describedby="similar-desc">
                    <span class="icon"><i class="fas fa-search-plus"></i></span>
                    <span class="text">Similar Sequences</span>
                    <span class="section-indicator" aria-hidden="true"></span>
                    <span id="similar-desc" class="sr-only">Related peptides with sequence similarity</span>
                </a>
            </li>
            <li>
                <a href="#literature" class="nav-item" data-section="literature" role="menuitem" tabindex="-1" aria-describedby="literature-desc">
                    <span class="icon"><i class="fas fa-book"></i></span>
                    <span class="text">Literature Information</span>
                    <span class="section-indicator" aria-hidden="true"></span>
                    <span id="literature-desc" class="sr-only">Published research and reference materials</span>
                </a>
            </li>
            <li class="nav-divider" role="separator"></li>
            <li>
                <a href="search.html" class="nav-item back-link" role="menuitem" tabindex="-1" 
                   title="Back to Search" 
                   data-tooltip="Back to Search">
                    <span class="icon"><i class="fas fa-arrow-left"></i></span>
                    <span class="text">Back to Search</span>
                    <span class="tooltip-text">Back to Search</span>
                </a>
            </li>
        </ul>

        <!-- 快捷键提示 -->
        <div class="keyboard-shortcuts" id="shortcuts-hint">

    </aside>

    <!-- 移动端覆盖层 -->
    <div class="mobile-overlay" id="mobile-overlay"></div>

    <!-- 主内容区域 -->
    <main class="main-content">
        <div class="content-wrapper">
            <h1 class="page-title" id="peptide-name">Loading...</h1>
            
            <!-- 动态生成的模块容器 -->
            <div id="module-container"></div>
        </div>
    </main>

    

    <script>
        // 智能导航和阅读进度系统
        class SmartNavigationSystem {
            constructor() {
                // DOM 元素
                this.sidebar = document.getElementById('sidebar');
                this.mobileMenuBtn = document.getElementById('mobile-menu-btn');
                this.mobileOverlay = document.getElementById('mobile-overlay');
                // 进度条元素将由reading-progress.js动态创建
                this.progressContainer = null;
                this.progressBar = null;
                this.progressText = null;
                this.backToTopBtn = null;
                this.milestonesContainer = null;
                
                // 导航元素
                this.navItems = document.querySelectorAll('.nav-item[data-section]');
                this.searchInput = document.getElementById('nav-search');
                this.searchClear = document.getElementById('search-clear');
                this.collapseAllBtn = document.getElementById('collapse-all');
                this.expandAllBtn = document.getElementById('expand-all');
                
                // 状态变量
                this.sections = [];
                this.currentSection = 'general';
                this.isScrolling = false;
                this.lastScrollTime = 0;
                this.keyboardNavIndex = 0;
                this.intersectionObserver = null;
                
                // 新增：防止冲突的状态管理
                this.isProgrammaticScroll = false;
                this.scrollTimeout = null;
                
                // 初始化
                this.init();
            }

            init() {
                this.setupSections();
                this.bindEvents();
                this.initIntersectionObserver();
                this.initKeyboardNavigation();
                this.initProgressTracking();
                this.restoreState();
                
                console.log('智能导航系统初始化完成');
            }

            setupSections() {
                // 识别页面中的所有sections
                this.sections = Array.from(this.navItems).map(navItem => {
                    const sectionId = navItem.getAttribute('data-section');
                    const sectionElement = document.getElementById(sectionId);
                    
                    return {
                        id: sectionId,
                        navItem: navItem,
                        element: sectionElement,
                        label: navItem.querySelector('.text').textContent,
                        isVisible: false,
                        offset: 0
                    };
                }).filter(section => section.element);
                
                console.log('识别到的sections:', this.sections.map(s => s.id));
            }

            bindEvents() {
                // 移动端菜单
                this.mobileMenuBtn?.addEventListener('click', () => this.toggleSidebar());
                this.mobileOverlay?.addEventListener('click', () => this.closeSidebar());
                
                            // 导航点击
            this.navItems.forEach(navItem => {
                navItem.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = navItem.getAttribute('data-section');
                    if (sectionId) {
                        this.navigateToSection(sectionId);
                    } else {
                        // 外部链接
                        const href = navItem.getAttribute('href');
                        if (href && href !== '#') {
                            // 特殊处理Back to Search按钮
                            if (navItem.classList.contains('back-link')) {
                                this.handleBackToSearch(navItem, href);
                            } else {
                                window.location.href = href;
                            }
                        }
                    }
                });
            });
                
                // 搜索功能
                this.searchInput?.addEventListener('input', (e) => this.handleSearch(e.target.value));
                this.searchInput?.addEventListener('keydown', (e) => this.handleSearchKeydown(e));
                this.searchClear?.addEventListener('click', () => this.clearSearch());
                
                // 折叠/展开按钮
                this.collapseAllBtn?.addEventListener('click', () => this.collapseAll());
                this.expandAllBtn?.addEventListener('click', () => this.expandAll());
                
                // 进度条点击
                document.querySelector('.progress-track')?.addEventListener('click', (e) => this.handleProgressClick(e));
                this.backToTopBtn?.addEventListener('click', () => this.scrollToTop());
                
                // 滚动事件（节流处理）
                window.addEventListener('scroll', this.throttle(() => this.handleScroll(), 16));
                
                // 窗口大小变化
                window.addEventListener('resize', this.debounce(() => {
                    this.updateSectionOffsets();
                    if (window.innerWidth > 768) {
                        this.closeSidebar();
                    }
                }, 200));
            }

            initIntersectionObserver() {
                const options = {
                    root: null,
                    rootMargin: '-20% 0px -60% 0px', // 优化触发区域
                    threshold: [0, 0.1, 0.5, 0.9]
                };
                
                this.intersectionObserver = new IntersectionObserver((entries) => {
                    // 如果是程序化滚动，忽略IntersectionObserver的更新
                    if (this.isProgrammaticScroll) {
                        return;
                    }
                    
                    entries.forEach(entry => {
                        const sectionId = entry.target.id;
                        const section = this.sections.find(s => s.id === sectionId);
                        
                        if (section) {
                            section.isVisible = entry.isIntersecting;
                            
                            // 当section进入视口时，更新导航
                            if (entry.isIntersecting && entry.intersectionRatio > 0.1) {
                                this.updateActiveNavigation(sectionId);
                            }
                        }
                    });
                }, options);
                
                // 观察所有sections
                this.sections.forEach(section => {
                    if (section.element) {
                        this.intersectionObserver.observe(section.element);
                    }
                });
            }



            initKeyboardNavigation() {
                document.addEventListener('keydown', (e) => {
                    // 检查是否在搜索框中
                    if (document.activeElement === this.searchInput) {
                        return;
                    }
                    
                    switch(e.key) {
                        case '/':
                            e.preventDefault();
                            this.focusSearch();
                            break;
                        case 'ArrowUp':
                            if (e.target.closest('.sidebar-nav')) {
                                e.preventDefault();
                                this.navigateKeyboard(-1);
                            }
                            break;
                        case 'ArrowDown':
                            if (e.target.closest('.sidebar-nav')) {
                                e.preventDefault();
                                this.navigateKeyboard(1);
                            }
                            break;
                        case 'Enter':
                            if (e.target.closest('.nav-item')) {
                                e.preventDefault();
                                e.target.click();
                            }
                            break;
                        case 'Escape':
                            if (this.sidebar.classList.contains('open')) {
                                this.closeSidebar();
                            }
                            break;
                    }
                });
            }

            initProgressTracking() {
                // 初始化时更新一次
                setTimeout(() => {
                    this.updateSectionOffsets();
                    this.handleScroll();
                }, 500);
            }

            handleScroll() {
                if (!this.isScrolling) {
                    requestAnimationFrame(() => {
                        this.updateProgress();
                        this.isScrolling = false;
                    });
                    this.isScrolling = true;
                }
            }

            updateProgress() {
                const scrollTop = window.pageYOffset;
                const documentHeight = document.documentElement.scrollHeight - window.innerHeight;
                const progress = Math.min(100, Math.max(0, (scrollTop / documentHeight) * 100));
                
                // 进度条更新交由reading-progress.js组件处理
                // 这里只负责导航相关的逻辑
                
                // 保存阅读位置
                this.saveReadingPosition(scrollTop);
            }

            updateSectionOffsets() {
                this.sections.forEach(section => {
                    if (section.element) {
                        section.offset = section.element.offsetTop - 100; // 考虑header高度
                    }
                });
            }

            updateActiveNavigation(sectionId) {
                // 防止无效的sectionId
                if (!sectionId || this.currentSection === sectionId) return;
                
                this.currentSection = sectionId;
                
                // 更新导航项状态 - 只使用一个高亮类
                this.navItems.forEach(navItem => {
                    navItem.classList.remove('active', 'current-reading');
                    navItem.removeAttribute('aria-current');
                    
                    if (navItem.getAttribute('data-section') === sectionId) {
                        navItem.classList.add('active');
                        navItem.setAttribute('aria-current', 'true');
                        
                        // 无障碍支持：更新屏幕阅读器
                        this.announceCurrentSection(navItem.querySelector('.text').textContent);
                    }
                });
                
                // 保存当前section
                this.saveState();
                
                // 调试信息（可选）
                // console.log(`导航状态更新: ${sectionId}, 程序化滚动: ${this.isProgrammaticScroll}`);
            }

            navigateToSection(sectionId) {
                const section = this.sections.find(s => s.id === sectionId);
                if (!section || !section.element) return;
                
                // 设置程序化滚动标志
                this.isProgrammaticScroll = true;
                
                // 立即更新导航状态，避免冲突
                this.updateActiveNavigation(sectionId);
                
                const targetY = section.element.offsetTop - 80; // 留出空间给header和进度条
                
                // 平滑滚动
                this.smoothScrollTo(targetY);
                
                // 移动端关闭侧边栏
                if (window.innerWidth <= 768) {
                    setTimeout(() => this.closeSidebar(), 300);
                }
                
                // 滚动完成后恢复IntersectionObserver
                if (this.scrollTimeout) {
                    clearTimeout(this.scrollTimeout);
                }
                this.scrollTimeout = setTimeout(() => {
                    this.isProgrammaticScroll = false;
                }, 1000); // 给滚动动画足够的时间完成
            }

            smoothScrollTo(targetY) {
                const startY = window.pageYOffset;
                const distance = targetY - startY;
                const duration = Math.min(800, Math.abs(distance) * 0.5); // 动态调整持续时间
                let startTime = null;
                
                const animation = (currentTime) => {
                    if (startTime === null) startTime = currentTime;
                    const timeElapsed = currentTime - startTime;
                    const progress = Math.min(timeElapsed / duration, 1);
                    
                    // 使用easeInOutCubic缓动函数
                    const easedProgress = progress < 0.5 
                        ? 4 * progress * progress * progress 
                        : (progress - 1) * (2 * progress - 2) * (2 * progress - 2) + 1;
                    
                    window.scrollTo(0, startY + distance * easedProgress);
                    
                    if (progress < 1) {
                        requestAnimationFrame(animation);
                    } else {
                        // 滚动完成后的回调
                        setTimeout(() => {
                            this.isProgrammaticScroll = false;
                        }, 100);
                    }
                };
                
                requestAnimationFrame(animation);
            }

            handleSearch(query) {
                const trimmedQuery = query.trim().toLowerCase();
                
                // 显示/隐藏清除按钮
                if (this.searchClear) {
                    if (trimmedQuery) {
                        this.searchClear.classList.add('visible');
                    } else {
                        this.searchClear.classList.remove('visible');
                    }
                }
                
                // 过滤导航项
                this.navItems.forEach(navItem => {
                    const text = navItem.querySelector('.text').textContent.toLowerCase();
                    const description = navItem.getAttribute('aria-describedby');
                    let descText = '';
                    
                    if (description) {
                        const descElement = document.getElementById(description);
                        if (descElement) {
                            descText = descElement.textContent.toLowerCase();
                        }
                    }
                    
                    const matches = !trimmedQuery || 
                                  text.includes(trimmedQuery) || 
                                  descText.includes(trimmedQuery);
                    
                    navItem.parentElement.classList.toggle('filtered-out', !matches);
                });
            }

            handleSearchKeydown(e) {
                if (e.key === 'Escape') {
                    this.clearSearch();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    // 如果有搜索结果，跳转到第一个匹配项
                    const firstVisible = Array.from(this.navItems).find(item => 
                        !item.parentElement.classList.contains('filtered-out')
                    );
                    if (firstVisible) {
                        const sectionId = firstVisible.getAttribute('data-section');
                        if (sectionId) {
                            this.navigateToSection(sectionId);
                        }
                    }
                }
            }

            clearSearch() {
                if (this.searchInput) {
                    this.searchInput.value = '';
                    this.handleSearch('');
                    this.searchInput.focus();
                }
            }

            focusSearch() {
                if (this.searchInput) {
                    this.searchInput.focus();
                    this.searchInput.select();
                }
            }

            navigateKeyboard(direction) {
                const visibleNavItems = Array.from(this.navItems).filter(item => 
                    !item.parentElement.classList.contains('filtered-out')
                );
                
                if (visibleNavItems.length === 0) return;
                
                this.keyboardNavIndex = Math.max(0, Math.min(
                    visibleNavItems.length - 1,
                    this.keyboardNavIndex + direction
                ));
                
                const targetItem = visibleNavItems[this.keyboardNavIndex];
                if (targetItem) {
                    targetItem.focus();
                }
            }

            // 移动端操作
            toggleSidebar() {
                this.sidebar.classList.toggle('open');
                this.mobileOverlay.classList.toggle('show');
                
                if (this.sidebar.classList.contains('open')) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
            }

            closeSidebar() {
                this.sidebar.classList.remove('open');
                this.mobileOverlay.classList.remove('show');
                document.body.style.overflow = '';
            }

            // 进度条交互
            handleProgressClick(e) {
                const rect = e.currentTarget.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const percentage = clickX / rect.width;
                
                const documentHeight = document.documentElement.scrollHeight - window.innerHeight;
                const targetY = documentHeight * percentage;
                
                this.smoothScrollTo(targetY);
            }

            scrollToTop() {
                this.smoothScrollTo(0);
            }



            // 状态保存和恢复
            saveState() {
                const state = {
                    currentSection: this.currentSection,
                    timestamp: Date.now()
                };
                localStorage.setItem('peptide_nav_state', JSON.stringify(state));
            }

            saveReadingPosition(scrollTop) {
                localStorage.setItem('peptide_reading_position', scrollTop.toString());
            }

            restoreState() {
                try {
                    const savedState = localStorage.getItem('peptide_nav_state');
                    if (savedState) {
                        const state = JSON.parse(savedState);
                        // 只在5分钟内的状态才恢复
                        if (Date.now() - state.timestamp < 300000) {
                            this.updateActiveNavigation(state.currentSection);
                        }
                    }
                } catch (error) {
                    console.warn('无法恢复导航状态:', error);
                }
            }

            // 无障碍支持
            announceCurrentSection(sectionName) {
                const announcement = `Current section: ${sectionName}`;
                const ariaLive = document.createElement('div');
                ariaLive.setAttribute('aria-live', 'polite');
                ariaLive.setAttribute('aria-atomic', 'true');
                ariaLive.className = 'sr-only';
                ariaLive.textContent = announcement;
                
                document.body.appendChild(ariaLive);
                setTimeout(() => document.body.removeChild(ariaLive), 1000);
            }

            // 处理Back to Search按钮点击
            handleBackToSearch(button, href) {
                // 添加点击效果
                button.classList.add('clicking');
                setTimeout(() => {
                    button.classList.remove('clicking');
                }, 300);

                // 添加加载状态
                button.classList.add('loading');
                
                // 延迟跳转，让用户看到加载效果
                setTimeout(() => {
                    // 保存当前页面状态到localStorage
                    const currentState = {
                        url: window.location.href,
                        timestamp: Date.now(),
                        scrollPosition: window.pageYOffset
                    };
                    localStorage.setItem('peptide_card_return_state', JSON.stringify(currentState));
                    
                    // 跳转到搜索页面
                    window.location.href = href;
                }, 500);
            }

            // 清理状态
            cleanup() {
                if (this.scrollTimeout) {
                    clearTimeout(this.scrollTimeout);
                    this.scrollTimeout = null;
                }
                this.isProgrammaticScroll = false;
                
                if (this.intersectionObserver) {
                    this.intersectionObserver.disconnect();
                }
            }

            // 工具函数
            throttle(func, limit) {
                let inThrottle;
                return function(...args) {
                    if (!inThrottle) {
                        func.apply(this, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                }
            }

            debounce(func, wait) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                }
            }

            // 折叠/展开功能（为未来扩展预留）
            collapseAll() {
                console.log('折叠所有sections（功能待实现）');
            }

            expandAll() {
                console.log('展开所有sections（功能待实现）');
            }

            // 语言切换（保持兼容性）
            initLanguageSelector() {
                const langOptions = document.querySelectorAll('.language-options a');
                langOptions.forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.preventDefault();
                        const newLang = option.getAttribute('data-lang');
                        this.changeLanguage(newLang);
                    });
                });
            }

            changeLanguage(lang) {
                const langDisplay = {
                    'en': 'English',
                    'zh-Hans': '中文 (简体)',
                    'zh-Hant': '繁體中文',
                    'ja': '日本語',
                    'ko': '한국어',
                    'fr': 'Français',
                    'de': 'Deutsch',
                    'es': 'Español',
                    'ru': 'Русский'
                };
                
                document.getElementById('currentLangText').textContent = langDisplay[lang];
                localStorage.setItem('preferredLanguage', lang);
                
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('ts', Date.now());
                window.location.href = currentUrl.toString();
            }
        }

        // 初始化智能导航系统
        let smartNavigation;
        document.addEventListener('DOMContentLoaded', () => {
            // 等待DOM完全准备后再初始化
            setTimeout(() => {
                smartNavigation = new SmartNavigationSystem();
                window.smartNavigation = smartNavigation; // 保存到全局变量
                console.log('智能导航系统已启动');
            }, 100);
            
            // 页面卸载时清理资源
            window.addEventListener('beforeunload', () => {
                if (smartNavigation) {
                    smartNavigation.cleanup();
                }
            });
            
            // 快速笔记按钮事件处理将由 initQuickNotesButton 函数处理
            setTimeout(() => {
                if (!window.quickNotes) {
                    console.log('Waiting for Quick Notes to load...');
                }
            }, 2000);
        });

        // --- 高效的数据查找辅助函数 ---
        class DataFinder {
            constructor(data) {
                this.data = data;
                this.cache = new Map();
                this.pathCache = new Map();
                this.initializeFieldMap();
            }

            // 初始化字段映射，预计算常用字段路径
            initializeFieldMap() {
                this.fieldPaths = new Map();
                this.flattenData(this.data, []);
            }

            // 展平数据结构，建立字段路径映射
            flattenData(obj, path) {
                if (obj === null || obj === undefined) return;

                if (Array.isArray(obj)) {
                    obj.forEach((item, index) => {
                        this.flattenData(item, [...path, index]);
                    });
                } else if (typeof obj === 'object') {
                    Object.entries(obj).forEach(([key, value]) => {
                        const currentPath = [...path, key];
                        
                        // 存储字段路径
                        if (!this.fieldPaths.has(key)) {
                            this.fieldPaths.set(key, []);
                        }
                        this.fieldPaths.get(key).push({
                            path: currentPath,
                            value: value
                        });

                        // 递归处理嵌套对象
                        if (value && typeof value === 'object') {
                            this.flattenData(value, currentPath);
                        }
                    });
                }
            }

            // 高效查找字段值
            findValue(targetKey) {
                // 检查缓存
                if (this.cache.has(targetKey)) {
                    return this.cache.get(targetKey);
                }

                let result = null;

                // 首先尝试直接字段匹配
                if (this.fieldPaths.has(targetKey)) {
                    const matches = this.fieldPaths.get(targetKey);
                    if (matches.length > 0) {
                        // 返回第一个匹配的值
                        result = matches[0].value;
                    }
                }

                // 如果没找到，尝试大小写不敏感匹配
                if (result === null) {
                    const lowerKey = targetKey.toLowerCase();
                    for (const [key, matches] of this.fieldPaths.entries()) {
                        if (key.toLowerCase() === lowerKey && matches.length > 0) {
                            result = matches[0].value;
                            break;
                        }
                    }
                }

                // 如果还是没找到，尝试包含匹配
                if (result === null) {
                    const searchKey = targetKey.toLowerCase();
                    for (const [key, matches] of this.fieldPaths.entries()) {
                        if (key.toLowerCase().includes(searchKey) && matches.length > 0) {
                            result = matches[0].value;
                            break;
                        }
                    }
                }

                // 缓存结果
                this.cache.set(targetKey, result);
                return result;
            }

            // 检查字段是否存在
            hasField(targetKey) {
                return this.findValue(targetKey) !== null;
            }
        }

        // 兼容性包装函数
        function findValueInObject(data, targetKey) {
            if (!data) return null;
            const finder = new DataFinder(data);
            return finder.findValue(targetKey);
        }

        // URL 参数解析 - 仅支持SPADE ID格式
        function getPeptideIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // 支持的参数名称（完全移除DRAMP相关）
            const possibleParams = ['ID', 'SPADE_ID', 'id', 'peptideId'];
            
            for (const param of possibleParams) {
                const value = urlParams.get(param);
                if (value) {
                    console.log(`找到参数 ${param}: ${value}`);
                    // 处理SPADE格式：SPADE_N_00001 或 SPADE_UN_00001
                    return value.split(':')[0].trim();
                }
            }
            
            return null;
        }

        // 主初始化函数
        function initializeApplication() {
            console.log('开始初始化应用...');
            
            // 首先初始化缓存系统
            try {
                initializeCache();
                console.log('缓存系统初始化成功');
            } catch (error) {
                console.error('缓存系统初始化失败:', error);
            }
            
            // 执行调试信息
            setTimeout(debugInfo, 500);
            
            // 获取 peptideId
            const peptideId = getPeptideIdFromUrl();
            
            console.log('解析的 peptideId:', peptideId);
            console.log('当前 URL:', window.location.href);
        
        // 检查 peptideId 是否有效
        if (!peptideId) {
            console.error('无法从URL获取有效的 Peptide ID');
                console.log('URL参数:', window.location.search);
            // 显示错误信息
                showErrorMessage('Invalid or missing Peptide ID in URL. Please check the URL parameters.');
        } else {
            // 根据peptideId格式确定正确的文件路径
            let dataUrl;
            if (peptideId.startsWith('SPADE_UN_')) {
                dataUrl = `./data/detail/SPADE_UN/${peptideId}.json`;
            } else if (peptideId.startsWith('SPADE_N_')) {
                dataUrl = `./data/detail/SPADE_N/${peptideId}.json`;
            } else {
                // 如果是其他格式，尝试在SPADE_N目录中查找
                console.warn(`未识别的ID格式: ${peptideId}，尝试在SPADE_N目录中查找`);
                dataUrl = `./data/detail/SPADE_N/${peptideId}.json`;
            }
            
            console.log('数据文件路径:', dataUrl);
            // 使用受保护的数据加载方式
            loadProtectedData(dataUrl, peptideId);
            }
        }
        
        // 等待DOM加载完成后初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApplication);
        } else {
            // DOM 已经加载完成
            initializeApplication();
        }

        // 统一的错误信息显示函数
        function showErrorMessage(message) {
            const titleElement = document.getElementById('peptide-name');
            const containerElement = document.getElementById('module-container');
            
            if (titleElement) {
                titleElement.textContent = '';
            }
            
            if (containerElement) {
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error-message fade-in';
                errorMsg.textContent = message;
                errorMsg.setAttribute('data-translate', '');
                containerElement.innerHTML = '';
                containerElement.appendChild(errorMsg);
            }
        }

        // 数据缓存系统 - 使用单例模式确保安全初始化
        class DataCache {
            constructor() {
                this.cache = new Map();
                this.maxCacheSize = 10;
                this.cacheAge = 5 * 60 * 1000; // 5分钟缓存
                console.log('DataCache 初始化完成');
            }

            set(key, data) {
                if (this.cache.size >= this.maxCacheSize) {
                    const firstKey = this.cache.keys().next().value;
                    this.cache.delete(firstKey);
                }
                this.cache.set(key, {
                    data: data,
                    timestamp: Date.now()
                });
                console.log(`缓存数据: ${key}`);
            }

            get(key) {
                const cached = this.cache.get(key);
                if (!cached) {
                    console.log(`缓存未命中: ${key}`);
                    return null;
                }
                
                if (Date.now() - cached.timestamp > this.cacheAge) {
                    this.cache.delete(key);
                    console.log(`缓存过期: ${key}`);
                    return null;
                }
                
                console.log(`缓存命中: ${key}`);
                return cached.data;
            }

            static getInstance() {
                if (!DataCache.instance) {
                    DataCache.instance = new DataCache();
                }
                return DataCache.instance;
            }
        }

        // 初始化缓存系统 - 使用单例模式
        function initializeCache() {
            return DataCache.getInstance();
        }

        // 获取缓存实例
        function getCache() {
            return DataCache.getInstance();
        }

        // 显示加载状态
        function showLoadingState() {
            const container = document.getElementById('module-container');
            container.innerHTML = `
                <div class="loading-container">
                    <div class="loading-dots">
                        <div></div>
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                    <div class="loading-text" data-translate="">Loading peptide data...</div>
                </div>
            `;
        }

        // 显示骨架屏
        function showSkeletonScreen() {
            const container = document.getElementById('module-container');
            const skeletonHTML = `
                <div class="skeleton skeleton-title"></div>
                <div class="skeleton skeleton-table"></div>
                <div class="skeleton skeleton-table"></div>
                <div class="skeleton skeleton-table"></div>
            `;
            container.innerHTML = skeletonHTML;
        }

        // 优化的受保护数据加载函数
        async function loadProtectedData(dataUrl, peptideId) {
            console.log('开始加载数据:', { dataUrl, peptideId });
            
            // 显示加载状态
            showLoadingState();
            
            try {
                // 获取缓存实例
                const cache = getCache();
                
                // 检查缓存
                const cachedData = cache.get(peptideId);
                if (cachedData) {
                    console.log('从缓存加载数据');
                    renderPeptide(cachedData);
                    return;
                }

                console.log('从网络加载数据...');
                
                // 简化保护组件检查逻辑
                const waitForProtection = () => {
                    return new Promise(resolve => {
                        // 如果保护组件不存在，直接继续
                if (!window.protectionInstance) {
                            console.log('保护组件未加载，跳过保护检查');
                            resolve();
                            return;
                        }
                        
                        const checkProtection = () => {
                            if (window.protectionInstance.isReady) {
                                console.log('保护组件已就绪');
                                resolve();
                            } else {
                                setTimeout(checkProtection, 50);
                            }
                        };
                        checkProtection();
                    });
                };

                // 使用 fetch 获取数据，添加更好的错误处理
                const fetchData = async () => {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);
                    
                    try {
                        const response = await fetch(dataUrl, {
                            signal: controller.signal,
                            cache: 'no-cache', // 确保获取最新数据
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        clearTimeout(timeoutId);
                        
                        console.log('HTTP响应状态:', response.status);
                
                if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                        console.log('数据解析成功，数据大小:', JSON.stringify(data).length, '字符');
                        return data;
                        
                    } catch (fetchError) {
                        clearTimeout(timeoutId);
                        throw fetchError;
                    }
                };

                // 并行进行保护检查和数据获取
                const [, data] = await Promise.all([
                    waitForProtection(),
                    fetchData()
                ]);
                
                // 移除保护元数据（如果存在）
                const cleanData = cleanProtectedData(data);
                
                // 缓存数据
                cache.set(peptideId, cleanData);
                
                console.log('数据加载完成，开始渲染');
                renderPeptide(cleanData);
                
            } catch (error) {
                console.error('数据加载或解析失败:', error);
                console.error('错误详情:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                handleLoadingError(error, peptideId);
            }
        }

        // 错误处理函数
        function handleLoadingError(error, peptideId) {
            let errorMessage = 'Data loading failed.';
                
                // 根据错误类型显示不同的消息
            if (error.name === 'AbortError') {
                errorMessage = 'Request timeout. Please check your connection and try again.';
            } else if (error instanceof SyntaxError) {
                errorMessage = 'Failed to parse data. Invalid JSON format.';
            } else if (error.message.includes('HTTP 404')) {
                errorMessage = `Data file not found: ${peptideId}.json. Please verify the peptide ID.`;
            } else if (error.message.includes('HTTP 500')) {
                errorMessage = 'Server error. Please try again later.';
            } else if (error.message.includes('HTTP')) {
                errorMessage = `Network error: ${error.message}`;
                } else if (error.message.includes('访问被限制') || error.message.includes('请求频率')) {
                errorMessage = 'Access temporarily limited. Please try again in a moment.';
            } else if (error.message.includes('fetch')) {
                errorMessage = 'Network connection failed. Please check your internet connection.';
                } else {
                errorMessage = `Unexpected error: ${error.message}`;
            }
            

            showErrorMessage(errorMessage);
            
            // 添加重试按钮
            setTimeout(() => {
                const container = document.getElementById('module-container');
                if (container && container.querySelector('.error-message')) {
                    const retryButton = document.createElement('button');
                    retryButton.textContent = 'Retry';
                    retryButton.className = 'retry-button';
                    retryButton.style.cssText = `
                        margin-top: 15px;
                        padding: 10px 20px;
                        background: var(--primary);
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        transition: all 0.3s ease;
                    `;
                    
                    retryButton.addEventListener('click', () => {
                        console.log('重试加载数据...');
                        const DATA_URL = `./data/detail/${peptideId}.json`;
                        loadProtectedData(DATA_URL, peptideId);
                    });
                    
                    retryButton.addEventListener('mouseenter', () => {
                        retryButton.style.transform = 'translateY(-2px)';
                        retryButton.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                    });
                    
                    retryButton.addEventListener('mouseleave', () => {
                        retryButton.style.transform = 'translateY(0)';
                        retryButton.style.boxShadow = 'none';
                    });
                    
                    container.querySelector('.error-message').appendChild(retryButton);
                }
            }, 500);
        }

        // 清理保护数据函数
        function cleanProtectedData(data) {
            if (data && typeof data === 'object') {
                const cleanData = { ...data };
                delete cleanData._metadata;
                return cleanData;
            }
            return data;
        }

        // 调试工具函数
        function debugInfo() {

            console.log('当前URL:', window.location.href);
            console.log('URL参数:', window.location.search);
            console.log('解析的peptideId:', getPeptideIdFromUrl());
            
            try {
                const cache = getCache();
                console.log('dataCache状态:', cache ? '已初始化' : '未初始化');
            } catch (error) {
                console.log('dataCache状态: 初始化失败 -', error.message);
            }
            
            console.log('protectionInstance状态:', window.protectionInstance ? '存在' : '不存在');
            
            // 检查Database目录是否可访问
            fetch('./Database/').then(response => {
                console.log('Database目录访问状态:', response.status);
            }).catch(error => {
                console.log('Database目录访问失败:', error.message);
            });
            
            console.log('===============');
        }

        // 检查值是否为有效信息
        function isValidValue(value) {
            if (value === null || value === undefined || value === '') {
                return false;
            }
            
            // 检查字符串类型的无效值
            if (typeof value === 'string') {
                const invalidStrings = [
                    'not found',
                    'not include',
                    'not included yet',
                    'no entry found',
                    'no hemolysis information',
                    'no cytotoxicity information',
                    'there is no predicted structure',
                    'none',
                    'no mics found',
                    'no data found',
                    'reference(s) presented',
                    'dramp database'
                ];
                
                const lowerValue = value.toLowerCase().trim();
                
                // 检查是否包含无效关键词
                if (invalidStrings.some(invalid => lowerValue.includes(invalid))) {
                    return false;
                }
                
                // 检查是否只是空白字符
                if (lowerValue === '') {
                    return false;
                }
                
                return true;
            }
            
            // 检查数组是否为空或包含无效数据
            if (Array.isArray(value)) {
                // 检查数组是否为空
                if (value.length === 0) {
                    return false;
                }
                
                // 检查数组中是否都是有效数据
                return value.some(item => {
                    if (typeof item === 'string') {
                        const itemLower = item.toLowerCase().trim();
                        return itemLower !== '' && 
                               !itemLower.includes('not found') && 
                               !itemLower.includes('not include');
                    } else if (typeof item === 'object' && item !== null) {
                        // 对于文献对象，检查是否有有效的标题或作者
                        if ((item.Title && item.Title.trim() !== '') || 
                            (item.Author && item.Author.trim() !== '')) {
                            return true;
                        }
                        // 对于相似序列对象，检查是否有有效的SPADE_ID或序列
                        if ((item.SPADE_ID && item.SPADE_ID.trim() !== '') || 
                            (item.Sequence && item.Sequence.trim() !== '')) {
                            return true;
                        }
                        // 对于其他对象，检查是否有任何非空字段
                        return Object.values(item).some(val => 
                            val !== null && val !== undefined && val !== ''
                        );
                    }
                    return true;
                });
            }
            
            return true;
        }

        // 改进的数据查找函数，支持多层级数据结构和各种字段名变体
        function findFieldValue(data, fieldName) {
            if (!data || typeof data !== 'object') {
                return undefined;
            }
            
            // 直接查找
            if (data[fieldName] !== undefined && data[fieldName] !== null && data[fieldName] !== '') {
                return data[fieldName];
            }
            
            // 特殊字段映射 - 处理同义词和变体
            const fieldMappings = {
                'PTM': ['ptm', 'PTM', 'Ptm'],
                'Comment': ['Comment', 'comment', 'Comments', 'comments'],
                'Biophysicochemical properties': ['Biophysicochemical properties', 'biophysicochemical properties', 'Biophysicochemical Properties']
            };
            
            if (fieldMappings[fieldName]) {
                for (const variant of fieldMappings[fieldName]) {
                    if (data[variant] !== undefined && data[variant] !== null && data[variant] !== '') {
                        return data[variant];
                    }
                }
            }
            
            // 在Sequence Information中查找
            if (data['Sequence Information']) {
                const seqInfo = data['Sequence Information'];
                if (seqInfo[fieldName] !== undefined && seqInfo[fieldName] !== null && seqInfo[fieldName] !== '') {
                    return seqInfo[fieldName];
                }
                
                // 在Sequence Information中查找字段变体
                if (fieldMappings[fieldName]) {
                    for (const variant of fieldMappings[fieldName]) {
                        if (seqInfo[variant] !== undefined && seqInfo[variant] !== null && seqInfo[variant] !== '') {
                            return seqInfo[variant];
                        }
                    }
                }
            }
            
            // 在Clinical Information中查找
            if (data['Clinical Information'] && Array.isArray(data['Clinical Information'])) {
                for (const item of data['Clinical Information']) {
                    if (typeof item === 'object' && item[fieldName] !== undefined) {
                        return item[fieldName];
                    }
                }
            }
            
            // 在Patent Information中查找
            if (data['Patent Information'] && Array.isArray(data['Patent Information'])) {
                for (const item of data['Patent Information']) {
                    if (typeof item === 'object' && item[fieldName] !== undefined) {
                        return item[fieldName];
                    }
                }
            }
            
            // 递归查找所有层级，但跳过已处理的特殊键
            const skipKeys = ['Sequence Information', 'Clinical Information', 'Patent Information'];
            for (const key in data) {
                if (!skipKeys.includes(key) && typeof data[key] === 'object' && data[key] !== null && !Array.isArray(data[key])) {
                    const result = findFieldValue(data[key], fieldName);
                    if (result !== undefined && result !== null && result !== '') {
                        return result;
                    }
                }
            }
            
            return undefined;
        }

        // 收集所有可用字段的函数
        function getAllAvailableFields(data, prefix = '') {
            const fields = new Set();
            
            if (!data || typeof data !== 'object') {
                return fields;
            }
            
            for (const key in data) {
                const fullKey = prefix ? `${prefix}.${key}` : key;
                fields.add(key); // 添加当前键
                
                if (typeof data[key] === 'object' && data[key] !== null && !Array.isArray(data[key])) {
                    // 递归获取嵌套对象的字段
                    const nestedFields = getAllAvailableFields(data[key], fullKey);
                    nestedFields.forEach(field => fields.add(field));
                } else if (Array.isArray(data[key]) && data[key].length > 0 && typeof data[key][0] === 'object') {
                    // 处理对象数组
                    const nestedFields = getAllAvailableFields(data[key][0], fullKey);
                    nestedFields.forEach(field => fields.add(field));
                }
            }
            
            return fields;
        }

        // 优化的文档片段渲染函数
        function renderPeptide(peptide) {
            console.log('完整的肽数据结构:', peptide); // 调试日志
            
            // 性能计时开始
            const startTime = performance.now();
            
            // 显示所有可用字段
            const allFields = getAllAvailableFields(peptide);

            
            const pageTitle = document.getElementById('peptide-name');
            // 优先使用SPADE ID，然后是Peptide Name
            const spadeId = findFieldValue(peptide, 'SPADE ID');
            const peptideName = findFieldValue(peptide, 'Peptide Name');
            
            // 更新页面标题和浏览器标签
            const displayTitle = spadeId || peptideName || 'Unknown Peptide';
            pageTitle.textContent = displayTitle;
            
            // 更新浏览器标签标题
            if (spadeId) {
                document.title = `${spadeId} - SPADE Peptide Details`;
            } else if (peptideName) {
                document.title = `${peptideName} - SPADE Peptide Details`;
            } else {
                document.title = 'SPADE Peptide Details';
            }

            const modules = [
                { id: 'general', title: 'General Information', fields: [
                    'SPADE ID', 'Peptide Name', 'Source', 'Family', 'Sequence Length', 'Biological Activity',
                    'Gene', 'Sequence', 'UniProt Entry', 'Protein Existence'
                ]},
                { id: 'activity', title: 'Activity Information', fields: [
                    'Biological Activity', 'Target Organism', 'Hemolytic Activity',
                    'Cytotoxicity', 'Binding Target'
                ]},
                { id: 'structure', title: 'Structural Information', fields: [
                    'Linear/Cyclic', 'N-terminal Modification', 'C-terminal Modification',
                    'Nonterminal Modifications and Unusual Amino Acids', 'Stereochemistry',
                    'Structure', 'Structure Description', 'Helical Wheel Diagram',
                    'PDB ID', 'Predicted Structure'
                ]},
                { id: 'properties', title: 'Physico-Chemical Properties', fields: [
                    'Formula', 'Absent Amino Acids', 'Frequent Amino Acids', 'Common Amino Acids', 'Mass', 'PI',
                    'Basic Residues', 'Acidic Residues', 'Hydrophobic Residues', 'Polar Residues', 'Positive Residues', 'Negative Residues', 'Net Charge',
                    'Boman Index', 'Hydrophobicity', 'Aliphatic Index', 'Half Life',
                    'Extinction Coefficient Cystines', 'Absorbance 280nm'
                ]},
                { id: 'comments', title: 'Comments Information', fields: [
                    'Function', 'PTM', 'Comment', 'Biophysicochemical properties', 'target_organisms'
                ]},
                { id: 'similar', title: 'Similar Sequences', fields: [
                    'Similar Sequences'
                ]},
                { id: 'literature', title: 'Literature Information', fields: [
                    'Literature'
                ]}
            ];

            // 使用文档片段优化DOM操作
            const moduleContainer = document.getElementById('module-container');
            const fragment = document.createDocumentFragment();
            
            modules.forEach(moduleConfig => {
                // 先检查这个模块是否有任何有效字段
                const validFields = moduleConfig.fields.filter(field => {
                    const value = findFieldValue(peptide, field);
                    return isValidValue(value);
                });

                // 如果没有有效字段，跳过整个模块
                if (validFields.length === 0) {
                    console.log(`模块 "${moduleConfig.title}" 没有有效数据，跳过显示`);
                    return;
                }

                const module = document.createElement('div');
                module.className = 'module';
                module.id = moduleConfig.id;

                const moduleTitle = document.createElement('h3');
                moduleTitle.className = 'module-title';
                moduleTitle.textContent = moduleConfig.title;
                moduleTitle.setAttribute('data-translate', ''); // 标记为需要翻译
                module.appendChild(moduleTitle);

                const table = document.createElement('table');
                table.className = 'info-table';

                moduleConfig.fields.forEach(field => {
                    let value = findFieldValue(peptide, field);
                    
                    // 检查值是否有效，如果无效则跳过此字段
                    if (!isValidValue(value)) {
        
                        return; // 跳过这个字段，不渲染这一行
                    }

                    const row = document.createElement('tr');
                    const th = document.createElement('th');
                    th.textContent = field;
                    th.setAttribute('data-translate', ''); // 标记为需要翻译
                    row.appendChild(th);

                    const td = document.createElement('td');

                    // 特殊处理Target Organism字段，以分隔的形式展示
                    if (field === 'Target Organism' && value) {
                        // 创建可滚动容器
                        const scrollContainer = document.createElement('div');
                        scrollContainer.className = 'scrollable-content';
                        
                        const organismList = document.createElement('ul');
                        organismList.className = 'organism-list';
                        
                        // 如果是长字符串，尝试解析为更友好的格式
                        if (typeof value === 'string') {
                            // 处理特殊格式：添加说明标题
                            if (value.includes('Note:')) {
                                // 分离注释和主要内容
                                const parts = value.split('Note:');
                                const mainContent = parts[0].trim();
                                const note = 'Note:' + parts[1].trim();
                                
                                // 处理主要内容部分
                                processOrganismString(mainContent, organismList);
                                
                                // 添加注释作为单独的项
                                const noteItem = document.createElement('li');
                                noteItem.className = 'organism-item';
                                noteItem.style.fontStyle = 'italic';
                                noteItem.style.marginTop = '10px';
                                noteItem.style.color = '#666';
                                noteItem.textContent = note;
                                noteItem.setAttribute('data-translate', ''); // 标记为需要翻译
                                organismList.appendChild(noteItem);
                            } else {
                                // 处理普通格式
                                processOrganismString(value, organismList);
                            }
                        }
                        
                        scrollContainer.appendChild(organismList);
                        td.appendChild(scrollContainer);
                    }
                    // 特殊处理target_organisms字段（处理结构化的目标生物数据）
                    else if (field === 'target_organisms' && value && Array.isArray(value)) {
                        const scrollContainer = document.createElement('div');
                        scrollContainer.className = 'scrollable-content';
                        
                        const organismList = document.createElement('ul');
                        organismList.className = 'organism-list';
                        
                        value.forEach(organism => {
                            if (typeof organism === 'object' && organism.name) {
                                const organismItem = document.createElement('li');
                                organismItem.className = 'organism-item';
                                
                                const nameSpan = document.createElement('span');
                                nameSpan.className = 'organism-name';
                                nameSpan.textContent = organism.name;
                                nameSpan.setAttribute('data-translate', '');
                                organismItem.appendChild(nameSpan);
                                
                                if (organism.activity) {
                                    const activitySpan = document.createElement('span');
                                    activitySpan.className = 'organism-susceptibility';
                                    activitySpan.textContent = organism.activity;
                                    
                                    // 根据活性强度设置颜色
                                    const plusCount = (organism.activity.match(/\\+/g) || []).length;
                                    if (plusCount >= 4) {
                                        activitySpan.style.color = '#d32f2f'; // 极高活性红色
                                    } else if (plusCount >= 3) {
                                        activitySpan.style.color = '#4CAF50'; // 高活性绿色
                                    } else if (plusCount >= 2) {
                                        activitySpan.style.color = '#2196F3'; // 中等活性蓝色
                                    } else if (plusCount >= 1) {
                                        activitySpan.style.color = '#FFC107'; // 低活性黄色
                                    }
                                    
                                    organismItem.appendChild(activitySpan);
                                }
                                
                                organismList.appendChild(organismItem);
                            }
                        });
                        
                        scrollContainer.appendChild(organismList);
                        td.appendChild(scrollContainer);
                    }
                    // 特殊处理序列字段，应用新样式
                    else if (field === 'Sequence' && value) {
                        const sequenceElem = document.createElement('div');
                        sequenceElem.className = 'sequence';
                        sequenceElem.textContent = value;
                        sequenceElem.classList.add('no-translate'); // 序列不应被翻译
                        td.appendChild(sequenceElem);
                    }
                    // 特殊处理生物活性字段，应用标签样式
                    else if (field === 'Biological Activity' && value) {
                        if (Array.isArray(value)) {
                            value.forEach(activity => {
                                const tag = document.createElement('span');
                                tag.className = 'activity-tag';
                                tag.textContent = activity;
                                tag.setAttribute('data-translate', ''); // 标记为需要翻译
                                td.appendChild(tag);
                            });
                        } else {
                            const tag = document.createElement('span');
                            tag.className = 'activity-tag';
                            tag.textContent = value;
                            tag.setAttribute('data-translate', ''); // 标记为需要翻译
                            td.appendChild(tag);
                        }
                    }
                    // 特殊处理结构字段，添加3D结构查看器
                    else if ((field === 'Structure' || field === 'Predicted Structure' || field === 'PDB ID') && value) {
                        if (field === 'PDB ID' && value !== 'None' && value !== 'Not found') { // Added 'Not found' check
                            // 为PDB ID创建链接和嵌入式查看器
                            const pdbLink = document.createElement('a');
                            pdbLink.href = `https://www.rcsb.org/structure/${value}`;
                            pdbLink.textContent = value;
                            pdbLink.target = '_blank';
                            pdbLink.rel = 'noopener noreferrer';
                            pdbLink.className = 'structure-link';
                            td.appendChild(pdbLink);
                            
                            // 添加3D结构查看器
                            const viewerContainer = document.createElement('div');
                            viewerContainer.className = 'structure-viewer';
                            
                            const viewer = document.createElement('iframe');
                            viewer.src = `https://www.rcsb.org/3d-view?id=${value}`;
                            viewer.width = '100%';
                            viewer.height = '100%';
                            viewer.frameBorder = '0';
                            viewerContainer.appendChild(viewer);
                            
                            td.appendChild(viewerContainer);
                        } else if ((field === 'Structure' || field === 'Predicted Structure') && typeof value === 'string' && value.toLowerCase().startsWith('http')) {
                            // 处理结构URL
                            const structureLink = document.createElement('a');
                            structureLink.href = value;
                            structureLink.textContent = 'View Structure';
                            structureLink.target = '_blank';
                            structureLink.rel = 'noopener noreferrer';
                            structureLink.className = 'structure-link';
                            structureLink.setAttribute('data-translate', '');
                            td.appendChild(structureLink);
                        } else if (value === 'None' || value === 'Not found' || (field === 'PDB ID' && (value === 'None' || value === 'Not found'))) {
                            const noStructure = document.createElement('div');
                            noStructure.className = 'no-structure';
                            noStructure.textContent = 'No structure available';
                            noStructure.setAttribute('data-translate', '');
                            td.appendChild(noStructure);
                        } else { // Fallback for other string values in structure fields
                            const textElem = document.createElement('span');
                            textElem.textContent = value;
                            if (typeof value === 'string') { // Ensure translation only for strings
                                textElem.setAttribute('data-translate', '');
                            }
                            td.appendChild(textElem);
                        }
                    }
                    // **** MOVED AND CORRECTED LITERATURE HANDLER ****
                    else if (field === 'Literature') {
                        // 'value' already contains the literature data from findFieldValue
                        console.log('Literature field processing. Value:', value, 'Type:', typeof value); 

                        if (value && Array.isArray(value) && value.length > 0) {
                            value.forEach((item, index) => {
                                if (typeof item === 'object' && item !== null) {
                                    const literatureDiv = document.createElement('div');
                                    literatureDiv.className = 'literature-item';
                                    
                                    const numberElem = document.createElement('div');
                                    numberElem.className = 'literature-number';
                                    numberElem.textContent = `[${index + 1}]`;
                                    literatureDiv.appendChild(numberElem);
                                    
                                    if (item.Title) {
                                        const titleElem = document.createElement('div');
                                        titleElem.className = 'literature-title';
                                        titleElem.textContent = item.Title;
                                        titleElem.setAttribute('data-translate', '');
                                        literatureDiv.appendChild(titleElem);
                                    }
                                    
                                    if (item.Author) {
                                        const authorElem = document.createElement('div');
                                        authorElem.className = 'literature-author';
                                        authorElem.textContent = item.Author;
                                        authorElem.setAttribute('data-translate', '');
                                        literatureDiv.appendChild(authorElem);
                                    }
                                    
                                    if (item.Reference) {
                                        const refElem = document.createElement('div');
                                        refElem.className = 'literature-reference';
                                        refElem.textContent = item.Reference;
                                        literatureDiv.appendChild(refElem);
                                    }
                                    
                                    const buttonContainer = document.createElement('div');
                                    buttonContainer.className = 'literature-buttons';
                                    
                                    if (item['Pubmed ID'] && item['Pubmed ID'].trim() !== '') {
                                        const pubmedLink = document.createElement('a');
                                        pubmedLink.href = `https://pubmed.ncbi.nlm.nih.gov/${item['Pubmed ID']}/`;
                                        pubmedLink.textContent = `PubMed ${item['Pubmed ID']}`;
                                        pubmedLink.target = '_blank';
                                        pubmedLink.rel = 'noopener noreferrer';
                                        pubmedLink.className = 'literature-link';
                                        pubmedLink.style.backgroundColor = '#2b1055';
                                        buttonContainer.appendChild(pubmedLink);
                                    }
                                    
                                    if (item.Reference) {
                                        const doiMatch = item.Reference.match(/doi:([^\\s.,;]+)/i);
                                        if (doiMatch) {
                                            const doi = doiMatch[1];
                                            const doiLink = document.createElement('a');
                                            doiLink.href = `https://doi.org/${doi}`;
                                            doiLink.textContent = `DOI ${doi}`;
                                            doiLink.target = '_blank';
                                            doiLink.rel = 'noopener noreferrer';
                                            doiLink.className = 'literature-link';
                                            doiLink.style.backgroundColor = '#4CAF50';
                                            buttonContainer.appendChild(doiLink);
                                        }
                                    }
                                    
                                    if (item.URL) {
                                        const urlLink = document.createElement('a');
                                        urlLink.href = item.URL;
                                        urlLink.textContent = 'View Article';
                                        urlLink.target = '_blank';
                                        urlLink.rel = 'noopener noreferrer';
                                        urlLink.className = 'literature-link';
                                        urlLink.style.backgroundColor = '#2196F3';
                                        buttonContainer.appendChild(urlLink);
                                    }
                                    
                                    if (buttonContainer.children.length > 0) {
                                        literatureDiv.appendChild(buttonContainer);
                                    }
                                    
                                    td.appendChild(literatureDiv);
                                } else if (typeof item === 'string') {
                                    const textElem = document.createElement('div');
                                    textElem.textContent = item;
                                    textElem.setAttribute('data-translate', '');
                                    textElem.style.marginBottom = '10px';
                                    td.appendChild(textElem);
                                }
                            });
                        } else if (value && typeof value === 'string') {
                            const textElem = document.createElement('div');
                            textElem.textContent = value;
                            textElem.setAttribute('data-translate', '');
                            td.appendChild(textElem);
                        } else {
                            const noDataElem = document.createElement('span');
                            noDataElem.textContent = 'No literature information available for this peptide';
                            noDataElem.style.color = '#666';
                            noDataElem.style.fontStyle = 'italic';
                            noDataElem.setAttribute('data-translate', '');
                            td.appendChild(noDataElem);
                        }
                    }
                    // 特殊处理相似序列字段
                    else if (field === 'Similar Sequences' && value && Array.isArray(value)) {
                        const scrollContainer = document.createElement('div');
                        scrollContainer.className = 'scrollable-content';
                        
                        const similarList = document.createElement('div');
                        similarList.className = 'similar-sequences-list';
                        
                        value.forEach((similarSeq, index) => {
                            if (typeof similarSeq === 'object' && similarSeq !== null) {
                                const similarItem = document.createElement('div');
                                similarItem.className = 'similar-sequence-item';
                                
                                // 序列信息容器
                                const seqInfo = document.createElement('div');
                                seqInfo.className = 'similar-seq-info';
                                
                                // SPADE ID和相似度
                                if (similarSeq.SPADE_ID) {
                                    const idSimilarityContainer = document.createElement('div');
                                    idSimilarityContainer.className = 'id-similarity-container';
                                    
                                    const idElem = document.createElement('span');
                                    idElem.className = 'similar-seq-id';
                                    idElem.textContent = similarSeq.SPADE_ID;
                                    idSimilarityContainer.appendChild(idElem);
                                    
                                    if (similarSeq.Similarity !== undefined) {
                                        const similarityElem = document.createElement('span');
                                        similarityElem.className = 'similarity-score';
                                        const percentage = (similarSeq.Similarity * 100).toFixed(1);
                                        similarityElem.textContent = `${percentage}%`;
                                        
                                        // 根据相似度设置颜色
                                        if (similarSeq.Similarity >= 0.9) {
                                            similarityElem.style.backgroundColor = '#4CAF50'; // 高相似度绿色
                                        } else if (similarSeq.Similarity >= 0.7) {
                                            similarityElem.style.backgroundColor = '#2196F3'; // 中等相似度蓝色
                                        } else {
                                            similarityElem.style.backgroundColor = '#FFC107'; // 低相似度黄色
                                        }
                                        
                                        idSimilarityContainer.appendChild(similarityElem);
                                    }
                                    
                                    seqInfo.appendChild(idSimilarityContainer);
                                }
                                
                                // 序列显示
                                if (similarSeq.Sequence) {
                                    const sequenceElem = document.createElement('div');
                                    sequenceElem.className = 'similar-sequence';
                                    sequenceElem.textContent = similarSeq.Sequence;
                                    sequenceElem.classList.add('no-translate');
                                    seqInfo.appendChild(sequenceElem);
                                }
                                
                                similarItem.appendChild(seqInfo);
                                
                                // 跳转按钮
                                if (similarSeq.SPADE_ID) {
                                    const actionContainer = document.createElement('div');
                                    actionContainer.className = 'similar-seq-actions';
                                    
                                    const viewButton = document.createElement('button');
                                    viewButton.className = 'view-similar-btn';
                                    viewButton.innerHTML = '<i class="fas fa-eye"></i> View Details';
                                    viewButton.setAttribute('data-translate', '');
                                    
                                    viewButton.addEventListener('click', () => {
                                        // 构建跳转URL
                                        const currentUrl = new URL(window.location.href);
                                        currentUrl.searchParams.set('SPADE ID', similarSeq.SPADE_ID);
                                        window.location.href = currentUrl.toString();
                                    });
                                    
                                    actionContainer.appendChild(viewButton);
                                    similarItem.appendChild(actionContainer);
                                }
                                
                                similarList.appendChild(similarItem);
                            }
                        });
                        
                        scrollContainer.appendChild(similarList);
                        td.appendChild(scrollContainer);
                    }
                    // 处理其他数组和链接 (UniProt Entry specifically)
                    else if (Array.isArray(value)) {
                        if (field === 'UniProt Entry') { // Specific handling for UniProt Entry array
                            value.forEach(item => {
                                const link = document.createElement('a');
                                link.href = String(item); // Ensure item is a string for URL
                                link.textContent = String(item);
                                td.appendChild(link);
                                td.appendChild(document.createElement('br'));
                            });
                        } else { // Fallback for other arrays not specifically handled
                            const textContainer = document.createElement('span');
                            // Avoid .join on arrays of objects, show a placeholder or count
                            if (value.every(val => typeof val === 'string' || typeof val === 'number')) {
                                textContainer.textContent = value.join(', ');
                            } else {
                                textContainer.textContent = `[Array of ${value.length} items]`; // Or handle more gracefully
                            }
                            textContainer.setAttribute('data-translate', '');
                            td.appendChild(textContainer);
                        }
                    }
                    // 特殊处理Pubmed ID（如果不是在Literature项内）
                    else if (field === 'Pubmed ID' && value) {
                        const link = document.createElement('a');
                        link.href = `http://www.ncbi.nlm.nih.gov/pubmed/?term=${value}`;
                        link.textContent = value;
                        td.appendChild(link);
                    } else {
                        const textElem = document.createElement('span');
                        if (typeof value === 'number') {
                            textElem.textContent = value.toString();
                        } else if (value === null || value === undefined || value === '') {
                            textElem.textContent = 'Not found';
                            textElem.style.color = '#999';
                            textElem.style.fontStyle = 'italic';
                        } else {
                            textElem.textContent = String(value); // Ensure value is stringified
                        }
                        
                        if (value !== null && value !== undefined && value !== '' && 
                            !field.includes('ID') && 
                            !field.includes('Mass') && 
                            !field.includes('PI') && 
                            !field.includes('Sequence') &&
                            !field.includes('Formula') &&
                            typeof value !== 'number') {
                            textElem.setAttribute('data-translate', '');
                        }
                        td.appendChild(textElem);
                    }

                    row.appendChild(td);
                    table.appendChild(row);
                });

                module.appendChild(table);
                fragment.appendChild(module);
            });
            
            // 批量更新DOM
            moduleContainer.innerHTML = '';
            moduleContainer.appendChild(fragment);
            
            // 添加简单的淡入效果
            moduleContainer.querySelectorAll('.module').forEach((module) => {
                module.classList.add('fade-in');
            });
            
            // 性能计时结束
            const endTime = performance.now();
            console.log(`页面渲染耗时: ${(endTime - startTime).toFixed(2)}ms`);
            
            // 立即重新初始化sidebar导航系统，因为section元素已经生成
            if (window.smartNavigation) {
                window.smartNavigation.setupSections();
                window.smartNavigation.initIntersectionObserver();
                console.log('Sidebar导航系统重新初始化完成');
            }
            
            // 延迟初始化翻译，避免阻塞渲染，等待Tranzy加载完成
            setTimeout(() => {
                initializeTranslation(getLanguagePreference());
            }, 1000); // 给Tranzy足够的加载时间
        }

        // 辅助函数：处理目标生物字符串
        function processOrganismString(str, containerList) {
            // 更精确地分割目标生物，处理括号内的逗号
            let organisms = [];
            let inParentheses = false;
            let currentOrg = '';
            
            for (let i = 0; i < str.length; i++) {
                const char = str[i];
                
                if (char === '(') {
                    inParentheses = true;
                    currentOrg += char;
                } else if (char === ')') {
                    inParentheses = false;
                    currentOrg += char;
                } else if ((char === ',' || char === ';') && !inParentheses) {
                    if (currentOrg.trim()) {
                        organisms.push(currentOrg.trim());
                    }
                    currentOrg = '';
                } else {
                    currentOrg += char;
                }
            }
            
            // 添加最后一个生物
            if (currentOrg.trim()) {
                organisms.push(currentOrg.trim());
            }
            
            // 处理每个分离的生物项
            organisms.forEach(org => {
                // 使用更通用的正则表达式来匹配各种敏感性标记格式
                const match = org.match(/(.*?)(\s*\([+\w\s.,]+\))?$/);
                
                if (match) {
                    const organismItem = document.createElement('li');
                    organismItem.className = 'organism-item';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'organism-name';
                    nameSpan.textContent = match[1].trim();
                    nameSpan.setAttribute('data-translate', ''); // 标记为需要翻译
                    organismItem.appendChild(nameSpan);
                    
                    // 如果有敏感性/信息标记，添加它
                    if (match[2]) {
                        const susceptSpan = document.createElement('span');
                        susceptSpan.className = 'organism-susceptibility';
                        
                        // 判断敏感性标记类型并设置颜色
                        const susceptText = match[2].trim();
                        susceptSpan.textContent = susceptText;
                        
                        // 根据加号数量确定颜色
                        const plusCount = (susceptText.match(/\\+/g) || []).length;
                        if (plusCount >= 3) {
                            susceptSpan.style.color = '#4CAF50'; // 高敏感性绿色
                        } else if (plusCount >= 2) {
                            susceptSpan.style.color = '#2196F3'; // 中等敏感性蓝色
                        } else if (plusCount >= 1) {
                            susceptSpan.style.color = '#FFC107'; // 低敏感性黄色
                        }
                        
                        organismItem.appendChild(susceptSpan);
                    }
                    
                    containerList.appendChild(organismItem);
                } else {
                    // 如果无法解析格式，直接添加整个字符串
                    const organismItem = document.createElement('li');
                    organismItem.className = 'organism-item';
                    organismItem.textContent = org;
                    organismItem.setAttribute('data-translate', ''); // 标记为需要翻译
                    containerList.appendChild(organismItem);
                }
            });
        }



        // 顶部导航栏功能由 header-nav.js 组件处理

        // 保存语言偏好
        function saveLanguagePreference(lang) {
            localStorage.setItem('preferredLanguage', lang);
        }

        // 获取保存的语言偏好
        function getLanguagePreference() {
            return localStorage.getItem('preferredLanguage') || 'en';
        }

        // 获取语言显示名称
        function getLanguageDisplayName(langCode) {
            const langNames = {
                'en': 'English',
                'zh-Hans': '中文 (简体)',
                'zh-Hant': '繁體中文',
                'ja': '日本語',
                'ko': '한국어',
                'fr': 'Français',
                'de': 'Deutsch',
                'es': 'Español',
                'ru': 'Русский'
            };
            return langNames[langCode] || langCode;
        }

        // 初始化语言功能
        document.addEventListener('DOMContentLoaded', function() {
            // 导航栏活动状态由 header-nav.js 组件自动处理
            // 快速笔记按钮事件处理已由上面的 initQuickNotesButton 函数处理
            
            const savedLang = getLanguagePreference();
            document.documentElement.lang = savedLang;
            
            // 更新当前语言显示
            updateCurrentLanguageDisplay();
            
            // 初始化多语言选择
            const langOptions = document.querySelectorAll('.language-options a');
            langOptions.forEach(option => {
                option.addEventListener('click', function(e) {
                    e.preventDefault();
                    const newLang = this.getAttribute('data-lang');
                    if (newLang === document.documentElement.lang) return;
                    
                    // 保存语言设置并刷新页面
                    saveLanguagePreference(newLang);
                    
                    // 获取当前URL并添加时间戳参数以确保刷新
                    const currentUrl = new URL(window.location.href);
                    currentUrl.searchParams.set('ts', Date.now());
                    window.location.href = currentUrl.toString();
                });
            });
        });
        
        // 更新当前语言显示
        function updateCurrentLanguageDisplay() {
            const currentLang = document.getElementById('currentLang');
            const currentLangText = document.getElementById('currentLangText');
            
            currentLangText.textContent = getLanguageDisplayName(document.documentElement.lang);
            
            currentLang.classList.add('no-translate');
            currentLangText.classList.add('no-translate');
        }
        
        // 初始化翻译函数
        function initializeTranslation(lang) {
            // 检查Tranzy是否可用
            if (!window.Tranzy) {
                console.warn('Tranzy翻译库未加载，跳过翻译初始化');
                return;
            }
            
            // 全局特殊术语配置
            window.specialTerms = {
                'en': { 'SPADE': 'SPADE' },
                'zh-Hans': {
                    'SPADE': 'SPADE',
                    'Peptide Details': '肽详情',
                    'General Information': '基本信息',
                    'Activity Information': '活性信息',
                    'Structural Information': '结构信息',
                    'Physicochemical Properties': '物理化学特性',
                    'Comments Information': '备注信息',
                    'Literature Information': '参考文献',
                    'Home': '首页',
                    'Search': '搜索',
                    'Tools': '工具',
                    'AMP Visualization': '抗菌肽可视化',
                    'Statistics': '统计',
                    'Source': '来源',
                    'Family': '家族',
                    'Sequence Length': '序列长度',
                    'Biological Activity': '生物活性',
                    'Gene': '基因',
                    'Sequence': '序列',
                    'UniProt Entry': 'UniProt条目',
                    'Protein Existence': '蛋白质存在性',
                    'Target Organism': '目标生物',
                    'Hemolytic Activity': '溶血活性',
                    'Cytotoxicity': '细胞毒性',
                    'Binding Target': '结合靶点',
                    'Linear/Cyclic': '线性/环状',
                    'Select a Section': '选择一个部分',
                    'Not found': '未找到',
                    'Belongs to 2025-XJTLU-Software': '属于2025-XJTLU-Software团队',
                    'Formula': '分子式',
                    'Absent Amino Acids': '缺失氨基酸',
                    'Common Amino Acids': '常见氨基酸',
                    'Mass': '质量',
                    'PI': '等电点',
                    'Basic Residues': '碱性残基',
                    'Acidic Residues': '酸性残基',
                    'Hydrophobic Residues': '疏水残基',
                    'Net Charge': '净电荷',
                    'Boman Index': 'Boman指数',
                    'Hydrophobicity': '疏水性',
                    'Aliphatic Index': '脂肪族指数',
                    'Half Life': '半衰期',
                    'Extinction Coefficient Cystines': '消光系数(含半胱氨酸)',
                    'Absorbance 280nm': '280nm吸光度',
                    'Polar Residues': '极性残基',
                    'Function': '功能',
                    'PTM': '翻译后修饰',
                    'Title': '标题',
                    'Pubmed ID': 'PubMed ID',
                    'Reference': '引用',
                    'Author': '作者',
                    'N-terminal Modification': 'N端修饰',
                    'C-terminal Modification': 'C端修饰',
                    'Nonterminal Modifications and Unusual Amino Acids': '非末端修饰和非常规氨基酸',
                    'Stereochemistry': '立体化学',
                    'Structure': '结构',
                    'Structure Description': '结构描述',
                    'Helical Wheel Diagram': '螺旋轮图',
                    'PDB ID': 'PDB编号',
                    'Predicted Structure': '预测结构',
                    'Peptide Name': '肽名称',
                    'Efficacy': '效力',
                    'Toxicity': '毒性',
                    'Stability': '稳定性',
                    'Synthesis': '合成',
                    'Original Score By Category': '各类别原始分数',
                    'Total Score': '总分',
                    'Note:': '注意：',
                    'Data loading failed': '数据加载失败',
                    'PubMed ID': 'PubMed ID',
                    'DOI': 'DOI',
                    'View Article': '查看文章',
                    'View Structure': '查看结构',
                    'No structure available': '无可用结构',
                    'Structure': '结构',
                    'Predicted Structure': '预测结构',
                    'PDB ID': 'PDB编号',
                    'Similar Sequences': '相似序列',
                    'View Details': '查看详情',
                    'SPADE ID': 'SPADE编号',
                    'Frequent Amino Acids': '常见氨基酸',
                    'Positive Residues': '正电荷残基',
                    'Negative Residues': '负电荷残基'
                },
                'zh-Hant': {
                    'SPADE': 'SPADE',
                    'Peptide Details': '肽詳情',
                    'General Information': '基本信息',
                    'Activity Information': '活性信息',
                    'Structural Information': '結構信息',
                    'Physicochemical Properties': '物理化學特性',
                    'Comments Information': '備註信息',
                    'Literature Information': '參考文獻',
                    'Home': '首頁',
                    'Search': '搜索',
                    'Tools': '工具',
                    'AMP Visualization': '抗菌肽可視化',
                    'Statistics': '統計',
                    'Source': '來源',
                    'Family': '家族',
                    'Sequence Length': '序列長度',
                    'Biological Activity': '生物活性',
                    'Gene': '基因',
                    'Sequence': '序列',
                    'UniProt Entry': 'UniProt條目',
                    'Protein Existence': '蛋白質存在性',
                    'Target Organism': '目標生物',
                    'Hemolytic Activity': '溶血活性',
                    'Cytotoxicity': '細胞毒性',
                    'Binding Target': '結合靶點',
                    'Linear/Cyclic': '線性/環狀',
                    'Select a Section': '選擇一個部分',
                    'Not found': '未找到',
                    'Belongs to 2025-XJTLU-Software': '屬於2025-XJTLU-Software團隊',
                    'Formula': '分子式',
                    'Absent Amino Acids': '缺失氨基酸',
                    'Common Amino Acids': '常見氨基酸',
                    'Mass': '質量',
                    'PI': '等電點',
                    'Basic Residues': '鹼性殘基',
                    'Acidic Residues': '酸性殘基',
                    'Hydrophobic Residues': '疏水殘基',
                    'Net Charge': '淨電荷',
                    'Boman Index': 'Boman指數',
                    'Hydrophobicity': '疏水性',
                    'Aliphatic Index': '脂肪族指數',
                    'Half Life': '半衰期',
                    'Extinction Coefficient Cystines': '消光係數(含半胱氨酸)',
                    'Absorbance 280nm': '280nm吸光度',
                    'Polar Residues': '極性殘基',
                    'Function': '功能',
                    'PTM': '翻譯後修飾',
                    'Title': '標題',
                    'Pubmed ID': 'PubMed ID',
                    'Reference': '引用',
                    'Author': '作者',
                    'N-terminal Modification': 'N端修飾',
                    'C-terminal Modification': 'C端修飾',
                    'Nonterminal Modifications and Unusual Amino Acids': '非末端修飾和非常規氨基酸',
                    'Stereochemistry': '立體化學',
                    'Structure': '結構',
                    'Structure Description': '結構描述',
                    'Helical Wheel Diagram': '螺旋輪圖',
                    'PDB ID': 'PDB编号',
                    'Predicted Structure': '預測結構',
                    'Peptide Name': '肽名稱',
                    'Efficacy': '效力',
                    'Toxicity': '毒性',
                    'Stability': '穩定性',
                    'Synthesis': '合成',
                    'Original Score By Category': '各類別原始分數',
                    'Total Score': '總分',
                    'Note:': '注意：',
                    'Data loading failed': '數據加載失敗',
                    'PubMed ID': 'PubMed ID',
                    'DOI': 'DOI',
                    'View Article': '查看文章',
                    'View Structure': '查看结构',
                    'No structure available': '无可用结构',
                    'Structure': '结构',
                    'Predicted Structure': '预测结构',
                    'PDB ID': 'PDB编号',
                    'Similar Sequences': '相似序列',
                    'View Details': '查看詳情',
                    'SPADE ID': 'SPADE編號',
                    'Frequent Amino Acids': '常見氨基酸',
                    'Positive Residues': '正電荷殘基',
                    'Negative Residues': '負電荷殘基'
                },
                'ja': {
                    'SPADE': 'SPADE',
                    'Peptide Details': 'ペプチド詳細',
                    'General Information': '基本情報',
                    'Activity Information': '活性情報',
                    'Structural Information': '構造情報',
                    'Physicochemical Properties': '物理化学的特性',
                    'Comments Information': '備考情報',
                    'Literature Information': '参考文献',
                    'Home': 'ホーム',
                    'Search': '検索',
                    'Tools': 'ツール',
                    'AMP Visualization': '抗菌ペプチド可視化',
                    'Statistics': '統計',
                    'Source': '出典',
                    'Family': 'ファミリー',
                    'Sequence Length': '配列長',
                    'Biological Activity': '生物活性',
                    'Gene': '遺伝子',
                    'Sequence': '配列',
                    'UniProt Entry': 'UniProtエントリー',
                    'Select a Section': 'セクションを選択',
                    'Not found': '見つかりません',
                    'Belongs to 2025-XJTLU-Software': '2025-XJTLU-Softwareチームに属しています',
                    'Target Organism': '標的生物',
                    'Peptide Name': 'ペプチド名',
                    'Efficacy': '効力',
                    'Toxicity': '毒性',
                    'Stability': '安定性',
                    'Synthesis': '合成',
                    'Original Score By Category': 'カテゴリー別元スコア',
                    'Total Score': '合計スコア',
                    'Note:': '注意：',
                    'Data loading failed': 'データの読み込みに失敗しました',
                    'PubMed ID': 'PubMed ID',
                    'DOI': 'DOI',
                    'View Article': '查看文章',
                    'Author': '作者',
                    'Title': '标题',
                    'Reference': '引用',
                    'View Structure': '查看结构',
                    'No structure available': '无可用结构',
                    'Structure': '结构',
                    'Predicted Structure': '预测结构',
                    'PDB ID': 'PDB编号'
                },
                'ko': { 'SPADE': 'SPADE' },
                'fr': { 'SPADE': 'SPADE' },
                'de': { 'SPADE': 'SPADE' },
                'es': { 'SPADE': 'SPADE' },
                'ru': { 'SPADE': 'SPADE' }
            };
            
            try {
                const tranzy = new Tranzy.Translator({
                    toLang: lang,
                    fromLang: 'en',
                    ignore: ['.no-translate', '.sequence'],
                    manualDict: window.specialTerms
                });
                
                tranzy.translatePage();
                tranzy.startObserver();
                
                // 将翻译实例保存到全局变量，以便之后销毁
                window.tranzyInstance = tranzy;
            } catch (error) {
                console.warn('翻译初始化失败:', error);
            }
        }

        // 图片懒加载优化
        class LazyLoader {
            constructor() {
                this.observer = new IntersectionObserver(this.handleIntersection.bind(this), {
                    rootMargin: '50px'
                });
            }

            handleIntersection(entries) {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        if (img.dataset.src) {
                            img.src = img.dataset.src;
                            img.removeAttribute('data-src');
                            this.observer.unobserve(img);
                        }
                    }
                });
            }

            observe(element) {
                this.observer.observe(element);
            }
        }

        const lazyLoader = new LazyLoader();

        // 性能优化：防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 性能优化：节流函数
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }

        // 优化的响应式布局增强脚本
        document.addEventListener('DOMContentLoaded', function() {
            // 移动端导航功能由 header-nav.js 组件处理
            
            // 预加载关键资源
            preloadCriticalResources();
        });

        // 预加载关键资源
        function preloadCriticalResources() {
            // 预加载CSS中使用的关键字体
            const fontPreload = document.createElement('link');
            fontPreload.rel = 'preload';
            fontPreload.href = 'https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900&display=swap';
            fontPreload.as = 'style';
            fontPreload.onload = function() {
                this.onload = null;
                this.rel = 'stylesheet';
            };
            document.head.appendChild(fontPreload);

            // 预连接到可能的外部域
            const preconnectLinks = [
                'https://unpkg.com',
                'https://cdnjs.cloudflare.com',
                'https://www.rcsb.org',
                'https://pubmed.ncbi.nlm.nih.gov'
            ];

            preconnectLinks.forEach(href => {
                const link = document.createElement('link');
                link.rel = 'preconnect';
                link.href = href;
                document.head.appendChild(link);
            });
        }
    </script>
</body>
</html>
