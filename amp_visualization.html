<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="css/translation-component.css">
    <script src="js/translation-component.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPADE AMP Visualization</title>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="shortcut icon" href="source/img/favicon.ico">
    <script src="https://unpkg.com/tranzy/dist/tranzy.umd.js"></script>
    <!-- 快速笔记组件 -->
    <script src="js/quick-notes.js"></script>
    <!-- 阅读进度组件 -->
    <script src="js/reading-progress.js"></script>
    <!-- 引入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 导入Google字体 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        /* 全局样式重置 */
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: white;
            font-size: 1.5em;
            font-weight: 600;
        }
        
        .logo img {
            margin-right: 10px;
        }
    
        /* 页面特定样式 - 增强渐变背景 */
        body.visualization-page {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #2b1055 50%, #1a0d3a 75%, #0f051a 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: #fff;
            position: relative;
        }
        
        /* 动态背景动画 */
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* 背景装饰元素 */
        body.visualization-page::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        /* 添加侧边栏链接悬停样式 */
        #sidebar .nav-link:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            color: #fff;
            font-weight: 500;
            transition: all 0.3s ease;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .main-content {
            padding-top: 80px;
        }
        
        .back-button-container {
            position: fixed;
            z-index: 9527;
            margin: 40px 0;
            padding: 0 20px;
        }
        
        .back-button {
            display: inline-flex;
            align-items: center;
            padding: 12px 24px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.1));
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
            z-index: 5;
            position: relative;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .back-button:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.2));
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
        }
        
        .back-button i {
            margin-right: 8px;
        }
        
        .viz-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            width: 100%;
            padding: 30px;
        }

        /* 玻璃拟态卡片设计 */
        .viz-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(20px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1), 
                        0 5px 15px rgba(0, 0, 0, 0.05),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
            color: #fff;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        /* 卡片悬停效果 */
        .viz-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15), 
                        0 10px 25px rgba(0, 0, 0, 0.1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        /* 卡片内部发光效果 */
        .viz-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        }

        .viz-card h3 {
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 1.5em;
            font-weight: 600;
            color: #fff;
            text-align: center;
            position: relative;
            padding-bottom: 15px;
        }
        
        /* 标题装饰线 */
        .viz-card h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
        }

        .page-title {
            text-align: center;
            color: #fff;
            margin: 40px 0;
            font-size: 2.5em;
            font-weight: 700;
            text-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #fff, #e0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .peptide-info {
            color: #fff;
        }

        .peptide-info p {
            margin: 12px 0;
            line-height: 1.6;
        }

        .peptide-info strong {
            font-weight: 600;
            margin-right: 8px;
            color: rgba(255, 255, 255, 0.9);
        }

        .peptide-basic-info {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .peptide-score-summary {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .score-summary-item {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.1));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px 20px;
            flex: 1;
            min-width: 160px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .score-summary-item:hover {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2));
            transform: translateY(-2px);
        }

        .score-summary-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9em;
            font-weight: 500;
        }

        .score-summary-value {
            font-weight: 700;
            font-size: 1.2em;
            padding: 6px 12px;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .score-summary-category {
            color: #7597de;
            font-weight: 600;
            background: linear-gradient(135deg, rgba(117, 151, 222, 0.3), rgba(117, 151, 222, 0.1));
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid rgba(117, 151, 222, 0.3);
        }

        .sequence-display {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2));
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
            word-break: break-all;
            font-size: 0.95em;
            line-height: 1.6;
            color: #fff;
            position: relative;
            padding-right: 50px;
            backdrop-filter: blur(10px);
        }

        .copy-button {
            position: absolute;
            top: 12px;
            right: 12px;
            background: linear-gradient(135deg, rgba(117, 151, 222, 0.3), rgba(117, 151, 222, 0.1));
            border: 1px solid rgba(117, 151, 222, 0.4);
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .copy-button:hover {
            background: linear-gradient(135deg, rgba(117, 151, 222, 0.5), rgba(117, 151, 222, 0.3));
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(117, 151, 222, 0.3);
        }
        
        .copy-tooltip {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.7));
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            opacity: 0;
            transform: translateY(5px);
            pointer-events: none;
            transition: all 0.3s ease;
            white-space: nowrap;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .copy-button.show-tooltip .copy-tooltip {
            opacity: 1;
            transform: translateY(0);
        }

        .activity-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            color: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .activity-table th, .activity-table td {
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px 15px;
            text-align: left;
        }

        .activity-table th {
            background: linear-gradient(135deg, rgba(43, 16, 85, 0.8), rgba(43, 16, 85, 0.6));
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }
        
        .activity-table td {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
        }

        .activity-level {
            display: flex;
            align-items: center;
        }

        .activity-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        
        .mic-value {
            color: #81D4FA;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(129, 212, 250, 0.3);
        }
        
        .no-activity {
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
        }

        .activity-note {
            font-style: italic;
            margin-top: 15px;
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
            padding: 10px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            border-radius: 8px;
            border-left: 3px solid rgba(117, 151, 222, 0.5);
        }

        .total-score-display {
            text-align: center;
            font-size: 3.5em;
            font-weight: 800;
            margin: 30px 0;
            color: #fff;
            position: relative;
            z-index: 1;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .score-label-description {
            text-align: center;
            font-size: 1em;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        /* 评分颜色分类 - 增加发光效果 */
        .score-excellent {
            color: #00C853;
            text-shadow: 0 0 20px rgba(0, 200, 83, 0.6), 0 0 40px rgba(0, 200, 83, 0.3);
        }
        
        .score-good {
            color: #64DD17;
            text-shadow: 0 0 20px rgba(100, 221, 23, 0.6), 0 0 40px rgba(100, 221, 23, 0.3);
        }
        
        .score-above-average {
            color: #AEEA00;
            text-shadow: 0 0 20px rgba(174, 234, 0, 0.6), 0 0 40px rgba(174, 234, 0, 0.3);
        }
        
        .score-average {
            color: #FFD600;
            text-shadow: 0 0 20px rgba(255, 214, 0, 0.6), 0 0 40px rgba(255, 214, 0, 0.3);
        }
        
        .score-below-average {
            color: #FFAB00;
            text-shadow: 0 0 20px rgba(255, 171, 0, 0.6), 0 0 40px rgba(255, 171, 0, 0.3);
        }
        
        .score-fair {
            color: #FF6D00;
            text-shadow: 0 0 20px rgba(255, 109, 0, 0.6), 0 0 40px rgba(255, 109, 0, 0.3);
        }
        
        .score-poor {
            color: #FF3D00;
            text-shadow: 0 0 20px rgba(255, 61, 0, 0.6), 0 0 40px rgba(255, 61, 0, 0.3);
        }
        
        .score-very-poor {
            color: #DD2C00;
            text-shadow: 0 0 20px rgba(221, 44, 0, 0.6), 0 0 40px rgba(221, 44, 0, 0.3);
        }

        /* 生物活性和文献样式 */
        .bioactivity-list {
            color: #fff;
            padding-left: 25px;
            margin-bottom: 20px;
        }
        
        .bioactivity-list li {
            margin-bottom: 10px;
            line-height: 1.6;
            position: relative;
        }
        
        .bioactivity-list li::marker {
            color: #7597de;
        }
        
        .empty-info {
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            border-radius: 12px;
            border: 1px dashed rgba(255, 255, 255, 0.2);
        }
        
        .literature-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }
        
        .literature-item {
            display: flex;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .literature-item:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.06));
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .lit-number {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(43, 16, 85, 0.9), rgba(43, 16, 85, 0.7));
            color: white;
            font-weight: 700;
            min-width: 50px;
            padding: 0 15px;
            font-size: 1.1em;
        }
        
        .lit-content {
            padding: 20px 25px;
            color: #fff;
            width: 100%;
        }
        
        .lit-authors {
            font-size: 0.95em;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }
        
        .lit-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1.05em;
            line-height: 1.4;
        }
        
        .lit-journal {
            font-style: italic;
            font-size: 0.9em;
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .lit-doi, .lit-pubmed {
            font-size: 0.85em;
            margin-top: 5px;
        }
        
        .lit-doi a, .lit-pubmed a {
            color: #7597de;
            text-decoration: none;
            font-weight: 500;
        }
        
        .lit-doi a:hover, .lit-pubmed a:hover {
            text-decoration: underline;
            color: #9bb3f0;
        }
        
        /* 文献按钮样式 */
        .lit-buttons {
            display: flex;
            gap: 12px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .lit-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 18px;
            background: linear-gradient(135deg, rgba(117, 151, 222, 0.3), rgba(117, 151, 222, 0.1));
            border: 1px solid rgba(117, 151, 222, 0.4);
            border-radius: 25px;
            color: #fff;
            font-size: 0.85em;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            backdrop-filter: blur(10px);
        }
        
        .lit-button:hover {
            background: linear-gradient(135deg, rgba(117, 151, 222, 0.5), rgba(117, 151, 222, 0.3));
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(117, 151, 222, 0.3);
        }
        
        .lit-button i {
            margin-right: 6px;
            font-size: 1em;
        }

        .score-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            transition: all 0.3s ease;
        }

        .score-label:last-child {
            border-bottom: none;
        }
        
        .score-label:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            border-radius: 8px;
            padding-left: 10px;
            padding-right: 10px;
        }

        .score-name {
            font-weight: 500;
        }

        .score-value {
            font-weight: 700;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            padding: 4px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .loading-indicator {
            text-align: center;
            padding: 60px;
            color: #fff;
            font-size: 1.2em;
        }

        .loading-indicator i {
            font-size: 3em;
            margin-bottom: 20px;
            display: block;
            animation: spin 1.5s linear infinite;
            color: #7597de;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: linear-gradient(135deg, rgba(255, 99, 71, 0.3), rgba(255, 99, 71, 0.1));
            border: 1px solid rgba(255, 99, 71, 0.5);
            color: #fff;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin: 40px auto;
            max-width: 700px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(255, 99, 71, 0.2);
        }

        .viz-card-full {
            grid-column: 1 / -1;
        }

        /* 响应式设计优化 */
        @media (max-width: 768px) {
            .viz-container {
                grid-template-columns: 1fr;
                padding: 15px;
                gap: 20px;
            }
            
            .page-title {
                font-size: 2em;
                margin: 30px 0;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .viz-card {
                padding: 20px;
                border-radius: 15px;
            }
            
            .score-summary-item {
                min-width: 140px;
                padding: 12px 15px;
            }
            
            .total-score-display {
                font-size: 2.5em;
            }
        }

        /* 仪表盘指针样式 - 删除 */
        .gauge-pointer-container {
            display: none;
        }
        
        .gauge-pointer {
            display: none;
        }
        
        .gauge-pointer::after {
            display: none;
        }

        /* 统计数据样式增强 */
        .statistics-container {
            position: relative;
            width: 100%;
        }
        
        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            width: 100%;
        }
        
        .statistics-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(20px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .statistics-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 45px rgba(0, 0, 0, 0.15);
        }
        
        .statistics-item h4 {
            text-align: center;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.2em;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            border-radius: 12px;
            padding: 15px;
        }
        
        .data-source-note {
            text-align: center;
            margin-top: 15px;
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
        }

        /* 语言选择器相关样式增强 */
        .language-selector {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 1000;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        /* 阅读进度和返回顶部组件样式已移至 js/reading-progress.js */

        .language-current {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 8px 15px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .language-current i {
            margin-right: 5px;
        }

        .language-current:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .language-options {
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(43, 16, 85, 0.9);
            border-radius: 10px;
            width: 150px;
            margin-top: 10px;
            padding: 10px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .language-selector:hover .language-options {
            display: flex;
        }

        .language-option {
            padding: 8px 15px;
            color: white;
            text-decoration: none;
            transition: background 0.2s ease;
            text-align: left;
        }

        .language-option:hover, .language-option.active {
            background: rgba(117, 151, 222, 0.3);
        }

        .language-option.active {
            font-weight: bold;
        }

        /* 氨基酸频率分析卡片样式 */
        .amino-freq-container {
            margin-top: 15px;
        }
        
        /* 确保频率图表始终保持适当高度 */
        #amino-acid-freq-chart {
            min-height: 250px;
        }

        /* 快速笔记按钮样式 - 简约版 */
        .notes-trigger {
            transition: opacity 0.2s ease;
        }

        .notes-trigger:hover {
            opacity: 0.8;
        }

        .notes-trigger i {
            font-size: 16px;
            color: white;
        }

        /* 详细评分分析卡片样式 */
        .scoring-analysis-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .dimension-analysis {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid rgba(117, 151, 222, 0.6);
        }

        .dimension-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .dimension-title {
            color: #fff;
            margin: 0;
            font-size: 1.1em;
            font-weight: 600;
        }

        .dimension-scores {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .raw-score {
            font-weight: bold;
            font-size: 1.1em;
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.2);
        }

        .weight-info {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85em;
        }

        .weighted-score {
            font-weight: bold;
            color: #7597de;
            background: rgba(117, 151, 222, 0.2);
            padding: 4px 8px;
            border-radius: 6px;
        }

        .dimension-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            font-size: 0.9em;
        }

        .detail-key {
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .detail-value {
            color: #fff;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* 增强的详细项目样式 */
        .positive-item {
            background: rgba(76, 175, 80, 0.1);
            border-left: 3px solid #4CAF50;
            padding-left: 12px;
        }

        .negative-item {
            background: rgba(244, 67, 54, 0.1);
            border-left: 3px solid #F44336;
            padding-left: 12px;
        }

        .positive-item .detail-value {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }

        .negative-item .detail-value {
            background: rgba(244, 67, 54, 0.2);
            color: #F44336;
        }

        /* 评分特征卡片样式 */
        .features-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .feature-group {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid rgba(75, 192, 192, 0.6);
        }

        .feature-group-title {
            color: #fff;
            margin: 0 0 15px 0;
            font-size: 1.1em;
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 8px;
        }

        .feature-group-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .feature-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            font-size: 0.9em;
        }

        .feature-key {
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .feature-value {
            color: #fff;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .scoring-metadata {
            background: rgba(43, 16, 85, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
        }

        .metadata-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 0.85em;
        }

        .metadata-key {
            color: rgba(255, 255, 255, 0.7);
        }

        .metadata-value {
            color: #fff;
            font-weight: 500;
        }

        /* 相似肽段样式 */
        .similar-peptides-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }
        
        .similar-peptide-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid rgba(117, 151, 222, 0.6);
            transition: all 0.3s ease;
        }
        
        .similar-peptide-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .similar-peptide-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .similar-peptide-info h4 {
            margin: 0 0 5px 0;
            color: #fff;
            font-size: 1.1em;
        }
        
        .similar-peptide-id {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
        }
        
        .similar-peptide-similarity {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .similarity-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9em;
        }
        
        .similarity-value {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .similar-peptide-sequence {
            margin: 10px 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }
        
        .sequence-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9em;
            margin-right: 8px;
        }
        
        .sequence-text {
            font-family: monospace;
            color: #fff;
            font-size: 0.9em;
            word-break: break-all;
        }
        
        .similar-peptide-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }
        
        .peptide-link-btn {
            background: rgba(117, 151, 222, 0.2);
            border: 1px solid rgba(117, 151, 222, 0.5);
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .peptide-link-btn:hover {
            background: rgba(117, 151, 222, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .peptide-link-btn i {
            font-size: 0.9em;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .dimension-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .dimension-details {
                grid-template-columns: 1fr;
            }
            
            .feature-group-content {
                grid-template-columns: 1fr;
            }
            
            .detail-item, .feature-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .similar-peptide-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .similar-peptide-actions {
                justify-content: flex-start;
            }
        }
    </style>
    <link rel="stylesheet" type="text/css" href="css/amp_visualization_minimal.css">
</head>
<body class="visualization-page">
    <!-- 阅读进度和返回顶部组件将由 js/reading-progress.js 自动创建 -->

    <header>
        <div class="logo-container">
            <a href="#" class="logo">
                <img src="./source/img/logo.png" style="vertical-align: middle; height: 30px;">
                SPADE
            </a>
            <div style="color: white; font-size: 0.6em;">System for Antimicrobial Peptide<br>Management and Database</div>
            <!-- <a href="https://2025.igem.wiki/xjtlu-software" class="team-link" target="_blank" rel="noopener noreferrer">Belongs to 2025-XJTLU-Software</a> -->
        </div>
        <button class="nav-toggle" aria-label="Toggle navigation">
            <i class="fas fa-bars"></i>
        </button>
        <ul class="nav-menu">
            <li><a href="home.html">Home</a></li>
            <li><a href="search.html">Search</a></li>
            <li><a href="tools.html">Tools</a></li>
            <li><a href="statistics.html">Statistics</a></li>
            <li><a href="#" id="quick-notes-btn" class="notes-trigger" title="快速笔记 (Ctrl+Shift+N)">
                <i class="fas fa-sticky-note"></i>
            </a></li>
            <!-- <li><a href="chat.html" >Chat</a></li>
            <li><a href="login.html">Login</a></li> -->
        </ul>
    </header>

    <!-- 语言选择器
    <div class="language-selector">
        <div class="language-current" id="currentLang">
            <i class="fas fa-globe"></i>
            <span id="currentLangText">English</span>
        </div>
        <div class="language-options">
            <a href="#" data-lang="en" class="language-option">English</a>
            <a href="#" data-lang="zh-Hans" class="language-option">中文 (简体)</a>
            <a href="#" data-lang="zh-Hant" class="language-option">繁體中文</a>
            <a href="#" data-lang="ja" class="language-option">日本語</a>
            <a href="#" data-lang="ko" class="language-option">한국어</a>
            <a href="#" data-lang="fr" class="language-option">Français</a>
            <a href="#" data-lang="de" class="language-option">Deutsch</a>
            <a href="#" data-lang="es" class="language-option">Español</a>
            <a href="#" data-lang="ru" class="language-option">Русский</a>
        </div>
    </div> -->

    <div class="main-content">
        <div class="back-button-container">
            <button class="back-button" onclick="window.location.href='search.html';">
                <i class="fas fa-arrow-left"></i>
                <span class="back-button-text">Back to search</span>
            </button>
            <!-- <button class="back-button" onclick="goToSearch()" style="margin-left: 10px;">
                <i class="fas fa-search"></i>
                <span class="search-button-text"</span>
            </button> -->
        </div>
        <h1 id="peptideTitle" class="page-title">AMP Visualization</h1>
        
        <div id="viz-container" class="viz-container">
            <!-- 动态内容将在这里生成 -->
            <div class="loading-indicator">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading visualization data...</p>
            </div>
        </div>
    </div>

    <script>
        // --- 高效的数据查找辅助函数 ---
        class DataFinder {
            constructor(data) {
                this.data = data;
                this.cache = new Map();
                this.pathCache = new Map();
                this.initializeFieldMap();
            }

            // 初始化字段映射，预计算常用字段路径
            initializeFieldMap() {
                this.fieldPaths = new Map();
                this.flattenData(this.data, []);
            }

            // 展平数据结构，建立字段路径映射
            flattenData(obj, path) {
                if (obj === null || obj === undefined) return;

                if (Array.isArray(obj)) {
                    obj.forEach((item, index) => {
                        this.flattenData(item, [...path, index]);
                    });
                } else if (typeof obj === 'object') {
                    Object.entries(obj).forEach(([key, value]) => {
                        const currentPath = [...path, key];
                        
                        // 存储字段路径
                        if (!this.fieldPaths.has(key)) {
                            this.fieldPaths.set(key, []);
                        }
                        this.fieldPaths.get(key).push({
                            path: currentPath,
                            value: value
                        });

                        // 递归处理嵌套对象
                        if (value && typeof value === 'object') {
                            this.flattenData(value, currentPath);
                        }
                    });
                }
            }

            // 高效查找字段值
            findValue(targetKey) {
                // 检查缓存
                if (this.cache.has(targetKey)) {
                    return this.cache.get(targetKey);
                }

                let result = null;

                // 首先尝试直接字段匹配
                if (this.fieldPaths.has(targetKey)) {
                    const matches = this.fieldPaths.get(targetKey);
                    if (matches.length > 0) {
                        // 返回第一个匹配的值
                        result = matches[0].value;
                    }
                }

                // 如果没找到，尝试大小写不敏感匹配
                if (result === null) {
                    const lowerKey = targetKey.toLowerCase();
                    for (const [key, matches] of this.fieldPaths.entries()) {
                        if (key.toLowerCase() === lowerKey && matches.length > 0) {
                            result = matches[0].value;
                            break;
                        }
                    }
                }

                // 如果还是没找到，尝试包含匹配
                if (result === null) {
                    const searchKey = targetKey.toLowerCase();
                    for (const [key, matches] of this.fieldPaths.entries()) {
                        if (key.toLowerCase().includes(searchKey) && matches.length > 0) {
                            result = matches[0].value;
                            break;
                        }
                    }
                }

                // 缓存结果
                this.cache.set(targetKey, result);
                return result;
            }

            // 获取数据路径
            getValuePath(targetKey) {
                if (this.pathCache.has(targetKey)) {
                    return this.pathCache.get(targetKey);
                }

                if (this.fieldPaths.has(targetKey)) {
                    const matches = this.fieldPaths.get(targetKey);
                    if (matches.length > 0) {
                        const path = matches[0].path;
                        this.pathCache.set(targetKey, path);
                        return path;
                    }
                }

                return null;
            }

            // 获取所有匹配的值
            findAllValues(targetKey) {
                const lowerKey = targetKey.toLowerCase();
                const results = [];

                for (const [key, matches] of this.fieldPaths.entries()) {
                    if (key.toLowerCase() === lowerKey) {
                        results.push(...matches.map(m => m.value));
                    }
                }

                return results;
            }

            // 检查字段是否存在
            hasField(targetKey) {
                return this.findValue(targetKey) !== null;
            }

            // 清理缓存
            clearCache() {
                this.cache.clear();
                this.pathCache.clear();
            }
        }

        // 全局数据查找器实例
        let globalDataFinder = null;
        
        // 数据缓存机制
        const dataCache = new Map();
        
        // 带缓存的数据加载函数
        async function loadDataWithCache(url) {
            if (dataCache.has(url)) {
                console.log('从缓存加载数据:', url);
                return dataCache.get(url);
            }
            
            console.log('首次加载数据:', url);
            const data = await loadData(url);
            dataCache.set(url, data);
            
            // 限制缓存大小（最多10个文件）
            if (dataCache.size > 10) {
                const firstKey = dataCache.keys().next().value;
                dataCache.delete(firstKey);
            }
            
            return data;
        }

        // 兼容性包装函数
        function findValueInObject(data, targetKey) {
            if (!data) return null;

            // 如果是新数据，创建新的查找器
            if (!globalDataFinder || globalDataFinder.data !== data) {
                globalDataFinder = new DataFinder(data);
            }

            return globalDataFinder.findValue(targetKey);
        }

        // 高性能数据查找函数
        function findDataField(data, fieldName) {
            if (!data || !fieldName) return null;

            // 创建临时查找器用于单次查找
            const finder = new DataFinder(data);
            return finder.findValue(fieldName);
        }

        // 快速访问常用字段
        function getQuickAccess(data) {
            const finder = new DataFinder(data);
            return {
                spadeId: finder.findValue("SPADE ID") || finder.findValue("DRAMP ID"),
                peptideName: finder.findValue("Peptide Name"),
                sequence: finder.findValue("Sequence"),
                literature: finder.findValue("Literature"),
                bioActivity: finder.findValue("Biological Activity"),
                targetOrganism: finder.findValue("Target Organism"),
                function: finder.findValue("Function"),
                mass: finder.findValue("Mass"),
                pi: finder.findValue("PI"),
                formula: finder.findValue("Formula")
            };
        }

        // --- 结束数据查找辅助函数 ---

        // --- 核心功能：获取 ID 和加载数据 ---
        function getPeptideIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const peptideId = params.get('id') || null;
            console.log('从URL获取肽ID:', peptideId);
            console.log('当前URL参数:', window.location.search);
            return peptideId;
        }

        // 加载肽数据 - 移除反爬虫组件依赖，优化加载速度
        async function loadPeptideData(peptideId) {
            console.log('开始加载肽数据，ID:', peptideId);
            
            if (!peptideId) {
                console.log('没有提供肽ID');
                const message = getLocalizedText('No peptide ID provided. Please specify a peptide ID in the URL.');
                return showError(message, true);
            }

            try {
                const dataUrl = `data/result/scored_${peptideId}.json`;
                console.log('请求数据URL:', dataUrl);
                
                const response = await fetch(dataUrl);
                console.log('响应状态:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`Failed to load data for ${peptideId}: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('主数据加载成功，数据结构:', Object.keys(data));
                
                console.log('开始渲染可视化');
                renderVisualization(data);
            } catch (error) {
                console.error('数据加载错误:', error);
                let message = getLocalizedText('Error loading data') + ': ' + error.message;
                showError(message);
            }
        }



        // 简化数据加载函数 - 移除反爬虫组件依赖
        async function loadData(url) {
            console.log('loadData: 开始加载数据', url);
            
            const response = await fetch(url);
            console.log('loadData: 响应状态', response.status);
            
            if (!response.ok) {
                throw new Error(`无法获取数据: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('loadData: 数据加载成功');
            return data;
        }

        // 获取当前语言的本地化文本
        function getLocalizedText(textKey) {
            const lang = document.documentElement.lang || 'en';
            const translations = getTranslations(lang);
            return translations[textKey] || textKey;
        }

        // 显示错误信息
        function showError(message, isWarning = false) {
            const container = document.getElementById('viz-container');
            container.innerHTML = '';
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.style.backgroundColor = isWarning ? 'rgba(255, 193, 7, 0.2)' : 'rgba(255, 99, 71, 0.2)';
            errorDiv.style.borderColor = isWarning ? 'rgba(255, 193, 7, 0.5)' : 'rgba(255, 99, 71, 0.5)';
            
            errorDiv.innerHTML = `
                <i class="fas fa-${isWarning ? 'exclamation-triangle' : 'times-circle'}" 
                   style="font-size: 2em; margin-bottom: 10px; display: block;"></i>
                <p>${message}</p>
                ${!isWarning ? '<p>' + getLocalizedText('Please check the ID and try again.') + '</p>' : ''}
            `;
            
            container.appendChild(errorDiv);
            document.getElementById('peptideTitle').textContent = isWarning ? 
                getLocalizedText('Warning') : getLocalizedText('Error Loading Data');
        }
        
        // --- 多语言支持 ---
        // 保存语言偏好
        function saveLanguagePreference(lang) {
            localStorage.setItem('preferredLanguage', lang);
        }

        // 获取保存的语言偏好
        function getLanguagePreference() {
            return localStorage.getItem('preferredLanguage') || 'en';
        }
        
        // 获取语言显示名称
        function getLanguageDisplayName(langCode) {
            const langNames = {
                'en': 'English',
                'zh-Hans': '中文 (简体)',
                'zh-Hant': '繁體中文',
                'ja': '日本語',
                'ko': '한국어',
                'fr': 'Français',
                'de': 'Deutsch',
                'es': 'Español',
                'ru': 'Русский'
            };
            return langNames[langCode] || langCode;
        }
        
        // 切换语言（已注释）
        /*
        function changeLanguage(newLang) {
            if (newLang === document.documentElement.lang) return;
            
            // 保存语言偏好
            saveLanguagePreference(newLang);
            document.documentElement.lang = newLang;
            
            // 高亮当前语言选项
            document.querySelectorAll('.language-option').forEach(option => {
                if (option.getAttribute('data-lang') === newLang) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
            
            // 更新语言显示
            const currentLangText = document.getElementById('currentLangText');
            if (currentLangText) {
                currentLangText.textContent = getLanguageDisplayName(newLang);
            }
            
            // 刷新界面文本
            updatePageTexts();
            
            // 更新界面组件
            updateUIComponents();
        }
        */
        
        // 更新页面文本
        function updatePageTexts() {
            const lang = document.documentElement.lang;
            const translations = getTranslations(lang);
            
            // 标题和导航
            document.title = 'SPADE ' + (translations['AMP Visualization'] || 'AMP Visualization');
            
            // 更新导航菜单
            const navItems = {
                'Home': translations['Home'] || 'Home',
                'Search': translations['Search'] || 'Search',
                'Tools': translations['Tools'] || 'Tools',
                'Statistics': translations['Statistics'] || 'Statistics',
                'AMP Visualization': translations['AMP Visualization'] || 'AMP Visualization'
            };
            
            document.querySelectorAll('.nav-menu a').forEach(link => {
                const key = link.textContent.trim();
                if (navItems[key]) {
                    link.textContent = navItems[key];
                }
            });
            
            // 更新返回搜索按钮
            const backButton = document.querySelector('.back-button-text');
            if (backButton) {
                backButton.textContent = translations['Back to Search'] || 'Back to Search';
            }
            
            // 更新标题
            const title = document.getElementById('peptideTitle');
            if (title && !title.textContent.includes('Warning') && !title.textContent.includes('Error')) {
                // 提取ID部分
                const idMatch = title.textContent.match(/- ([A-Z0-9]+)$/);
                const id = idMatch ? idMatch[1] : '';
                title.textContent = (translations['AMP Visualization'] || 'AMP Visualization') + (id ? ` - ${id}` : '');
            }
            
            // 更新卡片标题
            const cardTitleMap = {
                'Peptide Information': translations['Peptide Information'],
                'Overall Score': translations['Overall Score'],
                'Scoring Profile': translations['Scoring Profile'],
                'Weighted Scores': translations['Weighted Scores'],
                'Detailed Scores': translations['Detailed Scores'],
                'Target Organism Activity': translations['Target Organism Activity'],
                'Bioactivity Details': translations['Bioactivity Details'],
                'Original Literature': translations['Original Literature'],
                'Statistics': translations['Statistics'],
                // 中文标题映射回英文，然后翻译
                '肽信息': translations['Peptide Information'],
                '总体评分': translations['Overall Score'],
                '评分概况': translations['Scoring Profile'],
                '加权评分': translations['Weighted Scores'],
                '详细评分': translations['Detailed Scores'],
                '目标生物活性': translations['Target Organism Activity'],
                '生物活性详情': translations['Bioactivity Details'],
                '原始文献': translations['Original Literature'],
                '统计数据': translations['Statistics']
            };
            
            document.querySelectorAll('.viz-card h3').forEach(header => {
                const originalText = header.textContent.trim();
                if (cardTitleMap[originalText]) {
                    header.textContent = cardTitleMap[originalText];
                }
            });
            
            // 更新评分文本
            const ratingLabel = document.querySelector('.score-label-description');
            if (ratingLabel) {
                const ratingMatch = ratingLabel.textContent.match(/([^:]+):(.*)/);
                if (ratingMatch) {
                    const ratingType = ratingMatch[1].trim();
                    const ratingValue = ratingMatch[2].trim();
                    
                    // 翻译评级类型
                    let translatedType = translations['Rating'] || 'Rating';
                    
                    // 翻译评级值
                    let translatedValue = ratingValue;
                    if (ratingValue === 'Excellent' || ratingValue === '优秀') {
                        translatedValue = translations['Excellent'] || 'Excellent';
                    } else if (ratingValue === 'Good' || ratingValue === '良好') {
                        translatedValue = translations['Good'] || 'Good';
                    } else if (ratingValue === 'Above Average' || ratingValue === '中上') {
                        translatedValue = translations['Above Average'] || 'Above Average';
                    } else if (ratingValue === 'Average' || ratingValue === '中等') {
                        translatedValue = translations['Average'] || 'Average';
                    } else if (ratingValue === 'Below Average' || ratingValue === '中下') {
                        translatedValue = translations['Below Average'] || 'Below Average';
                    } else if (ratingValue === 'Fair' || ratingValue === '一般') {
                        translatedValue = translations['Fair'] || 'Fair';
                    } else if (ratingValue === 'Poor' || ratingValue === '较差') {
                        translatedValue = translations['Poor'] || 'Poor';
                    } else if (ratingValue === 'Very Poor' || ratingValue === '差') {
                        translatedValue = translations['Very Poor'] || 'Very Poor';
                    }
                    
                    ratingLabel.textContent = `${translatedType}: ${translatedValue}`;
                }
            }
            
            // 更新肽信息标签
            const peptideInfoCard = document.querySelector('.peptide-info');
            if (peptideInfoCard) {
                const labelPairs = peptideInfoCard.querySelectorAll('p strong');
                labelPairs.forEach(label => {
                    const text = label.textContent.replace(':', '').trim();
                    if (text === 'Length' || text === 'length') {
                        label.textContent = (translations['Length'] || 'Length') + ':';
                    } else if (text === 'Cysteine Count' || text === 'cysteine count') {
                        label.textContent = (translations['Cysteine Count'] || 'Cysteine Count') + ':';
                    } else if (text === 'Disulfide Bonds' || text === 'disulfide bonds') {
                        label.textContent = (translations['Disulfide Bonds'] || 'Disulfide Bonds') + ':';
                    } else if (text === 'Sequence' || text === 'Sequence') {
                        label.textContent = (translations['Sequence'] || 'Sequence') + ':';
                    }
                });
            }
            
            // 更新复制按钮提示
            const copyButton = document.querySelector('.copy-button');
            if (copyButton) {
                copyButton.title = translations['Copy Sequence'] || 'Copy Sequence';
            }
        }
        
        // 新增：格式化评分标签
        function formatScoreLabel(key) {
            if (!key) return '';
            // 将下划线替换为空格，并将每个单词首字母大写
            return key.replace(/_/g, ' ')
                      .replace(/\b\w/g, char => char.toUpperCase());
        }
        
        // 获取翻译字典
        function getTranslations(lang) {
            // 确保lang是有效的，否则使用默认语言
            lang = lang || 'en';
            
            // 定义所有翻译
            const translations = {
                'en': {
                    'AMP Visualization': 'AMP Visualization',
                    'Home': 'Home',
                    'Search': 'Search',
                    'Tools': 'Tools',
                    'Statistics': 'Statistics',
                    'Back to Search': 'Back to Search',
                    'Peptide Information': 'Peptide Information',
                    'Overall Score': 'Overall Score',
                    'Scoring Profile': 'Scoring Profile',
                    'Weighted Scores': 'Weighted Scores',
                    'Detailed Scores': 'Detailed Scores',
                    'Target Organism Activity': 'Target Organism Activity',
                    'Bioactivity Details': 'Bioactivity Details',
                    'Original Literature': 'Original Literature',
                    'Statistics': 'Statistics',
                    'Length': 'Length',
                    'Cysteine Count': 'Cysteine Count',
                    'Disulfide Bonds': 'Disulfide Bonds',
                    'Sequence': 'Sequence',
                    'Rating': 'Rating',
                    'Copy Sequence': 'Copy Sequence',
                    'Copy Success!': 'Copy Success!',
                    'Copy Failed!': 'Copy Failed!',
                    'Excellent': 'Excellent',
                    'Good': 'Good',
                    'Above Average': 'Above Average',
                    'Average': 'Average',
                    'Below Average': 'Below Average',
                    'Fair': 'Fair',
                    'Poor': 'Poor',
                    'Very Poor': 'Very Poor',
                    'Loading visualization data...': 'Loading visualization data...',
                    'Error Loading Data': 'Error Loading Data',
                    'Warning': 'Warning',
                    'No peptide ID provided. Please specify a peptide ID in the URL.': 'No peptide ID provided. Please specify a peptide ID in the URL.',
                    'Please check the ID and try again.': 'Please check the ID and try again.',
                    'Error loading data': 'Error loading data',
                    'Access temporarily limited. Please try again in a moment.': 'Access temporarily limited. Please try again in a moment.',
                    'Loading literature data...': 'Loading literature data...',
                    'No peptide ID found': 'No peptide ID found',
                    'Literature data file not found': 'Literature data file not found',
                    'Error loading literature data': 'Error loading literature data',
                    'No literature information available for this peptide': 'No literature information available for this peptide',
                    'Unknown Authors': 'Unknown Authors',
                    'Untitled': 'Untitled',
                    'View Original': 'View Original',
                    // 新增氨基酸频率分析相关翻译
                    'Amino Acid Frequency Analysis': 'Amino Acid Frequency Analysis',
                    'Amino Acid Frequency (%)': 'Amino Acid Frequency (%)',
                    'Frequency (%)': 'Frequency (%)',
                    'Amino Acid': 'Amino Acid',
                    'Sequence Length': 'Sequence Length',
                    'amino acids': 'amino acids',
                    'count': '',
                    'Unable to analyze: sequence data not available': 'Unable to analyze: sequence data not available',
                    // 新增评分维度翻译
                    'Efficacy': 'Efficacy',
                    'Selectivity': 'Selectivity',
                    'Stability': 'Stability',
                    'Synthesis': 'Synthesis',
                    'Novelty': 'Novelty',
                    'Detailed Scoring Analysis': 'Detailed Scoring Analysis',
                    'Scoring Features': 'Scoring Features',
                    'Score': 'Score',
                    'Weighted Score': 'Weighted Score',
                    'Weight': 'Weight',
                    'Analysis Details': 'Analysis Details',
                    // 新增特征组翻译
                    'Amino Acid Composition': 'Amino Acid Composition',
                    'Physical Properties': 'Physical Properties',
                    'Hydrophobic Count': 'Hydrophobic Count',
                    'Hydrophobic Ratio': 'Hydrophobic Ratio',
                    'Hydrophilic Count': 'Hydrophilic Count',
                    'Hydrophilic Ratio': 'Hydrophilic Ratio',
                    'Positive Count': 'Positive Count',
                    'Positive Ratio': 'Positive Ratio',
                    'Negative Count': 'Negative Count',
                    'Negative Ratio': 'Negative Ratio',
                    'Aromatic Count': 'Aromatic Count',
                    'Aromatic Ratio': 'Aromatic Ratio',
                    'Cysteine Ratio': 'Cysteine Ratio',
                    'Proline Count': 'Proline Count',
                    'Proline Ratio': 'Proline Ratio',
                    'Glycine Count': 'Glycine Count',
                    'Glycine Ratio': 'Glycine Ratio',
                    'Net Charge': 'Net Charge',
                    'Hydrophobicity': 'Hydrophobicity',
                    'Amphipathicity': 'Amphipathicity',
                    'Aromaticity': 'Aromaticity',
                    'Cys Bonds Potential': 'Disulfide Bonds Potential',
                    'Flexibility': 'Flexibility',
                    // 新增评分细节翻译
                    'MIC Data': 'MIC Data',
                    'Predicted Score': 'Predicted Score',
                    'Charge Score': 'Charge Score',
                    'Hydrophobicity Score': 'Hydrophobicity Score',
                    'Length Factor': 'Length Factor',
                    'Hemolysis Data': 'Hemolysis Data',
                    'Predicted Selectivity': 'Predicted Selectivity',
                    'Hydrophobicity Penalty': 'Hydrophobicity Penalty',
                    'Charge Bonus': 'Charge Bonus',
                    'Diversity Bonus': 'Diversity Bonus',
                    'Disulfide Bonus': 'Disulfide Bonus',
                    'Proline Bonus': 'Proline Bonus',
                    'Glycine Penalty': 'Glycine Penalty',
                    'Length Score': 'Length Score',
                    'Rare Amino Acids': 'Rare Amino Acids',
                    'Rare Penalty': 'Rare Penalty',
                    'Unique Amino Acids': 'Unique Amino Acids',
                    'Repetition Bonus': 'Repetition Bonus',
                    'Disulfide Penalty': 'Disulfide Penalty',
                    'Max Similarity': 'Max Similarity',
                    'Avg Similarity': 'Avg Similarity',
                    'Novelty From Similarity': 'Novelty From Similarity',
                    'Unique Activities': 'Unique Activities',
                    'Multifunctional Bonus': 'Multifunctional Bonus',
                    'Composition Entropy': 'Composition Entropy',
                    'Composition Bonus': 'Composition Bonus',
                    'Antibacterial': 'Antibacterial',
                    'Antifungal': 'Antifungal',
                    'Antiviral': 'Antiviral',
                    'Anticancer': 'Anticancer',
                    'Hemolytic': 'Hemolytic',
                    'Target organism activity data not available': 'Target organism activity data not available',
                    'Loading peptide information...': 'Loading peptide information...',
                    'Similar Peptides': 'Similar Peptides',
                    'Loading similar peptides...': 'Loading similar peptides...',
                    'No peptide ID found for similar peptides search': 'No peptide ID found for similar peptides search',
                    'Similar peptides data file not found': 'Similar peptides data file not found',
                    'Error loading similar peptides data': 'Error loading similar peptides data',
                    'No similar peptides information available': 'No similar peptides information available',
                    'View Details': 'View Details',
                    'Similarity': 'Similarity'
                },
                'zh-Hans': {
                    'AMP Visualization': '抗菌肽可视化',
                    'Home': '首页',
                    'Search': '搜索',
                    'Tools': '工具',
                    'Statistics': '统计',
                    'Back to Search': '返回搜索',
                    'Peptide Information': '肽信息',
                    'Overall Score': '总体评分',
                    'Scoring Profile': '评分概况',
                    'Weighted Scores': '加权评分',
                    'Detailed Scores': '详细评分',
                    'Target Organism Activity': '目标生物活性',
                    'Bioactivity Details': '生物活性详情',
                    'Original Literature': '原始文献',
                    'Statistics': '统计数据',
                    'Length': '长度',
                    'Cysteine Count': '半胱氨酸数量',
                    'Disulfide Bonds': '二硫键',
                    'Sequence': '序列',
                    'Rating': '评价',
                    'Copy Sequence': '复制序列',
                    'Copy Success!': '复制成功!',
                    'Copy Failed!': '复制失败!',
                    'Excellent': '优秀',
                    'Good': '良好',
                    'Above Average': '中上',
                    'Average': '中等',
                    'Below Average': '中下',
                    'Fair': '一般',
                    'Poor': '较差',
                    'Very Poor': '差',
                    'Loading visualization data...': '正在加载可视化数据...',
                    'Error Loading Data': '加载数据错误',
                    'Warning': '警告',
                    'No peptide ID provided. Please specify a peptide ID in the URL.': '未提供肽ID，请在URL中指定肽ID。',
                    'Please check the ID and try again.': '请检查ID并重试。',
                    'Error loading data': '加载数据错误',
                    'Access temporarily limited. Please try again in a moment.': '访问暂时受限，请稍后重试',
                    'Loading literature data...': '加载文献数据...',
                    'No peptide ID found': '未找到肽ID',
                    'Literature data file not found': '文献数据文件未找到',
                    'Error loading literature data': '加载文献信息时出错',
                    'No literature information available for this peptide': '此肽的文献信息尚未添加',
                    'Unknown Authors': '未知作者',
                    'Untitled': '无标题',
                    'View Original': '查看原文',
                    // 新增氨基酸频率分析相关翻译
                    'Amino Acid Frequency Analysis': '氨基酸频率分析',
                    'Amino Acid Frequency (%)': '氨基酸频率 (%)',
                    'Frequency (%)': '频率 (%)',
                    'Amino Acid': '氨基酸',
                    'Sequence Length': '序列长度',
                    'amino acids': '氨基酸',
                    'count': '个',
                    'Unable to analyze: sequence data not available': '无法分析：序列数据不可用',
                    // 新增评分维度翻译
                    'Efficacy': '效力',
                    'Selectivity': '选择性',
                    'Stability': '稳定性',
                    'Synthesis': '合成难度',
                    'Novelty': '新颖性',
                    'Detailed Scoring Analysis': '详细评分分析',
                    'Scoring Features': '评分特征',
                    'Score': '分数',
                    'Weighted Score': '加权分数',
                    'Weight': '权重',
                    'Analysis Details': '分析详情',
                    // 新增特征组翻译
                    'Amino Acid Composition': '氨基酸组成',
                    'Physical Properties': '物理性质',
                    'Hydrophobic Count': '疏水性氨基酸数量',
                    'Hydrophobic Ratio': '疏水性比例',
                    'Hydrophilic Count': '亲水性氨基酸数量',
                    'Hydrophilic Ratio': '亲水性比例',
                    'Positive Count': '正电荷氨基酸数量',
                    'Positive Ratio': '正电荷比例',
                    'Negative Count': '负电荷氨基酸数量',
                    'Negative Ratio': '负电荷比例',
                    'Aromatic Count': '芳香族氨基酸数量',
                    'Aromatic Ratio': '芳香族比例',
                    'Cysteine Ratio': '半胱氨酸比例',
                    'Proline Count': '脯氨酸数量',
                    'Proline Ratio': '脯氨酸比例',
                    'Glycine Count': '甘氨酸数量',
                    'Glycine Ratio': '甘氨酸比例',
                    'Net Charge': '净电荷',
                    'Hydrophobicity': '疏水性',
                    'Amphipathicity': '两亲性',
                    'Aromaticity': '芳香性',
                    'Cys Bonds Potential': '二硫键潜力',
                    'Flexibility': '柔韧性',
                    // 新增评分细节翻译
                    'MIC Data': 'MIC数据',
                    'Predicted Score': '预测评分',
                    'Charge Score': '电荷评分',
                    'Hydrophobicity Score': '疏水性评分',
                    'Length Factor': '长度因子',
                    'Hemolysis Data': '溶血数据',
                    'Predicted Selectivity': '预测选择性',
                    'Hydrophobicity Penalty': '疏水性惩罚',
                    'Charge Bonus': '电荷奖励',
                    'Diversity Bonus': '多样性奖励',
                    'Disulfide Bonus': '二硫键奖励',
                    'Proline Bonus': '脯氨酸奖励',
                    'Glycine Penalty': '甘氨酸惩罚',
                    'Length Score': '长度评分',
                    'Rare Amino Acids': '稀有氨基酸',
                    'Rare Penalty': '稀有氨基酸惩罚',
                    'Unique Amino Acids': '独特氨基酸',
                    'Repetition Bonus': '重复奖励',
                    'Disulfide Penalty': '二硫键惩罚',
                    'Max Similarity': '最大相似度',
                    'Avg Similarity': '平均相似度',
                    'Novelty From Similarity': '相似度新颖性',
                    'Unique Activities': '独特活性',
                    'Multifunctional Bonus': '多功能奖励',
                    'Composition Entropy': '组成熵',
                    'Composition Bonus': '组成奖励',
                    'Antibacterial': '抗菌',
                    'Antifungal': '抗真菌',
                    'Antiviral': '抗病毒',
                    'Anticancer': '抗癌',
                    'Hemolytic': '溶血',
                    'Target organism activity data not available': '目标生物活性数据暂未提供',
                    'Loading peptide information...': '正在加载肽信息...',
                    'Similar Peptides': '相似肽段',
                    'Loading similar peptides...': '加载相似肽段数据...',
                    'No peptide ID found for similar peptides search': '未找到肽ID，无法搜索相似肽段',
                    'Similar peptides data file not found': '相似肽段数据文件未找到',
                    'Error loading similar peptides data': '加载相似肽段信息时出错',
                    'No similar peptides information available': '暂无相似肽段信息',
                    'View Details': '查看详情',
                    'Similarity': '相似度'
                },
                'zh-Hant': {
                    'AMP Visualization': '抗菌肽可視化',
                    'Home': '首頁',
                    'Search': '搜索',
                    'Tools': '工具',
                    'Statistics': '統計',
                    'Back to Search': '返回搜索',
                    'Peptide Information': '肽信息',
                    'Overall Score': '總體評分',
                    'Scoring Profile': '評分概況',
                    'Weighted Scores': '加權評分',
                    'Detailed Scores': '詳細評分',
                    'Target Organism Activity': '目標生物活性',
                    'Bioactivity Details': '生物活性詳情',
                    'Original Literature': '原始文獻',
                    'Statistics': '統計數據',
                    'Length': '長度',
                    'Cysteine Count': '半胱氨酸數量',
                    'Disulfide Bonds': '二硫鍵',
                    'Sequence': '序列',
                    'Rating': '評價',
                    'Copy Sequence': '複製序列',
                    'Copy Success!': '複製成功!',
                    'Copy Failed!': '複製失敗!',
                    'Excellent': '優秀',
                    'Good': '良好',
                    'Above Average': '中上',
                    'Average': '中等',
                    'Below Average': '中下',
                    'Fair': '一般',
                    'Poor': '較差',
                    'Very Poor': '差',
                    'Loading visualization data...': '正在加載可視化數據...',
                    'Error Loading Data': '加載數據錯誤',
                    'Warning': '警告',
                    'No peptide ID provided. Please specify a peptide ID in the URL.': '未提供肽ID，請在URL中指定肽ID。',
                    'Please check the ID and try again.': '請檢查ID並重試。',
                    'Error loading data': '加載數據錯誤',
                    'Access temporarily limited. Please try again in a moment.': '訪問暫時受限，請稍後重試',
                    'Loading literature data...': '加載文獻數據...',
                    'No peptide ID found': '未找到肽ID',
                    'Literature data file not found': '文獻數據文件未找到',
                    'Error loading literature data': '加載文獻信息時出錯',
                    'No literature information available for this peptide': '此肽的文獻信息尚未添加',
                    'Unknown Authors': '未知作者',
                    'Untitled': '無標題',
                    'View Original': '查看原文',
                    // 新增氨基酸頻率分析相關翻譯
                    'Amino Acid Frequency Analysis': '氨基酸頻率分析',
                    'Amino Acid Frequency (%)': '氨基酸頻率 (%)',
                    'Frequency (%)': '頻率 (%)',
                    'Amino Acid': '氨基酸',
                    'Sequence Length': '序列長度',
                    'amino acids': '氨基酸',
                    'count': '個',
                    'Unable to analyze: sequence data not available': '無法分析：序列數據不可用',
                    // 新增評分維度翻譯
                    'Efficacy': '效力',
                    'Selectivity': '選擇性',
                    'Stability': '穩定性',
                    'Synthesis': '合成難度',
                    'Novelty': '新穎性',
                    'Detailed Scoring Analysis': '詳細評分分析',
                    'Scoring Features': '評分特徵',
                    'Score': '分數',
                    'Weighted Score': '加權分數',
                    'Weight': '權重',
                    'Analysis Details': '分析詳情',
                    // 新增特征組翻譯
                    'Amino Acid Composition': '氨基酸組成',
                    'Physical Properties': '物理性質',
                    'Hydrophobic Count': '疏水性氨基酸數量',
                    'Hydrophobic Ratio': '疏水性比例',
                    'Hydrophilic Count': '親水性氨基酸數量',
                    'Hydrophilic Ratio': '親水性比例',
                    'Positive Count': '正電荷氨基酸數量',
                    'Positive Ratio': '正電荷比例',
                    'Negative Count': '負電荷氨基酸數量',
                    'Negative Ratio': '負電荷比例',
                    'Aromatic Count': '芳香族氨基酸數量',
                    'Aromatic Ratio': '芳香族比例',
                    'Cysteine Ratio': '半胱氨酸比例',
                    'Proline Count': '脯氨酸數量',
                    'Proline Ratio': '脯氨酸比例',
                    'Glycine Count': '甘氨酸數量',
                    'Glycine Ratio': '甘氨酸比例',
                    'Net Charge': '淨電荷',
                    'Hydrophobicity': '疏水性',
                    'Amphipathicity': '兩親性',
                    'Aromaticity': '芳香性',
                    'Cys Bonds Potential': '二硫鍵潛力',
                    'Flexibility': '柔韌性'
                },
                'es': {
                    'AMP Visualization': 'Visualización de AMP',
                    'Home': 'Inicio',
                    'Search': 'Búsqueda',
                    'Tools': 'Herramientas',
                    'Statistics': 'Estadísticas',
                    'Back to Search': 'Volver a la búsqueda',
                    'Peptide Information': 'Información del péptido',
                    'Overall Score': 'Puntuación general',
                    'Scoring Profile': 'Perfil de puntuación',
                    'Weighted Scores': 'Puntuaciones ponderadas',
                    'Detailed Scores': 'Puntuaciones detalladas',
                    'Target Organism Activity': 'Actividad sobre organismos diana',
                    'Bioactivity Details': 'Detalles de bioactividad',
                    'Original Literature': 'Literatura original',
                    'Statistics': 'Estadísticas',
                    'Length': 'Longitud',
                    'Cysteine Count': 'Recuento de cisteína',
                    'Disulfide Bonds': 'Enlaces disulfuro',
                    'Sequence': 'Secuencia',
                    'Rating': 'Valoración',
                    'Copy Sequence': 'Copiar secuencia',
                    'Copy Success!': '¡Copiado con éxito!',
                    'Copy Failed!': '¡Error al copiar!',
                    'Excellent': 'Excelente',
                    'Good': 'Bueno',
                    'Above Average': 'Por encima del promedio',
                    'Average': 'Promedio',
                    'Below Average': 'Por debajo del promedio',
                    'Fair': 'Aceptable',
                    'Poor': 'Pobre',
                    'Very Poor': 'Muy pobre',
                    // 新增氨基酸频率分析相关翻译（西班牙语）
                    'Amino Acid Frequency Analysis': 'Análisis de Frecuencia de Aminoácidos',
                    'Amino Acid Frequency (%)': 'Frecuencia de Aminoácidos (%)',
                    'Frequency (%)': 'Frecuencia (%)',
                    'Amino Acid': 'Aminoácido',
                    'Sequence Length': 'Longitud de Secuencia',
                    'amino acids': 'aminoácidos',
                    'count': '',
                    'Unable to analyze: sequence data not available': 'No se puede analizar: datos de secuencia no disponibles'
                }
            };
            
            return translations[lang] || translations['en'];
        }
        
        // 更新界面组件
        function updateUIComponents() {
            const lang = document.documentElement.lang;
            const translations = getTranslations(lang);
            
            // 更新加载提示
            const loadingText = document.querySelector('.loading-indicator p');
            if (loadingText) {
                loadingText.textContent = translations['Loading visualization data...'] || 'Loading visualization data...';
            }
        }
        
        // --- 渲染可视化 - 优化并行加载 ---
        function renderVisualization(data) {
            console.log('开始渲染可视化，数据:', data);
            
            const container = document.getElementById('viz-container');
            if (!container) {
                console.error('找不到viz-container元素');
                return;
            }
            
            container.innerHTML = ''; // 清空容器
            console.log('已清空容器');
            
            // 使用辅助函数获取数据
            const spadeId = findValueInObject(data, "SPADE ID") || findValueInObject(data, "DRAMP ID");
            const totalScore = findValueInObject(data, "total");
            const scores = findValueInObject(data, "scores") || {};
            const weightedScores = findValueInObject(data, "weighted_scores") || {};
            
            // 尝试获取目标生物体数据 - 支持多种格式
            let targetOrganisms = findValueInObject(data, "target_organisms");
            
            // 如果没有结构化的target_organisms，尝试从原始数据中解析
            if (!targetOrganisms || Object.keys(targetOrganisms).length === 0) {
                const targetOrganismStr = findValueInObject(data, "Target Organism") || 
                                        findValueInObject(data, "target_organism") ||
                                        findValueInObject(data, "_detailData.Target Organism");
                
                if (targetOrganismStr) {
                    targetOrganisms = parseTargetOrganismString(targetOrganismStr);
                    console.log('从原始字符串解析目标生物体数据:', targetOrganisms);
                }
                
                // 如果还是没有，尝试从detail数据加载
                if ((!targetOrganisms || Object.keys(targetOrganisms).length === 0) && data._detailData) {
                    const detailTargetOrganism = findValueInObject(data._detailData, "Target Organism");
                    if (detailTargetOrganism) {
                        targetOrganisms = parseTargetOrganismString(detailTargetOrganism);
                        console.log('从detail数据解析目标生物体数据:', targetOrganisms);
                    }
                }
            }
            
            // 确保有默认值
            targetOrganisms = targetOrganisms || {};
            
            console.log('提取的关键数据:', {
                spadeId,
                totalScore,
                scoresKeys: Object.keys(scores),
                weightedScoresKeys: Object.keys(weightedScores),
                targetOrganismsKeys: Object.keys(targetOrganisms)
            });
            
            // 更新标题
            document.getElementById('peptideTitle').textContent = `AMP Visualization - ${spadeId || 'Unknown ID'}`;
            console.log('已更新标题');
            
            try {
                // 阶段1：立即创建核心卡片（不依赖外部数据）
                console.log('阶段1：创建核心卡片');
                createPeptideInfoCard(container, data);
                createGaugeChartCard(container, totalScore);
                createRadarChartCard(container, scores);
                createBarChartCard(container, weightedScores);
                createDetailedScoresCard(container, scores);
                createDetailedScoringAnalysisCard(container, data);
                createScoringFeaturesCard(container, data);
                createAminoAcidFrequencyCard(container, data);
                createTargetOrganismsCardAsync(container, data, targetOrganisms);
                
                // 阶段2：延迟加载需要额外数据的卡片
                console.log('阶段2：延迟加载外部数据卡片');
                setTimeout(() => {
                    // 并行加载需要外部数据的卡片
                    Promise.allSettled([
                        createBioactivityCardAsync(container, data),
                        createLiteratureCardAsync(container, data),
                        createSimilarPeptidesCardAsync(container, data)
                    ]).then(results => {
                        console.log('所有异步卡片加载完成');
                        results.forEach((result, index) => {
                            if (result.status === 'rejected') {
                                console.warn(`异步卡片 ${index} 加载失败:`, result.reason);
                            }
                        });
                    });
                }, 100); // 100ms延迟，让核心内容先显示
                
                console.log('核心卡片创建完成');
                
                // 页面呈现后更新文本
                setTimeout(() => {
                    console.log('开始更新页面文本');
                    updatePageTexts();
                    console.log('页面文本更新完成');
                }, 200);
                
            } catch (error) {
                console.error('渲染可视化时出错:', error);
                showError('渲染可视化时出错: ' + error.message);
            }
        }
        
        // 创建肽基本信息卡片
        function createPeptideInfoCard(container, data) {
            const card = document.createElement('div');
            card.className = 'viz-card peptide-info';

            // 使用辅助函数查找数据，尝试多种可能的字段名
            const spadeId = findValueInObject(data, "SPADE ID") || findValueInObject(data, "DRAMP ID");
            let sequence = findValueInObject(data, "Sequence") || 
                          findValueInObject(data, "sequence") || 
                          findValueInObject(data, "seq") || '';
            
            // 尝试从不同的数据结构中获取序列信息
            if (!sequence) {
                const sequenceInfo = findValueInObject(data, "Sequence Information");
                if (sequenceInfo) {
                    sequence = findValueInObject(sequenceInfo, "Sequence") || 
                              findValueInObject(sequenceInfo, "sequence") || '';
                }
            }
            
            // 尝试从嵌套的detail数据中获取序列
            if (!sequence && data._detailData) {
                const peptideId = findValueInObject(data, "DRAMP ID") || findValueInObject(data, "SPADE ID");
                if (peptideId && data._detailData[peptideId]) {
                    const sequenceInfo = data._detailData[peptideId]["Sequence Information"];
                    if (sequenceInfo) {
                        sequence = sequenceInfo["Sequence"] || '';
                        console.log('从嵌套detail数据获取序列:', { hasSequence: !!sequence, length: sequence.length });
                    }
                }
            }
            
            // 尝试从features中获取序列长度来验证是否有序列信息
            const features = findValueInObject(data, "features") || {};
            const sequenceLength = features.length || features.sequence_length;
            
            console.log('序列数据检查:', {
                spadeId,
                sequence: sequence ? `${sequence.substring(0, 20)}...` : '无',
                sequenceLength,
                dataKeys: Object.keys(data)
            });
            
            const apd3Data = findValueInObject(data, "APD3") || {};
            const cysCount = findValueInObject(apd3Data, "cys_count");
            const disulfideBonds = findValueInObject(apd3Data, "disulfide_bonds");
            
            // 如果没有找到序列，尝试从detail数据中获取
            if (!sequence && spadeId) {
                loadSequenceFromDetail(card, data, spadeId);
                return;
            }
            
            // 如果有序列数据，直接创建卡片内容
            createPeptideInfoCardContent(card, data);
            container.appendChild(card);
        }
        
        // 智能识别肽ID类型并确定数据路径
        function determineDataPath(peptideId) {
            if (!peptideId) return [];
            
            const upperPeptideId = peptideId.toUpperCase();
            console.log('路径决策 - 原始ID:', peptideId, '大写ID:', upperPeptideId);
            
            // 智能识别ID格式，支持多种格式
            if (upperPeptideId.startsWith('SPADE_UN_') || upperPeptideId.startsWith('SPADE-UN-')) {
                return [
                    `data/detail/SPADE_UN/${peptideId}.json`,
                    `data/detail/SPADE_UN/${upperPeptideId}.json`,
                    `data/detail/${peptideId}.json`
                ];
            } else if (upperPeptideId.startsWith('SPADE_N_') || upperPeptideId.startsWith('SPADE-N-')) {
                return [
                    `data/detail/SPADE_N/${peptideId}.json`,
                    `data/detail/SPADE_N/${upperPeptideId}.json`,
                    `data/detail/${peptideId}.json`
                ];
            } else {
                // 通用路径，支持所有可能的位置
                return [
                    `data/detail/${peptideId}.json`,
                    `data/detail/SPADE_N/${peptideId}.json`,
                    `data/detail/SPADE_UN/${peptideId}.json`,
                    `data/detail/SPADE_N/${upperPeptideId}.json`,
                    `data/detail/SPADE_UN/${upperPeptideId}.json`
                ];
            }
        }
        
        // 从detail文件加载序列信息
        async function loadSequenceFromDetail(card, data, peptideId) {
            // 获取翻译
            const currentLang = document.documentElement.lang;
            const translations = getTranslations(currentLang);
            const peptideInfoTitle = translations['Peptide Information'] || 'Peptide Information';
            const loadingText = translations['Loading peptide information...'] || 'Loading peptide information...';
            
            // 显示加载状态
            card.innerHTML = `
                <h3>${peptideInfoTitle}</h3>
                <div class="loading-indicator">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>${loadingText}</p>
                </div>
            `;
            
            try {
                console.log('序列加载 - 开始处理肽ID:', peptideId);
                
                // 获取可能的数据路径
                const possiblePaths = determineDataPath(peptideId);
                console.log('序列加载 - 可能的路径:', possiblePaths);
                
                let detailData = null;
                let successPath = '';
                
                // 尝试所有可能的路径
                for (const path of possiblePaths) {
                    try {
                        console.log(`序列加载 - 尝试路径: ${path}`);
                        detailData = await loadDataWithCache(path);
                        successPath = path;
                        console.log(`序列加载 - 成功从 ${path} 加载详细数据`);
                        break;
                    } catch (error) {
                        console.log(`序列加载 - 路径 ${path} 失败: ${error.message}`);
                        continue;
                    }
                }
                
                if (!detailData) {
                    console.warn('序列加载 - 所有路径都无法加载详细数据');
                    throw new Error('所有路径都无法加载详细数据');
                }
                
                // 修复嵌套数据结构解析
                let sequence = '';
                let targetOrganism = '';
                
                // 尝试从嵌套结构中获取序列信息
                if (detailData[peptideId] && detailData[peptideId]["Sequence Information"]) {
                    const sequenceInfo = detailData[peptideId]["Sequence Information"];
                    sequence = sequenceInfo["Sequence"] || '';
                    targetOrganism = sequenceInfo["Target Organism"] || '';
                    console.log('序列加载 - 从嵌套结构获取信息:', {
                        hasSequence: !!sequence,
                        sequenceLength: sequence.length,
                        hasTargetOrganism: !!targetOrganism
                    });
                } else {
                    // 使用与peptide_card.html一致的字段查找逻辑
                    sequence = findValueInObject(detailData, "Sequence") || '';
                    targetOrganism = findValueInObject(detailData, "Target Organism") || '';
                    console.log('序列加载 - 从直接结构获取信息:', {
                        hasSequence: !!sequence,
                        sequenceLength: sequence.length,
                        hasTargetOrganism: !!targetOrganism
                    });
                }
                
                console.log('序列加载 - 从detail数据中提取的信息:', {
                    successPath,
                    hasSequence: !!sequence,
                    sequenceLength: sequence.length,
                    hasTargetOrganism: !!targetOrganism,
                    targetOrganismLength: targetOrganism.length,
                    detailDataKeys: Object.keys(detailData)
                });
                
                // 创建包含详细信息的完整数据对象
                const completeData = {
                    ...data,
                    "Sequence": sequence,
                    "Target Organism": targetOrganism,
                    // 保留原始detail数据以供其他组件使用
                    "_detailData": detailData
                };
                
                // 重新创建卡片
                createPeptideInfoCardContent(card, completeData);
                
            } catch (error) {
                console.error('序列加载错误:', error);
                // 即使没有序列也创建卡片
                createPeptideInfoCardContent(card, data);
            }
        }
        
        // 创建肽信息卡片内容（独立函数）
        function createPeptideInfoCardContent(card, data) {
            // 使用辅助函数查找数据
            const spadeId = findValueInObject(data, "SPADE ID") || findValueInObject(data, "DRAMP ID");
            let sequence = findValueInObject(data, "Sequence") || '';
            
            // 尝试从嵌套的detail数据中获取序列
            if (!sequence && data._detailData) {
                const peptideId = findValueInObject(data, "DRAMP ID") || findValueInObject(data, "SPADE ID");
                if (peptideId && data._detailData[peptideId]) {
                    const sequenceInfo = data._detailData[peptideId]["Sequence Information"];
                    if (sequenceInfo) {
                        sequence = sequenceInfo["Sequence"] || '';
                        console.log('createPeptideInfoCardContent - 从嵌套detail数据获取序列:', { hasSequence: !!sequence, length: sequence.length });
                    }
                }
            }
            
            const apd3Data = findValueInObject(data, "APD3") || {};
            const cysCount = findValueInObject(apd3Data, "cys_count");
            const disulfideBonds = findValueInObject(apd3Data, "disulfide_bonds");
            
            // 从新评分系统获取更多信息
            const features = findValueInObject(data, "features") || {};
            const totalScore = findValueInObject(data, "total") || 0;
            const category = findValueInObject(data, "category") || 'N/A';
            const scoringVersion = findValueInObject(data, "scoring_version") || 'N/A';

            // 获取当前语言和翻译
            const currentLang = document.documentElement.lang;
            const translations = getTranslations(currentLang);
            
            // 根据语言设置文本
            let peptideInfoTitle = translations['Peptide Information'] || 'Peptide Information';
            let lengthLabel = translations['Length'] || 'Length';
            let cysteineCountLabel = translations['Cysteine Count'] || 'Cysteine Count';
            let disulfideBondsLabel = translations['Disulfide Bonds'] || 'Disulfide Bonds';
            let sequenceLabel = translations['Sequence'] || 'Sequence';
            let copyButtonTitle = translations['Copy Sequence'] || 'Copy Sequence';
            let netChargeLabel = translations['Net Charge'] || 'Net Charge';
            let hydrophobicityLabel = translations['Hydrophobicity'] || 'Hydrophobicity';
            
            // 获取评分等级颜色
            let scoreClass = 'score-average';
            if (totalScore >= 8.5) scoreClass = 'score-excellent';
            else if (totalScore >= 7.5) scoreClass = 'score-good';
            else if (totalScore >= 6.5) scoreClass = 'score-above-average';
            else if (totalScore >= 5.5) scoreClass = 'score-average';
            else if (totalScore >= 4.5) scoreClass = 'score-below-average';
            else if (totalScore >= 3.5) scoreClass = 'score-fair';
            else if (totalScore >= 2.5) scoreClass = 'score-poor';
            else scoreClass = 'score-very-poor';
            
            card.innerHTML = `
                <h3>${peptideInfoTitle}</h3>
                <div class="peptide-basic-info">
                    <p><strong>SPADE ID:</strong> ${spadeId || 'N/A'}</p>
                    <p><strong>${lengthLabel}:</strong> ${sequence ? sequence.length + ' amino acids' : 'N/A'}</p>
                    <p><strong>${cysteineCountLabel}:</strong> ${features.cysteine_count !== undefined ? features.cysteine_count : (cysCount !== undefined && cysCount !== null ? cysCount : 'N/A')}</p>
                    <p><strong>${disulfideBondsLabel}:</strong> ${features.cys_bonds_potential !== undefined ? features.cys_bonds_potential : (disulfideBonds !== undefined && disulfideBonds !== null ? disulfideBonds : 'N/A')}</p>
                    <p><strong>${netChargeLabel}:</strong> ${features.net_charge !== undefined ? features.net_charge.toFixed(1) : 'N/A'}</p>
                    <p><strong>${hydrophobicityLabel}:</strong> ${features.hydrophobicity !== undefined ? (features.hydrophobicity * 100).toFixed(1) + '%' : 'N/A'}</p>
                </div>
                <div class="peptide-score-summary">
                    <div class="score-summary-item">
                        <span class="score-summary-label">Overall Score:</span>
                        <span class="score-summary-value ${scoreClass}">${totalScore.toFixed(2)}</span>
                    </div>
                    <div class="score-summary-item">
                        <span class="score-summary-label">Category:</span>
                        <span class="score-summary-category">${category}</span>
                    </div>
                </div>
                ${sequence ? `
                    <p><strong>${sequenceLabel}:</strong></p>
                    <div class="sequence-display">
                        ${sequence}
                        <button class="copy-button" data-sequence="${sequence}" title="${copyButtonTitle}">
                            <i class="fas fa-copy"></i>
                            <span class="copy-tooltip"></span>
                        </button>
                    </div>
                ` : `
                    <p><strong>${sequenceLabel}:</strong> <span style="color: rgba(255, 255, 255, 0.7); font-style: italic;">Sequence data not available</span></p>
                `}
            `;
            
            // 添加复制功能
            const copyButton = card.querySelector('.copy-button');
            if (copyButton) {
                copyButton.addEventListener('click', function() {
                    const sequenceText = this.getAttribute('data-sequence');
                    copyToClipboard(sequenceText, this);
                });
            }
        }
        
        // 复制文本到剪贴板
        function copyToClipboard(text, button) {
            if (!text) return;
            
            // 使用较新的剪贴板API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => showCopySuccess(button))
                    .catch(() => fallbackCopy(text, button));
            } else {
                fallbackCopy(text, button);
            }
        }
        
        // 复制文本的备用方法
        function fallbackCopy(text, button) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'absolute';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess(button);
                } else {
                    showCopyError(button);
                }
            } catch (err) {
                showCopyError(button);
            }
            
            document.body.removeChild(textarea);
        }
        
        // 显示复制成功提示
        function showCopySuccess(button) {
            const tooltip = button.querySelector('.copy-tooltip');
            if (tooltip) {
                const currentLang = document.documentElement.lang;
                const translations = getTranslations(currentLang);
                let successMessage = translations['Copy Success!'] || 'Copy Success!';
                tooltip.textContent = successMessage;
            }
            
            button.classList.add('show-tooltip');
            setTimeout(() => {
                button.classList.remove('show-tooltip');
            }, 2000);
        }
        
        // 显示复制失败提示
        function showCopyError(button) {
            const tooltip = button.querySelector('.copy-tooltip');
            if (tooltip) {
                const currentLang = document.documentElement.lang;
                const translations = getTranslations(currentLang);
                let errorMessage = translations['Copy Failed!'] || 'Copy Failed!';
                tooltip.textContent = errorMessage;
            }
            
            button.classList.add('show-tooltip');
            setTimeout(() => {
                button.classList.remove('show-tooltip');
            }, 2000);
        }
        
        // 创建雷达图卡片
        function createRadarChartCard(container, scores) {
            const card = document.createElement('div');
            card.className = 'viz-card';
            
            // 获取当前语言和翻译
            const currentLang = document.documentElement.lang;
            const translations = getTranslations(currentLang);
            
            // 获取翻译后的标题
            let scoringProfileTitle = translations['Scoring Profile'] || 'Scoring Profile';
            
            card.innerHTML = `
                <h3>${scoringProfileTitle}</h3>
                <div class="chart-container">
                    <canvas id="radarChart"></canvas>
                </div>
            `;
            
            container.appendChild(card);
            
            // 渲染雷达图
            setTimeout(() => {
                const ctx = document.getElementById('radarChart').getContext('2d');
                // 提取并翻译标签
                const labels = Object.keys(scores).map(key => {
                    const formattedKey = formatScoreLabel(key);
                    // 使用 translations 替代 dict
                    return translations[formattedKey] || formattedKey;
                });
                const dataPoints = Object.values(scores).map(v => v !== null ? v : 0);
                
                new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            // 使用 translations 替代 dict
                            label: translations['Score'] || 'Score',
                            data: dataPoints,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(75, 192, 192, 1)',
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                min: 0,
                                max: 10,
                                ticks: {
                                    stepSize: 2,
                                    backdropColor: 'rgba(0, 0, 0, 0.1)',
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.3)'
                                },
                                angleLines: {
                                    color: 'rgba(255, 255, 255, 0.3)'
                                },
                                pointLabels: {
                                    color: 'rgba(255, 255, 255, 0.9)',
                                    font: {
                                        size: 11
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.9)'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                                titleColor: 'rgba(255, 255, 255, 0.9)',
                                bodyColor: 'rgba(255, 255, 255, 0.9)',
                                displayColors: false
                            }
                        }
                    }
                });
            }, 100);
        }
        
        // 创建条形图卡片 (加权评分)
        function createBarChartCard(container, weightedScores) {
            const card = document.createElement('div');
            card.className = 'viz-card';
            
            // 获取当前语言和翻译
            const currentLang = document.documentElement.lang;
            const translations = getTranslations(currentLang);
            
            // 获取翻译后的标题
            let weightedScoresTitle = translations['Weighted Scores'] || 'Weighted Scores';
            
            card.innerHTML = `
                <h3>${weightedScoresTitle}</h3>
                <div class="chart-container">
                    <canvas id="barChart"></canvas>
                </div>
            `;
            
            container.appendChild(card);
            
            // 渲染条形图
            setTimeout(() => {
                const ctx = document.getElementById('barChart').getContext('2d');
                // 提取并翻译标签
                const labels = Object.keys(weightedScores).map(key => {
                    const formattedKey = formatScoreLabel(key);
                    // 使用 translations 替代 dict
                    return translations[formattedKey] || formattedKey;
                });
                const dataPoints = Object.values(weightedScores).map(v => v !== null ? v : 0);
                
                const colors = [
                    'rgba(255, 99, 132, 0.7)',   // 红色
                    'rgba(54, 162, 235, 0.7)',   // 蓝色
                    'rgba(255, 206, 86, 0.7)',   // 黄色
                    'rgba(75, 192, 192, 0.7)'    // 绿色
                ];
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            // 使用 translations 替代 dict
                            label: translations['Weighted Score'] || 'Weighted Score',
                            data: dataPoints,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: 2.5,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            },
                            y: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.9)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                                titleColor: 'rgba(255, 255, 255, 0.9)',
                                bodyColor: 'rgba(255, 255, 255, 0.9)',
                                displayColors: false
                            }
                        }
                    }
                });
            }, 100);
        }
        
        // 创建仪表图卡片
        function createGaugeChartCard(container, totalScore) {
            const card = document.createElement('div');
            card.className = 'viz-card';
            
            // 获取当前语言和翻译
            const currentLang = document.documentElement.lang;
            const translations = getTranslations(currentLang);
            
            // 根据分数确定评价和颜色 - 缩小区间范围
            let scoreClass = 'score-average';
            let scoreDescription = 'Average';
            
            if (totalScore >= 8.5) {
                scoreClass = 'score-excellent';
                scoreDescription = translations['Excellent'] || 'Excellent';
            } else if (totalScore >= 7.5) {
                scoreClass = 'score-good';
                scoreDescription = translations['Good'] || 'Good';
            } else if (totalScore >= 6.5) {
                scoreClass = 'score-above-average';
                scoreDescription = translations['Above Average'] || 'Above Average';
            } else if (totalScore >= 5.5) {
                scoreClass = 'score-average';
                scoreDescription = translations['Average'] || 'Average';
            } else if (totalScore >= 4.5) {
                scoreClass = 'score-below-average';
                scoreDescription = translations['Below Average'] || 'Below Average';
            } else if (totalScore >= 3.5) {
                scoreClass = 'score-fair';
                scoreDescription = translations['Fair'] || 'Fair';
            } else if (totalScore >= 2.5) {
                scoreClass = 'score-poor';
                scoreDescription = translations['Poor'] || 'Poor';
            } else {
                scoreClass = 'score-very-poor';
                scoreDescription = translations['Very Poor'] || 'Very Poor';
            }
            
            // 获取翻译后的标题和评价文本
            let overallScoreTitle = translations['Overall Score'] || 'Overall Score';
            let ratingText = translations['Rating'] || 'Rating';
            
            card.innerHTML = `
                <h3>${overallScoreTitle}</h3>
                <div class="total-score-display ${scoreClass}">${totalScore ? totalScore.toFixed(2) : 'N/A'}</div>
                <p class="score-label-description">${ratingText}: ${scoreDescription}</p>
                <div class="chart-container">
                    <canvas id="gaugeChart"></canvas>
                </div>
            `;
            
            container.appendChild(card);
            
            // 渲染仪表图
            setTimeout(() => {
                // 仪表图的渲染代码保持不变...
                const ctx = document.getElementById('gaugeChart').getContext('2d');
                const maxScore = 10;
                const normalizedScore = Math.min(totalScore || 0, maxScore);
                const remaining = maxScore - normalizedScore;
                
                // 根据分数确定颜色
                let color;
                switch(scoreClass) {
                    case 'score-excellent':
                        color = 'rgba(0, 200, 83, 1)'; // 深绿色
                        break;
                    case 'score-good':
                        color = 'rgba(100, 221, 23, 1)'; // 绿色
                        break;
                    case 'score-above-average':
                        color = 'rgba(174, 234, 0, 1)'; // 黄绿色
                        break;
                    case 'score-average':
                        color = 'rgba(255, 214, 0, 1)'; // 黄色
                        break;
                    case 'score-below-average':
                        color = 'rgba(255, 171, 0, 1)'; // 琥珀色
                        break;
                    case 'score-fair':
                        color = 'rgba(255, 109, 0, 1)'; // 橙色
                        break;
                    case 'score-poor':
                        color = 'rgba(255, 61, 0, 1)'; // 红橙色
                        break;
                    case 'score-very-poor':
                        color = 'rgba(221, 44, 0, 1)'; // 红色
                        break;
                    default:
                        color = 'rgba(255, 214, 0, 1)'; // 默认黄色
                }
                
                // 创建仪表盘图表
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [normalizedScore, remaining],
                            backgroundColor: [
                                color,
                                'rgba(255, 255, 255, 0.1)'
                            ],
                            borderWidth: 0,
                            circumference: 180,
                            rotation: 270
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: false
                            }
                        }
                    }
                });
            }, 100);
        }
        
        // 创建详细评分卡片
        function createDetailedScoresCard(container, scores) {
            const card = document.createElement('div');
            card.className = 'viz-card';
            
            // 获取当前语言和翻译
            const currentLang = document.documentElement.lang;
            const translations = getTranslations(currentLang);
            
            // 获取翻译后的标题
            let detailedScoresTitle = translations['Detailed Scores'] || 'Detailed Scores';
            
            let scoresHtml = '';
            for (const [key, value] of Object.entries(scores)) {
                const formattedKey = formatScoreLabel(key);
                // 使用 translations 替代 dict
                const translatedKey = translations[formattedKey] || formattedKey;
                
                scoresHtml += `
                    <div class="score-label">
                        <span class="score-name">${translatedKey}</span>
                        <span class="score-value">${value !== null ? value : 'N/A'}</span>
                    </div>
                `;
            }
            
            card.innerHTML = `
                <h3>${detailedScoresTitle}</h3>
                <div class="scores-container">
                    ${scoresHtml}
                </div>
            `;
            
            container.appendChild(card);
        }
        
        // 解析原始格式的Target Organism字符串
        function parseTargetOrganismString(targetOrganismStr) {
            if (!targetOrganismStr || typeof targetOrganismStr !== 'string') {
                return null;
            }
            
            console.log('解析目标生物体字符串:', targetOrganismStr);
            
            const result = {};
            let noteText = '';
            
            // 检查是否包含Note信息
            const noteMatch = targetOrganismStr.match(/Note\s*:\s*(.+)$/i);
            if (noteMatch) {
                noteText = noteMatch[1].trim();
                targetOrganismStr = targetOrganismStr.replace(/Note\s*:\s*.+$/i, '').trim();
            }
            
            // 分割不同类别的细菌
            const sections = targetOrganismStr.split(/(?:Gram-positive bacteria|Gram-negative bacteria|Fungi|Virus|Cancer cells?|Other):/i);
            const categories = targetOrganismStr.match(/(?:Gram-positive bacteria|Gram-negative bacteria|Fungi|Virus|Cancer cells?|Other):/gi);
            
            if (categories && sections.length > 1) {
                // 有明确分类的情况
                categories.forEach((category, index) => {
                    if (sections[index + 1]) {
                        const categoryName = category.replace(':', '').trim();
                        const organisms = sections[index + 1]
                            .split(/[,;]/)
                            .map(org => org.trim())
                            .filter(org => org.length > 0)
                            .map(org => ({
                                name: org,
                                activity: 'Active' // 默认活性
                            }));
                        
                        if (organisms.length > 0) {
                            result[categoryName] = organisms;
                        }
                    }
                });
            } else {
                // 没有明确分类，作为一般细菌处理
                const organisms = targetOrganismStr
                    .split(/[,;]/)
                    .map(org => org.trim())
                    .filter(org => org.length > 0 && !org.match(/^(Gram-positive|Gram-negative|Note)/i))
                    .map(org => ({
                        name: org,
                        activity: 'Active' // 默认活性
                    }));
                
                if (organisms.length > 0) {
                    result['Target Organisms'] = organisms;
                }
            }
            
            // 添加Note信息
            if (noteText) {
                result['Note'] = [{ name: noteText }];
            }
            
            console.log('解析结果:', result);
            return result;
        }
        
        // 异步创建目标生物活性卡片
        async function createTargetOrganismsCardAsync(container, data, initialTargetOrganisms) {
            const card = document.createElement('div');
            card.className = 'viz-card viz-card-full';
            
            // 获取当前语言翻译
            const currentLang = document.documentElement.lang;
            const translations = getTranslations(currentLang);
            const targetActivityTitle = translations['Target Organism Activity'] || 'Target Organism Activity';
            const loadingText = translations['Loading target organism data...'] || 'Loading target organism data...';
            
            // 显示加载指示器
            card.innerHTML = `
                <h3>${targetActivityTitle}</h3>
                <div class="loading-indicator">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>${loadingText}</p>
                </div>
            `;
            container.appendChild(card);
            
            let targetOrganisms = initialTargetOrganisms;
            
            // 如果没有target organisms数据，尝试从detail数据加载
            if (!targetOrganisms || Object.keys(targetOrganisms).length === 0) {
                const peptideId = findValueInObject(data, "DRAMP ID");
                
                if (peptideId) {
                    try {
                        console.log('目标生物体加载 - 开始处理肽ID:', peptideId);
                        
                        // 使用智能路径识别加载detail数据
                        const possiblePaths = determineDataPath(peptideId);
                        console.log('目标生物体加载 - 可能的路径:', possiblePaths);
                        
                        let detailData = null;
                        
                        for (const path of possiblePaths) {
                            try {
                                console.log(`目标生物体加载 - 尝试路径: ${path}`);
                                detailData = await loadDataWithCache(path);
                                console.log(`目标生物体加载 - 成功从 ${path} 加载数据`);
                                break;
                            } catch (error) {
                                console.log(`目标生物体加载 - 路径 ${path} 失败: ${error.message}`);
                                continue;
                            }
                        }
                        
                        if (detailData) {
                            const targetOrganismStr = findValueInObject(detailData, "Target Organism");
                            if (targetOrganismStr) {
                                targetOrganisms = parseTargetOrganismString(targetOrganismStr);
                                console.log('从detail数据解析的目标生物体数据:', targetOrganisms);
                            }
                        }
                    } catch (error) {
                        console.error('目标生物体数据加载错误:', error);
                    }
                }
            }
            
            // 更新卡片内容
            createTargetOrganismsCardContent(card, targetOrganisms, targetActivityTitle);
        }
        
        // 创建目标生物活性卡片内容
        function createTargetOrganismsCardContent(card, targetOrganisms, titleText = null) {
            // 获取当前语言翻译
            const currentLang = document.documentElement.lang;
            const translations = getTranslations(currentLang);
            const targetActivityTitle = titleText || translations['Target Organism Activity'] || 'Target Organism Activity';
            const noDataText = translations['Target organism activity data not available'] || 'Target organism activity data not available';
            
            createTargetOrganismsCard(card, targetOrganisms, targetActivityTitle, noDataText);
        }
        
        // 创建目标生物活性卡片（核心逻辑）
        function createTargetOrganismsCard(card, targetOrganisms, targetActivityTitle = 'Target Organism Activity', noDataText = 'Target organism activity data not available') {
            let tableHtml = '';
            let noteText = '';
            
            // 检查target_organisms是否为空对象或没有有效数据
            if (!targetOrganisms || Object.keys(targetOrganisms).length === 0) {
                card.innerHTML = `
                    <h3>${targetActivityTitle}</h3>
                    <div class="empty-info">
                        <i class="fas fa-info-circle" style="font-size: 2em; margin-bottom: 10px; color: rgba(255, 255, 255, 0.6);"></i>
                        <p>${noDataText}</p>
                        <p style="font-size: 0.9em; color: rgba(255, 255, 255, 0.7); margin-top: 10px;">
                            This data may be available in detailed biological activity information below.
                        </p>
                    </div>
                `;
                return;
            }
            
            for (const [category, organisms] of Object.entries(targetOrganisms)) {
                if (category === 'Note' && Array.isArray(organisms) && organisms.length > 0) {
                    noteText = organisms[0].name || '';
                    continue;
                }
                
                if (!Array.isArray(organisms) || organisms.length === 0) continue;
                
                tableHtml += `
                    <h4 style="margin-top: 15px; margin-bottom: 10px; color: #fff;">${category}</h4>
                    <table class="activity-table">
                        <thead>
                            <tr>
                                <th>Organism</th>
                                <th>Activity</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                organisms.forEach(org => {
                    // 处理不同格式的活性数据
                    let activityDisplay = '';
                    let activityLevel = 0;
                    
                    if (org.activity) {
                        // 检查活性是否包含加号模式 (+++)
                        if (org.activity.includes('+')) {
                            activityLevel = getActivityLevel(org.activity);
                            activityDisplay = `
                                <div class="activity-level">
                                    ${renderActivityDots(activityLevel)}
                                    <span>${org.activity}</span>
                                </div>
                            `;
                        }
                        // 检查是否为MIC值格式
                        else if (org.activity.toLowerCase().includes('mic') || 
                                org.activity.includes('μg/ml') || 
                                org.activity.includes('ug/ml')) {
                            activityDisplay = `<span class="mic-value">${org.activity}</span>`;
                        }
                        // 其他格式的活性数据
                        else {
                            activityDisplay = `<span>${org.activity}</span>`;
                        }
                    } else {
                        // 无活性数据情况
                        activityDisplay = '<span class="no-activity">N/A</span>';
                    }
                    
                    tableHtml += `
                        <tr>
                            <td>${org.name || 'N/A'}</td>
                            <td>${activityDisplay}</td>
                        </tr>
                    `;
                });
                
                tableHtml += `
                        </tbody>
                    </table>
                `;
            }
            
            // 无数据情况处理
            if (!tableHtml && !noteText) {
                tableHtml = `
                    <div class="empty-info">
                        <i class="fas fa-info-circle" style="font-size: 2em; margin-bottom: 10px; color: rgba(255, 255, 255, 0.6);"></i>
                        <p>${noDataText}</p>
                        <p style="font-size: 0.9em; color: rgba(255, 255, 255, 0.7); margin-top: 10px;">
                            This data may be available in detailed biological activity information below.
                        </p>
                    </div>
                `;
            }
            
            card.innerHTML = `
                <h3>${targetActivityTitle}</h3>
                ${tableHtml}
                ${noteText ? `<div class="activity-note">${noteText}</div>` : ''}
            `;
        }
        
        // 获取活性等级 (+数量)
        function getActivityLevel(activity) {
            if (!activity) return 0;
            
            const plusCount = (activity.match(/\+/g) || []).length;
            return plusCount;
        }
        
        // 渲染活性点
        function renderActivityDots(level) {
            if (level <= 0) return '';
            
            let dots = '';
            let dotColor = '#4CAF50'; // 默认绿色
            
            if (level === 1) {
                dotColor = '#FFC107'; // 黄色
            } else if (level === 2) {
                dotColor = '#2196F3'; // 蓝色
            } else if (level >= 3) {
                dotColor = '#4CAF50'; // 绿色
            }
            
            for (let i = 0; i < level; i++) {
                dots += `<span class="activity-dot" style="background-color: ${dotColor};"></span>`;
            }
            
            return dots;
        }
        
        // 异步版本的卡片创建函数
        async function createBioactivityCardAsync(container, data) {
            return new Promise((resolve, reject) => {
                createBioactivityCard(container, data);
                resolve('Bioactivity card created');
            });
        }
        
        async function createLiteratureCardAsync(container, data) {
            return new Promise((resolve, reject) => {
                createLiteratureCard(container, data);
                resolve('Literature card created');
            });
        }
        
        async function createSimilarPeptidesCardAsync(container, data) {
            return new Promise((resolve, reject) => {
                createSimilarPeptidesCard(container, data);
                resolve('Similar peptides card created');
            });
        }
        
        // 创建生物活性详细信息卡片
        function createBioactivityCard(container, data) {
            const card = document.createElement('div');
            card.className = 'viz-card viz-card-full';
            
            // 显示加载指示器
            card.innerHTML = `
                <h3>生物活性详情</h3>
                <div class="loading-indicator">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>loading biological activity data...</p>
                </div>
            `;
            container.appendChild(card);
            
            // 从detail目录获取完整的肽数据信息
            const peptideId = findValueInObject(data, "SPADE ID") || findValueInObject(data, "DRAMP ID");
            
            // 尝试多个可能的路径加载详细数据
            const loadDetailData = async (id) => {
                console.log('生物活性加载 - 开始处理肽ID:', id);
                
                // 使用智能路径识别
                const possiblePaths = determineDataPath(id);
                console.log('生物活性加载 - 可能的路径:', possiblePaths);
                
                let detailData = null;
                let successPath = '';
                
                for (const path of possiblePaths) {
                    try {
                        console.log(`生物活性加载 - 尝试路径: ${path}`);
                        detailData = await loadDataWithCache(path);
                        successPath = path;
                        console.log(`生物活性加载 - 成功从 ${path} 加载数据`);
                        return detailData;
                    } catch (error) {
                        console.log(`生物活性加载 - 路径 ${path} 失败: ${error.message}`);
                        continue;
                    }
                }
                
                console.warn('生物活性加载 - 所有路径都无法加载数据');
                throw new Error('所有路径都无法加载生物活性数据');
            };
            
            loadDetailData(peptideId)
                .then(fullData => {
                    // 更新卡片内容
                    updateBioactivityCard(card, fullData, data);
                })
                .catch(error => {
                    console.error('生物活性数据加载错误:', error);
                    
                    // 使用已有数据进行备用显示
                    const bioactivity = data.bioactivity || {};
                    const activeMechanisms = bioactivity.mechanisms || [];
                    const applications = bioactivity.applications || [];
                    
                    let mechanismsHtml = '';
                    if (Array.isArray(activeMechanisms) && activeMechanisms.length > 0) {
                        mechanismsHtml = `
                            <h4 style="margin-top: 15px; margin-bottom: 10px; color: #fff;">作用机制</h4>
                            <ul class="bioactivity-list">
                                ${activeMechanisms.map(mechanism => `<li>${mechanism}</li>`).join('')}
                            </ul>
                        `;
                    }
                    
                    let applicationsHtml = '';
                    if (Array.isArray(applications) && applications.length > 0) {
                        applicationsHtml = `
                            <h4 style="margin-top: 15px; margin-bottom: 10px; color: #fff;">应用领域</h4>
                            <ul class="bioactivity-list">
                                ${applications.map(app => `<li>${app}</li>`).join('')}
                            </ul>
                        `;
                    }
                    
                    card.innerHTML = `
                        <h3>Biological Activity Details</h3>
                        <div class="bioactivity-content">
                            ${mechanismsHtml}
                            ${applicationsHtml}
                            <p class="empty-info">Error loading detailed biological activity information: ${error.message}</p>
                        </div>
                    `;
                });
        }
        
        // 使用获取的数据更新生物活性信息卡片
        function updateBioactivityCard(card, fullData, scoredData) {
            console.log('生物活性更新 - 开始处理数据:', {
                hasFullData: !!fullData,
                hasScoredData: !!scoredData,
                fullDataKeys: fullData ? Object.keys(fullData).slice(0, 10) : [],
                scoredDataKeys: scoredData ? Object.keys(scoredData).slice(0, 10) : []
            });
            
            // 使用高效查找获取生物活性信息
            const fullDataFinder = new DataFinder(fullData);
            const scoredDataFinder = new DataFinder(scoredData);
            
            const bioActivity = fullDataFinder.findValue("Biological Activity") || [];
            const function_desc = fullDataFinder.findValue("Function") || '';
            const biophysical = fullDataFinder.findValue("Biophysicochemical properties") || '';
            const targetOrganism = fullDataFinder.findValue("Target Organism") || '';

            // 从评分数据中获取补充信息
            const bioactivity = scoredDataFinder.findValue("bioactivity") || {};
            const bioactivityFinder = new DataFinder(bioactivity);
            const activeMechanisms = bioactivityFinder.findValue("mechanisms") || [];
            const applications = bioactivityFinder.findValue("applications") || [];
            const micData = bioactivityFinder.findValue("mic_values") || [];
            
            console.log('生物活性数据提取结果:', {
                bioActivity: Array.isArray(bioActivity) ? `数组长度: ${bioActivity.length}` : typeof bioActivity,
                function_desc: function_desc ? '有功能描述' : '无功能描述',
                targetOrganism: targetOrganism ? `长度: ${targetOrganism.length}字符` : '无目标生物体',
                biophysical: biophysical ? '有生物物理化学特性' : '无生物物理化学特性',
                activeMechanisms: Array.isArray(activeMechanisms) ? `数组长度: ${activeMechanisms.length}` : typeof activeMechanisms,
                applications: Array.isArray(applications) ? `数组长度: ${applications.length}` : typeof applications,
                micData: Array.isArray(micData) ? `数组长度: ${micData.length}` : typeof micData
            });

            // 构建生物活性信息HTML
            let bioActivityHtml = '';
            if (Array.isArray(bioActivity) && bioActivity.length > 0) {
                bioActivityHtml = `
                    <h4 style="margin-top: 15px; margin-bottom: 10px; color: #fff;">Biological Activity Type</h4>
                    <ul class="bioactivity-list">
                        ${bioActivity.map(activity => `<li>${activity}</li>`).join('')}
                    </ul>
                `;
            }
            
            // 构建功能描述HTML
            let functionHtml = '';
            if (function_desc) {
                functionHtml = `
                    <h4 style="margin-top: 15px; margin-bottom: 15px; color: #fff;">Function Description</h4>
                    <p style="color: #fff; margin-bottom: 15px; line-height: 1.5;">${function_desc}</p>
                `;
            }
            
            // 构建生物物理化学特性HTML
            let biophysicalHtml = '';
            if (biophysical) {
                biophysicalHtml = `
                    <h4 style="margin-top: 15px; margin-bottom: 15px; color: #fff;">Biophysicochemical Properties</h4>
                    <p style="color: #fff; margin-bottom: 15px; line-height: 1.5;">${biophysical}</p>
                `;
            }
            
            // 构建目标生物体HTML
            let targetOrganismHtml = '';
            if (targetOrganism) {
                // 全局替换DRAMP为SPADE
                const modifiedTargetOrganism = targetOrganism.replace(/DRAMP/gi, 'SPADE');

                // 处理长文本的显示
                let displayText = modifiedTargetOrganism;
                if (modifiedTargetOrganism.length > 500) {
                    // 对于长文本，提供可展开的显示
                    const shortText = modifiedTargetOrganism.substring(0, 300) + '...';
                    displayText = `
                        <div class="collapsible-text">
                            <div class="short-text">${shortText}</div>
                            <div class="full-text" style="display: none;">${modifiedTargetOrganism}</div>
                            <button class="toggle-text-btn" onclick="toggleText(this)" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: #fff; padding: 5px 10px; margin-top: 10px; border-radius: 5px; cursor: pointer;">显示更多</button>
                        </div>
                    `;
                }
                
                targetOrganismHtml = `
                    <h4 style="margin-top: 15px; margin-bottom: 15px; color: #fff;">Target Organism</h4>
                    <div style="color: #fff; margin-bottom: 15px; line-height: 1.5;">${displayText}</div>
                `;
            }
            
            // 构建作用机制HTML
            let mechanismsHtml = '';
            if (Array.isArray(activeMechanisms) && activeMechanisms.length > 0) {
                mechanismsHtml = `
                    <h4 style="margin-top: 15px; margin-bottom: 15px; color: #fff;">Mechanism of Action</h4>
                    <ul class="bioactivity-list">
                        ${activeMechanisms.map(mechanism => `<li>${mechanism}</li>`).join('')}
                    </ul>
                `;
            }
            
            // 构建应用领域HTML
            let applicationsHtml = '';
            if (Array.isArray(applications) && applications.length > 0) {
                applicationsHtml = `
                        <h4 style="margin-top: 15px; margin-bottom: 15px; color: #fff;">Application Field</h4>
                    <ul class="bioactivity-list">
                        ${applications.map(app => `<li>${app}</li>`).join('')}
                    </ul>
                `;
            }
            
            // MIC 值表格
            let micTableHtml = '';
            // const micData = bioactivity.mic_values || []; // Already fetched above
            if (Array.isArray(micData) && micData.length > 0) {
                micTableHtml = `
                    <h4 style="margin-top: 15px; margin-bottom: 15px; color: #fff;">Minimum Inhibitory Concentration (MIC)</h4>
                    <table class="activity-table">
                        <thead>
                            <tr>
                                <th>Organism</th>
                                <th>MIC Value</th>
                                <th>Unit</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${micData.map(item => `
                                <tr>
                                    <td>${item.organism || 'N/A'}</td>
                                    <td>${item.value || 'N/A'}</td>
                                    <td>${item.unit || 'μg/ml'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            card.innerHTML = `
                <h3>Biological Activity Details</h3>
                <div class="bioactivity-content">
                    ${bioActivityHtml}
                    ${functionHtml}
                    ${targetOrganismHtml}
                    ${biophysicalHtml}
                    ${mechanismsHtml}
                    ${applicationsHtml}
                    ${micTableHtml}
                    ${!bioActivityHtml && !functionHtml && !targetOrganismHtml && !biophysicalHtml && !mechanismsHtml && !applicationsHtml && !micTableHtml ? 
                    '<p class="empty-info">The detailed biological activity information of this peptide has not been added yet</p>' : ''}
                </div>
            `;
        }
        
        // 创建原始文献信息卡片
        function createLiteratureCard(container, data) {
            const card = document.createElement('div');
            card.className = 'viz-card viz-card-full';
            
            // 获取当前语言翻译
            const currentLang = document.documentElement.lang;
            const translations = getTranslations(currentLang);
            const literatureTitle = translations['Original Literature'] || 'Original Literature';
            const loadingText = translations['Loading literature data...'] || 'Loading literature data...';
            
            // 显示加载指示器
            card.innerHTML = `
                <h3>${literatureTitle}</h3>
                <div class="loading-indicator">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>${loadingText}</p>
                </div>
            `;
            container.appendChild(card);
            
            // 先尝试从当前数据中查找文献信息
            const quickAccess = getQuickAccess(data);
            const peptideId = quickAccess.spadeId;
            
            if (!peptideId) {
                const errorText = translations['No peptide ID found'] || 'No peptide ID found';
                card.innerHTML = `
                    <h3>${literatureTitle}</h3>
                    <p class="empty-info">${errorText}</p>
                `;
                return;
            }
            
            // 检查当前数据是否已包含文献信息
            if (quickAccess.literature && Array.isArray(quickAccess.literature) && quickAccess.literature.length > 0) {
                // 直接使用当前数据中的文献信息
                updateLiteratureCard(card, data, literatureTitle);
                return;
            }
            
            // 如果当前数据中没有文献信息，从detail目录获取完整数据
            const loadDetailDataForLit = async (id) => {
                console.log('文献加载 - 开始处理肽ID:', id);
                
                // 使用智能路径识别
                const possiblePaths = determineDataPath(id);
                console.log('文献加载 - 可能的路径:', possiblePaths);
                
                let detailData = null;
                let successPath = '';
                
                for (const path of possiblePaths) {
                    try {
                        console.log(`文献加载 - 尝试路径: ${path}`);
                        detailData = await loadDataWithCache(path);
                        successPath = path;
                        console.log(`文献加载 - 成功从 ${path} 加载数据`);
                        return detailData;
                    } catch (error) {
                        console.log(`文献加载 - 路径 ${path} 失败: ${error.message}`);
                        continue;
                    }
                }
                
                console.warn('文献加载 - 所有路径都无法加载数据');
                throw new Error('所有路径都无法加载文献数据');
            };
            
            loadDetailDataForLit(peptideId)
                .then(fullData => {
                    // 更新卡片内容
                    updateLiteratureCard(card, fullData, literatureTitle);
                })
                .catch(error => {
                    console.error('Literature data loading error:', error);
                    
                    // 提供更详细的错误信息
                    let errorMessage = '';
                    if (error.message.includes('404')) {
                        errorMessage = translations['Literature data file not found'] || `文献数据文件未找到 (${peptideId}.json)`;
                    } else if (error.message.includes('访问被限制') || error.message.includes('请求频率')) {
                        errorMessage = translations['Access temporarily limited. Please try again in a moment.'] || '访问暂时受限，请稍后重试';
                    } else {
                        errorMessage = translations['Error loading literature data'] || '加载文献信息时出错';
                        errorMessage += `: ${error.message}`;
                    }
                    
                    card.innerHTML = `
                        <h3>${literatureTitle}</h3>
                        <p class="empty-info">${errorMessage}</p>
                    `;
                });
        }
        
        // 使用获取的数据更新文献信息卡片
        function updateLiteratureCard(card, fullData, titleText = null) {
            // 获取翻译
            const currentLang = document.documentElement.lang;
            const translations = getTranslations(currentLang);
            
            // 使用传入的标题或获取翻译
            const literatureTitle = titleText || translations['Original Literature'] || 'Original Literature';
            const noDataText = translations['No literature information available for this peptide'] || 'No literature information available for this peptide';
            const unknownAuthorsText = translations['Unknown Authors'] || 'Unknown Authors';
            const untitledText = translations['Untitled'] || 'Untitled';
            const viewOriginalText = translations['View Original'] || 'View Original';
            
            // 使用高效查找获取文献数据
            const finder = new DataFinder(fullData);
            const literature = finder.findValue("Literature") || [];

            console.log('Literature data search result:', literature); // 调试日志

            let literatureHtml = '';
            if (Array.isArray(literature) && literature.length > 0) {
                literatureHtml = `
                    <div class="literature-list">
                        ${literature.map((ref, index) => {
                            // 直接访问引用对象的属性，不需要再次查找
                            const author = ref.Author || ref.author || unknownAuthorsText;
                            const title = ref.Title || ref.title || untitledText;
                            const reference = ref.Reference || ref.reference || '';
                            const pubmedId = ref["Pubmed ID"] || ref["pubmed_id"] || ref.pubmedId || '';
                            const url = ref.URL || ref.url || '';
                            
                            return `
                                <div class="literature-item">
                                    <div class="lit-number">${index + 1}</div>
                                    <div class="lit-content">
                                        <p class="lit-authors">${author}</p>
                                        <p class="lit-title">${title}</p>
                                        <p class="lit-journal">${reference}</p>
                                        <div class="lit-buttons">
                                            ${pubmedId ? 
                                                `<a href="https://www.ncbi.nlm.nih.gov/pubmed/${pubmedId}" 
                                                    target="_blank" 
                                                    rel="noopener noreferrer" 
                                                    class="lit-button">
                                                    <i class="fas fa-external-link-alt"></i> PubMed ${pubmedId}
                                                </a>` : ''
                                            }
                                            ${url ? 
                                                `<a href="${url}" 
                                                    target="_blank" 
                                                    rel="noopener noreferrer" 
                                                    class="lit-button">
                                                    <i class="fas fa-globe"></i> ${viewOriginalText}
                                                </a>` : ''
                                            }
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                // 提供更详细的调试信息
                console.warn('Literature data is empty or formatted incorrectly:', {
                    literature,
                    isArray: Array.isArray(literature),
                    length: literature?.length,
                    fullDataKeys: Object.keys(fullData || {}),
                    hasSequenceInfo: fullData && fullData['Sequence Information'],
                    sequenceInfoKeys: fullData?.['Sequence Information'] ? Object.keys(fullData['Sequence Information']) : null
                });
                
                literatureHtml = `<p class="empty-info">${noDataText}</p>`;
            }
            
            card.innerHTML = `
                <h3>${literatureTitle}</h3>
                ${literatureHtml}
            `;
        }
        
        // --- 翻译相关功能 ---
        // 保存语言偏好
        function saveLanguagePreference(lang) {
            localStorage.setItem('preferredLanguage', lang);
        }

        // 获取保存的语言偏好
        function getLanguagePreference() {
            return localStorage.getItem('preferredLanguage') || 'en';
        }
        
        // 获取语言显示名称
        function getLanguageDisplayName(langCode) {
            const langNames = {
                'en': 'English',
                'zh-Hans': '中文 (简体)',
                'zh-Hant': '繁體中文',
                'ja': '日本語',
                'ko': '한국어',
                'fr': 'Français',
                'de': 'Deutsch',
                'es': 'Español',
                'ru': 'Русский'
            };
            return langNames[langCode] || langCode;
        }
        
        // 更新当前语言显示
        function updateCurrentLanguageDisplay() {
            const currentLang = document.getElementById('currentLang');
            const currentLangText = document.getElementById('currentLangText');
            
            if (currentLangText) {
                currentLangText.textContent = getLanguageDisplayName(document.documentElement.lang);
                currentLangText.classList.add('no-translate');
            }
            
            if (currentLang) {
                currentLang.classList.add('no-translate');
            }
        }
        
        // 初始化翻译
        function initializeTranslation(lang) {
            // 基本字典定义不变
            window.specialTerms = {
                'en': { 'SPADE': 'SPADE' },
                'zh-Hans': {
                    // 中文翻译...
                },
                // 其他语言翻译...
            };
            
            // 直接翻译页面上的静态元素
            translateStaticElements(lang);
            
            // 使用Tranzy进行动态内容翻译
            const tranzy = new Tranzy.Translator({
                toLang: lang,
                fromLang: 'en',
                ignore: ['.no-translate', '.sequence-display', '.activity-level span'],
                manualDict: window.specialTerms
            });
            
            tranzy.translatePage();
            tranzy.startObserver();
            
            window.tranzyInstance = tranzy;
        }
        
        // 直接翻译页面上的静态元素
        function translateStaticElements(lang) {
            // 获取翻译词典
            const dict = window.specialTerms[lang] || {};
            
            // 设置页面标题
            document.getElementById('peptideTitle').textContent = dict['AMP Visualization'] || 'AMP Visualization';
            
            // 翻译导航菜单
            translateNavMenu(dict);
            
            // 更新返回按钮文本
            updateBackButtonText(lang);
            
            // 预定义卡片标题映射
            const cardTitleMap = {
                '肽信息': dict['Peptide Information'] || 'Peptide Information',
                '总体评分': dict['Overall Score'] || 'Overall Score',
                'Scoring Profile': dict['Scoring Profile'] || 'Scoring Profile',
                'Weighted Scores': dict['Weighted Scores'] || 'Weighted Scores',
                'Detailed Scores': dict['Detailed Scores'] || 'Detailed Scores',
                '目标生物活性': dict['Target Organism Activity'] || 'Target Organism Activity',
                '生物活性详情': dict['Bioactivity Details'] || 'Bioactivity Details',
                '原始文献': dict['Original Literature'] || 'Original Literature',
                '统计数据': dict['Statistics'] || 'Statistics'
            };
            
            // 翻译所有卡片标题
            document.querySelectorAll('.viz-card h3').forEach(header => {
                const originalText = header.textContent.trim();
                if (cardTitleMap[originalText]) {
                    header.textContent = cardTitleMap[originalText];
                }
            });
            
            // 翻译加载提示
            const loadingText = document.querySelector('.loading-indicator p');
            if (loadingText) {
                loadingText.textContent = dict['Loading visualization data...'] || 'Loading visualization data...';
            }
        }
        
        // 翻译导航菜单
        function translateNavMenu(dict) {
            // 获取所有导航链接
            const navLinks = document.querySelectorAll('.nav-menu a');
            
            // 链接文本映射
            const linkTextMap = {
                'Home': dict['Home'] || 'Home',
                'Search': dict['Search'] || 'Search',
                'Tools': dict['Tools'] || 'Tools',
                'Statistics': dict['Statistics'] || 'Statistics',
                'AMP Visualization': dict['AMP Visualization'] || 'AMP Visualization'
            };
            
            // 更新链接文本
            navLinks.forEach(link => {
                const text = link.textContent.trim();
                if (linkTextMap[text]) {
                    link.textContent = linkTextMap[text];
                }
            });
            
            // 更新团队链接
            const teamLink = document.querySelector('.team-link');
            if (teamLink) {
                teamLink.textContent = dict['Belongs to 2025-XJTLU-Software'] || 'Belongs to 2025-XJTLU-Software';
            }
        }
        
        // --- 页面初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log('页面DOM加载完成，开始初始化');
            
            // 设置默认语言
            if (!document.documentElement.lang) {
                document.documentElement.lang = getLanguagePreference() || 'en';
            }
            console.log('当前语言设置:', document.documentElement.lang);
            
            // 导航响应式菜单处理
            const navToggle = document.querySelector('.nav-toggle');
            const navMenu = document.querySelector('.nav-menu');
            
            if (navToggle && navMenu) {
                navToggle.addEventListener('click', () => {
                    navMenu.classList.toggle('active');
                });
                console.log('导航菜单事件已绑定');
            }

            // 快速笔记按钮事件处理
            const notesBtn = document.getElementById('quick-notes-btn');
            if (notesBtn) {
                notesBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (window.quickNotes) {
                        window.quickNotes.toggle();
                    }
                });
                console.log('快速笔记按钮事件已绑定');
            }
            
            // 设置当前语言
            const savedLang = getLanguagePreference();
            document.documentElement.lang = savedLang || 'en';
            
            // 初始化语言选择器（已注释）
            /*
            const langOptions = document.querySelectorAll('.language-option');
            langOptions.forEach(option => {
                option.addEventListener('click', function(e) {
                    e.preventDefault();
                    const newLang = this.getAttribute('data-lang');
                    changeLanguage(newLang);
                });
                
                // 高亮当前语言选项
                if (option.getAttribute('data-lang') === savedLang) {
                    option.classList.add('active');
                }
            });
            console.log('语言选择器已初始化');
            */
            
            // 更新当前语言显示（已注释）
            /*
            const currentLangText = document.getElementById('currentLangText');
            if (currentLangText) {
                currentLangText.textContent = getLanguageDisplayName(savedLang || 'en');
            }
            */
            
            // 更新页面文本（已注释）
            /*
            try {
                updatePageTexts();
                console.log('页面文本更新完成');
            } catch (error) {
                console.error("Error updating page texts:", error);
            }
            */
            
            // 加载肽数据
            console.log('开始获取肽ID并加载数据');
            const peptideId = getPeptideIdFromUrl();
            loadPeptideData(peptideId);
        });

        // 创建详细评分分析卡片
        function createDetailedScoringAnalysisCard(container, data) {
            const card = document.createElement('div');
            card.className = 'viz-card viz-card-full';
            
            // 获取当前语言和翻译
            const currentLang = document.documentElement.lang;
            const translations = getTranslations(currentLang);
            
            // 获取评分详情数据
            const details = findValueInObject(data, "details") || {};
            const weights = findValueInObject(data, "weights") || {};
            const scores = findValueInObject(data, "scores") || {};
            const weightedScores = findValueInObject(data, "weighted_scores") || {};
            
            const analysisTitle = translations['Detailed Scoring Analysis'] || '详细评分分析';
            
            let analysisHtml = '';
            
            // 为每个评分维度创建详细分析
            const dimensions = ['efficacy', 'selectivity', 'stability', 'synthesis', 'novelty'];
            
            dimensions.forEach(dimension => {
                const dimensionDetails = details[dimension] || {};
                const score = scores[dimension] || 0;
                const weightedScore = weightedScores[dimension] || 0;
                const weight = weights[dimension] || 0;
                
                // 翻译维度名称
                const dimensionName = translations[formatScoreLabel(dimension)] || formatScoreLabel(dimension);
                
                // 构建详细信息HTML - 增强版本
                let detailsHtml = '';
                Object.entries(dimensionDetails).forEach(([key, value]) => {
                    if (key !== 'final_score' && value !== null && value !== undefined) {
                        const formattedKey = formatScoreLabel(key);
                        let translatedKey = translations[formattedKey] || formattedKey;
                        
                        // 特殊处理一些专业术语的翻译
                        const specialTranslations = {
                            'Mic Data': translations['MIC Data'] || 'MIC数据',
                            'Predicted Score': translations['Predicted Score'] || '预测评分',
                            'Charge Score': translations['Charge Score'] || '电荷评分',
                            'Hydrophobicity Score': translations['Hydrophobicity Score'] || '疏水性评分',
                            'Length Factor': translations['Length Factor'] || '长度因子',
                            'Hemolysis Data': translations['Hemolysis Data'] || '溶血数据',
                            'Predicted Selectivity': translations['Predicted Selectivity'] || '预测选择性',
                            'Hydrophobicity Penalty': translations['Hydrophobicity Penalty'] || '疏水性惩罚',
                            'Charge Bonus': translations['Charge Bonus'] || '电荷奖励',
                            'Diversity Bonus': translations['Diversity Bonus'] || '多样性奖励',
                            'Disulfide Bonds': translations['Disulfide Bonds'] || '二硫键',
                            'Disulfide Bonus': translations['Disulfide Bonus'] || '二硫键奖励',
                            'Proline Bonus': translations['Proline Bonus'] || '脯氨酸奖励',
                            'Glycine Penalty': translations['Glycine Penalty'] || '甘氨酸惩罚',
                            'Length Score': translations['Length Score'] || '长度评分',
                            'Rare Amino Acids': translations['Rare Amino Acids'] || '稀有氨基酸',
                            'Rare Penalty': translations['Rare Penalty'] || '稀有氨基酸惩罚',
                            'Unique Amino Acids': translations['Unique Amino Acids'] || '独特氨基酸',
                            'Repetition Bonus': translations['Repetition Bonus'] || '重复奖励',
                            'Disulfide Penalty': translations['Disulfide Penalty'] || '二硫键惩罚',
                            'Max Similarity': translations['Max Similarity'] || '最大相似度',
                            'Avg Similarity': translations['Avg Similarity'] || '平均相似度',
                            'Novelty From Similarity': translations['Novelty From Similarity'] || '相似度新颖性',
                            'Unique Activities': translations['Unique Activities'] || '独特活性',
                            'Multifunctional Bonus': translations['Multifunctional Bonus'] || '多功能奖励',
                            'Composition Entropy': translations['Composition Entropy'] || '组成熵',
                            'Composition Bonus': translations['Composition Bonus'] || '组成奖励'
                        };
                        
                        if (specialTranslations[formattedKey]) {
                            translatedKey = specialTranslations[formattedKey];
                        }
                        
                        let displayValue = value;
                        if (typeof value === 'number') {
                            // 根据数值大小调整显示精度
                            if (Math.abs(value) < 0.01) {
                                displayValue = value.toFixed(4);
                            } else if (Math.abs(value) < 1) {
                                displayValue = value.toFixed(3);
                            } else {
                                displayValue = value.toFixed(2);
                            }
                        } else if (Array.isArray(value)) {
                            if (value.length === 0) {
                                displayValue = 'N/A';
                            } else {
                                // 处理数组数据，特别是unique_activities
                                displayValue = value.map(item => {
                                    if (typeof item === 'string') {
                                        // 翻译活性类型
                                        const activityTranslations = {
                                            'antibacterial': translations['Antibacterial'] || '抗菌',
                                            'antifungal': translations['Antifungal'] || '抗真菌',
                                            'antiviral': translations['Antiviral'] || '抗病毒',
                                            'anticancer': translations['Anticancer'] || '抗癌',
                                            'hemolytic': translations['Hemolytic'] || '溶血'
                                        };
                                        return activityTranslations[item] || item;
                                    }
                                    return item;
                                }).join(', ');
                            }
                        } else if (value === null) {
                            displayValue = 'N/A';
                        }
                        
                        // 添加特殊图标和样式
                        let itemClass = 'detail-item';
                        let iconHtml = '';
                        
                        if (key.includes('bonus')) {
                            itemClass += ' positive-item';
                            iconHtml = '<i  style="color: #4CAF50; margin-right: 5px;"></i>';
                        } else if (key.includes('penalty')) {
                            itemClass += ' negative-item';
                            iconHtml = '<i  style="color: #F44336; margin-right: 5px;"></i>';
                        } else if (key.includes('score')) {
                            iconHtml = '<i style="color: #FFD700; margin-right: 5px;"></i>';
                        } else if (key.includes('data')) {
                            iconHtml = '<i  style="color: #2196F3; margin-right: 5px;"></i>';
                        }
                        
                        detailsHtml += `
                            <div class="${itemClass}">
                                <span class="detail-key">${iconHtml}${translatedKey}:</span>
                                <span class="detail-value">${displayValue}</span>
                            </div>
                        `;
                    }
                });
                
                // 获取评分等级颜色
                let scoreClass = 'score-average';
                if (score >= 8.5) scoreClass = 'score-excellent';
                else if (score >= 7.5) scoreClass = 'score-good';
                else if (score >= 6.5) scoreClass = 'score-above-average';
                else if (score >= 5.5) scoreClass = 'score-average';
                else if (score >= 4.5) scoreClass = 'score-below-average';
                else if (score >= 3.5) scoreClass = 'score-fair';
                else if (score >= 2.5) scoreClass = 'score-poor';
                else scoreClass = 'score-very-poor';
                
                analysisHtml += `
                    <div class="dimension-analysis">
                        <div class="dimension-header">
                            <h4 class="dimension-title">${dimensionName}</h4>
                            <div class="dimension-scores">
                                <span class="raw-score ${scoreClass}">${score.toFixed(1)}</span>
                                <span class="weight-info">× ${(weight * 100).toFixed(0)}% = </span>
                                <span class="weighted-score">${weightedScore.toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="dimension-details">
                            ${detailsHtml}
                        </div>
                    </div>
                `;
            });
            
            card.innerHTML = `
                <h3>${analysisTitle}</h3>
                <div class="scoring-analysis-container">
                    ${analysisHtml}
                </div>
            `;
            
            container.appendChild(card);
        }
        
        // 创建评分特征卡片
        function createScoringFeaturesCard(container, data) {
            const card = document.createElement('div');
            card.className = 'viz-card viz-card-full';
            
            // 获取当前语言和翻译
            const currentLang = document.documentElement.lang;
            const translations = getTranslations(currentLang);
            
            // 获取特征数据
            const features = findValueInObject(data, "features") || {};
            const scoringVersion = findValueInObject(data, "scoring_version") || 'N/A';
            const timestamp = findValueInObject(data, "timestamp") || '';
            
            const featuresTitle = translations['Scoring Features'] || '评分特征';
            
            // 构建特征显示HTML
            let featuresHtml = '';
            
            // 分组显示特征
            const featureGroups = {
                'Amino Acid Composition': [
                    'hydrophobic_count', 'hydrophobic_ratio',
                    'hydrophilic_count', 'hydrophilic_ratio',
                    'positive_count', 'positive_ratio',
                    'negative_count', 'negative_ratio',
                    'aromatic_count', 'aromatic_ratio',
                    'cysteine_count', 'cysteine_ratio',
                    'proline_count', 'proline_ratio',
                    'glycine_count', 'glycine_ratio'
                ],
                'Physical Properties': [
                    'net_charge', 'hydrophobicity', 'amphipathicity',
                    'aromaticity', 'cys_bonds_potential', 'flexibility'
                ]
            };
            
            Object.entries(featureGroups).forEach(([groupName, featureKeys]) => {
                const translatedGroupName = translations[groupName] || groupName;
                let groupHtml = '';
                
                featureKeys.forEach(key => {
                    if (features.hasOwnProperty(key)) {
                        const value = features[key];
                        const formattedKey = formatScoreLabel(key);
                        const translatedKey = translations[formattedKey] || formattedKey;
                        
                        let displayValue = value;
                        if (typeof value === 'number') {
                              displayValue = value.toFixed(2); // 统一为两位小数，不再乘以100也不加%
                        }
                        
                        groupHtml += `
                            <div class="feature-item">
                                <span class="feature-key">${translatedKey}:</span>
                                <span class="feature-value">${displayValue}</span>
                            </div>
                        `;
                    }
                });
                
                if (groupHtml) {
                    featuresHtml += `
                        <div class="feature-group">
                            <h4 class="feature-group-title">${translatedGroupName}</h4>
                            <div class="feature-group-content">
                                ${groupHtml}
                            </div>
                        </div>
                    `;
                }
            });
            
            // 格式化时间戳
            let formattedTimestamp = '';
            if (timestamp) {
                try {
                    const date = new Date(timestamp);
                    formattedTimestamp = date.toLocaleString();
                } catch (e) {
                    formattedTimestamp = timestamp;
                }
            }
            
            card.innerHTML = `
                <h3>${featuresTitle}</h3>
                <div class="features-container">
                    ${featuresHtml}
                    <div class="scoring-metadata">
                        <div class="metadata-item">
                            <span class="metadata-key">Scoring Version:</span>
                            <span class="metadata-value">${scoringVersion}</span>
                        </div>
                        ${formattedTimestamp ? `
                        <div class="metadata-item">
                            <span class="metadata-key">Scoring Time:</span>
                            <span class="metadata-value">${formattedTimestamp}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            container.appendChild(card);
        }
        
        // 异步加载序列进行频率分析
        async function loadSequenceForFrequencyAnalysis(card, peptideId, aminoAcidTitle, dataNotAvailableText) {
            try {
                console.log('序列频率分析 - 开始异步加载肽ID:', peptideId);
                
                // 使用智能路径识别加载detail数据
                const possiblePaths = determineDataPath(peptideId);
                console.log('序列频率分析 - 可能的路径:', possiblePaths);
                
                let detailData = null;
                
                for (const path of possiblePaths) {
                    try {
                        console.log(`序列频率分析 - 尝试路径: ${path}`);
                        detailData = await loadDataWithCache(path);
                        console.log(`序列频率分析 - 成功从 ${path} 加载数据`);
                        break;
                    } catch (error) {
                        console.log(`序列频率分析 - 路径 ${path} 失败: ${error.message}`);
                        continue;
                    }
                }
                
                if (detailData) {
                    // 尝试从嵌套结构中获取序列
                    let sequence = "";
                    if (detailData[peptideId] && detailData[peptideId]["Sequence Information"]) {
                        sequence = detailData[peptideId]["Sequence Information"]["Sequence"] || "";
                        console.log('序列频率分析 - 从嵌套结构获取序列:', { length: sequence.length });
                    }
                    
                    // 如果嵌套结构中没有，尝试直接查找
                    if (!sequence) {
                        sequence = findValueInObject(detailData, "Sequence") || "";
                        console.log('序列频率分析 - 从直接结构获取序列:', { length: sequence.length });
                    }
                    
                    if (sequence) {
                        console.log('序列频率分析 - 成功获取序列:', { length: sequence.length });
                        // 重新渲染氨基酸频率分析
                        renderAminoAcidFrequencyChart(card, sequence, aminoAcidTitle);
                        return;
                    }
                }
                
                console.warn('序列频率分析 - 无法获取序列数据');
                card.innerHTML = `
                    <h3>${aminoAcidTitle}</h3>
                    <p class="empty-info">${dataNotAvailableText}</p>
                `;
                
            } catch (error) {
                console.error('序列频率分析加载错误:', error);
                card.innerHTML = `
                    <h3>${aminoAcidTitle}</h3>
                    <p class="empty-info">${dataNotAvailableText}</p>
                    <p style="text-align: center; color: rgba(255, 255, 255, 0.6); font-size: 0.9em; margin-top: 10px;">
                        Error loading sequence data: ${error.message}
                    </p>
                `;
            }
        }
        
        // 渲染氨基酸频率图表
        function renderAminoAcidFrequencyChart(card, sequence, aminoAcidTitle) {
            // 获取当前语言和翻译
            const currentLang = document.documentElement.lang;
            const translations = getTranslations(currentLang);
            const frequencyLabel = translations['Frequency (%)'] || '频率 (%)';
            const aminoAcidLabel = translations['Amino Acid'] || '氨基酸';
            const sequenceLengthText = translations['Sequence Length'] || '序列长度';
            const aminoAcidsText = translations['amino acids'] || '氨基酸';
            
            card.innerHTML = `
                <h3>${aminoAcidTitle}</h3>
                <div class="amino-acid-frequency" style="height: 350px; margin-top: 20px;">
                    <canvas id="aminoAcidFrequencyChart"></canvas>
                </div>
            `;
            
            // 计算频率
            const aminoAcidCounts = {};
            const aminoAcids = 'ACDEFGHIKLMNPQRSTVWY'.split('');
            
            // 初始化所有氨基酸计数为0
            aminoAcids.forEach(aa => {
                aminoAcidCounts[aa] = 0;
            });
            
            // 计算每种氨基酸在序列中的数量
            for (let i = 0; i < sequence.length; i++) {
                const aa = sequence[i].toUpperCase();
                if (aminoAcidCounts.hasOwnProperty(aa)) {
                    aminoAcidCounts[aa]++;
                }
            }
            
            // 计算频率（百分比）
            const aminoAcidFrequencies = {};
            aminoAcids.forEach(aa => {
                aminoAcidFrequencies[aa] = (aminoAcidCounts[aa] / sequence.length) * 100;
            });
            
            // 根据频率动态分配颜色 - 以蓝色为主的明亮渐变
            const aaColors = {};
            const colorGradient = [
                '#F0F8FF', '#E6F3FF', '#DCE8FF', '#D2DDFF', '#C8D2FF', 
                '#BEC7FF', '#B4BCFF', '#AAB1FF', '#A0A6FF', '#969BFF', 
                '#8C90FF', '#8285FF', '#787AFF', '#6E6FFF', '#6464FF', 
                '#5A59FF', '#504EFF', '#4643FF', '#3C38FF', '#322DFF'
            ];
            
            // 按频率排序氨基酸
            const sortedAAs = Object.entries(aminoAcidFrequencies)
                .sort((a, b) => a[1] - b[1]); // 从低到高排序
            
            // 根据频率分配颜色
            sortedAAs.forEach((aa, index) => {
                aaColors[aa[0]] = colorGradient[index];
            });
            
            // 翻译图例标签
            const chartLabel = translations['Amino Acid Frequency (%)'] || '氨基酸频率 (%)';
            
            // 延迟渲染图表以确保DOM元素已创建
            setTimeout(() => {
                const ctx = document.getElementById('aminoAcidFrequencyChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: aminoAcids,
                        datasets: [{
                            label: chartLabel,
                            data: aminoAcids.map(aa => aminoAcidFrequencies[aa]),
                            backgroundColor: aminoAcids.map(aa => aaColors[aa]),
                            borderColor: aminoAcids.map(aa => aaColors[aa]),
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: frequencyLabel,
                                    font: { size: 14, weight: 'bold' },
                                    color: '#ffffff'
                                },
                                ticks: {
                                    font: { size: 12 },
                                    color: '#ffffff',
                                    callback: function(value) {
                                        return value.toFixed(1) + '%';
                                    }
                                },
                                grid: { color: 'rgba(255, 255, 255, 0.2)' }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: aminoAcidLabel,
                                    font: { size: 14, weight: 'bold' },
                                    color: '#ffffff'
                                },
                                ticks: {
                                    font: { size: 12, weight: 'bold' },
                                    color: '#ffffff'
                                },
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: { size: 12 },
                                    color: '#ffffff'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleFont: { size: 14 },
                                bodyFont: { size: 13 },
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.raw.toFixed(2);
                                        const aa = context.label;
                                        const count = aminoAcidCounts[aa];
                                        const countText = translations['count'] || 'count';
                                        return `${aa}: ${value}% (${count}${countText})`;
                                    }
                                }
                            }
                        }
                    }
                });
                
                // 添加序列长度和总结信息
                const infoDiv = document.createElement('div');
                infoDiv.className = 'sequence-summary';
                infoDiv.style.marginTop = '15px';
                infoDiv.style.fontSize = '14px';
                infoDiv.style.color = '#ffffff';
                infoDiv.style.textAlign = 'center';
                infoDiv.innerHTML = `
                    <p>${sequenceLengthText}: <strong>${sequence.length}</strong> ${aminoAcidsText}</p>
                    <p class="sequence-text" style="font-family: monospace; margin-top: 10px; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; font-size: 12px;">${sequence}</p>
                `;
                card.appendChild(infoDiv);
            }, 100);
        }
        
        // 创建氨基酸频率分析卡片
        function createAminoAcidFrequencyCard(container, data) {
            // 创建卡片外壳
            const card = document.createElement('div');
            card.className = 'viz-card viz-card-full'; // 将卡片设为全宽
            
            // 获取当前语言和翻译
            const currentLang = document.documentElement.lang;
            const translations = getTranslations(currentLang);
            
            // 获取翻译后的标题和文本
            const aminoAcidTitle = translations['Amino Acid Frequency Analysis'] || '氨基酸频率分析';
            const frequencyLabel = translations['Frequency (%)'] || '频率 (%)';
            const aminoAcidLabel = translations['Amino Acid'] || '氨基酸';
            const sequenceLengthText = translations['Sequence Length'] || '序列长度';
            const aminoAcidsText = translations['amino acids'] || '氨基酸';
            const dataNotAvailableText = translations['Unable to analyze: sequence data not available'] || '无法分析：序列数据不可用';
            
            card.innerHTML = `
                <h3>${aminoAcidTitle}</h3>
                <div class="amino-acid-frequency" style="height: 350px; margin-top: 20px;">
                    <canvas id="aminoAcidFrequencyChart"></canvas>
                </div>
            `;
            container.appendChild(card);
            
            // 计算氨基酸频率 - 从多个可能的数据源获取序列，优先从detail数据查找
            let sequence = "";
            
            // 优先从detail数据获取序列 - 修复嵌套数据结构解析
            if (data._detailData) {
                // 尝试从嵌套结构中获取序列
                const peptideId = findValueInObject(data, "DRAMP ID") || findValueInObject(data, "SPADE ID");
                if (peptideId && data._detailData[peptideId]) {
                    const sequenceInfo = data._detailData[peptideId]["Sequence Information"];
                    if (sequenceInfo) {
                        sequence = sequenceInfo["Sequence"] || "";
                        console.log('从嵌套detail数据获取序列:', { hasSequence: !!sequence, length: sequence.length });
                    }
                }
                
                // 如果嵌套结构中没有，尝试直接查找
                if (!sequence) {
                    sequence = findValueInObject(data._detailData, "Sequence") || 
                              findValueInObject(data._detailData, "sequence") || 
                              findValueInObject(data._detailData, "seq") || "";
                    console.log('从detail数据直接获取序列:', { hasSequence: !!sequence, length: sequence.length });
                }
            }
            
            // 如果detail数据中没有，从主数据获取
            if (!sequence) {
                sequence = findValueInObject(data, "Sequence") || 
                          findValueInObject(data, "sequence") || 
                          findValueInObject(data, "seq") || "";
                console.log('从主数据获取序列:', { hasSequence: !!sequence, length: sequence.length });
            }
            
            // 如果在主数据中没找到，尝试从其他结构中查找
            if (!sequence) {
                const sequenceInfo = findValueInObject(data, "Sequence Information");
                if (sequenceInfo) {
                    sequence = findValueInObject(sequenceInfo, "Sequence") || 
                              findValueInObject(sequenceInfo, "sequence") || "";
                    console.log('从Sequence Information获取序列:', { hasSequence: !!sequence, length: sequence.length });
                }
            }
            
            // 如果还是没有序列，尝试异步加载detail数据
            if (!sequence) {
                const peptideId = findValueInObject(data, "DRAMP ID") || findValueInObject(data, "SPADE ID");
                if (peptideId) {
                    // 异步加载detail数据来获取序列
                    loadSequenceForFrequencyAnalysis(card, peptideId, aminoAcidTitle, dataNotAvailableText);
                    return;
                }
            }
            
            // 如果还是没有序列，尝试从features中获取长度验证是否应该有序列
            if (!sequence) {
                const features = findValueInObject(data, "features") || {};
                const sequenceLength = features.length || features.sequence_length;
                
                console.log('氨基酸频率分析：序列数据检查', {
                    hasSequence: !!sequence,
                    sequenceLength,
                    dataKeys: Object.keys(data),
                    features: Object.keys(features)
                });
                
                // 如果有长度信息但没有序列，显示提示
                if (sequenceLength && sequenceLength > 0) {
                    card.innerHTML = `
                        <h3>${aminoAcidTitle}</h3>
                        <p class="empty-info">${dataNotAvailableText}</p>
                        <p style="text-align: center; color: rgba(255, 255, 255, 0.6); font-size: 0.9em; margin-top: 10px;">
                            检测到序列长度为 ${sequenceLength}，但序列数据未加载
                        </p>
                    `;
                    return;
                }
                
                card.innerHTML = `
                    <h3>${aminoAcidTitle}</h3>
                    <p class="empty-info">${dataNotAvailableText}</p>
                `;
                return;
            }
            
            // 计算频率
            const aminoAcidCounts = {};
            const aminoAcids = 'ACDEFGHIKLMNPQRSTVWY'.split('');
            
            // 初始化所有氨基酸计数为0
            aminoAcids.forEach(aa => {
                aminoAcidCounts[aa] = 0;
            });
            
            // 计算每种氨基酸在序列中的数量
            for (let i = 0; i < sequence.length; i++) {
                const aa = sequence[i].toUpperCase();
                if (aminoAcidCounts.hasOwnProperty(aa)) {
                    aminoAcidCounts[aa]++;
                }
            }
            
            // 计算频率（百分比）
            const aminoAcidFrequencies = {};
            aminoAcids.forEach(aa => {
                aminoAcidFrequencies[aa] = (aminoAcidCounts[aa] / sequence.length) * 100;
            });
            
            // 根据频率动态分配颜色 - 以蓝色为主的明亮渐变
            const aaColors = {};
            const colorGradient = [
                '#F0F8FF', '#E6F3FF', '#DCE8FF', '#D2DDFF', '#C8D2FF', 
                '#BEC7FF', '#B4BCFF', '#AAB1FF', '#A0A6FF', '#969BFF', 
                '#8C90FF', '#8285FF', '#787AFF', '#6E6FFF', '#6464FF', 
                '#5A59FF', '#504EFF', '#4643FF', '#3C38FF', '#322DFF'
            ];
            
            // 按频率排序氨基酸
            const sortedAAs = Object.entries(aminoAcidFrequencies)
                .sort((a, b) => a[1] - b[1]); // 从低到高排序
            
            // 根据频率分配颜色
            sortedAAs.forEach((aa, index) => {
                aaColors[aa[0]] = colorGradient[index];
            });
            
            // 翻译图例标签
            const chartLabel = translations['Amino Acid Frequency (%)'] || '氨基酸频率 (%)';
            
            // 绘制图表
            const ctx = document.getElementById('aminoAcidFrequencyChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: aminoAcids,
                    datasets: [{
                        label: chartLabel,
                        data: aminoAcids.map(aa => aminoAcidFrequencies[aa]),
                        backgroundColor: aminoAcids.map(aa => aaColors[aa]),
                        borderColor: aminoAcids.map(aa => aaColors[aa]),
                        borderWidth: 1,
                        borderRadius: 5 // 添加圆角
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: frequencyLabel,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: '#ffffff'
                            },
                            ticks: {
                                font: {
                                    size: 12
                                },
                                color: '#ffffff',
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.2)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: aminoAcidLabel,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: '#ffffff'
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                color: '#ffffff'
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                },
                                color: '#ffffff'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.raw.toFixed(2);
                                    const aa = context.label;
                                    const count = aminoAcidCounts[aa];
                                    // 添加翻译
                                    const countText = translations['count'] || 'count';
                                    return `${aa}: ${value}% (${count}${countText})`;
                                }
                            }
                        }
                    }
                }
            });
            
            // 添加序列长度和总结信息
            const infoDiv = document.createElement('div');
            infoDiv.className = 'sequence-summary';
            infoDiv.style.marginTop = '15px';
            infoDiv.style.fontSize = '14px';
            infoDiv.style.color = '#ffffff';
            infoDiv.style.textAlign = 'center';
            infoDiv.innerHTML = `
                <p>${sequenceLengthText}: <strong>${sequence.length}</strong> ${aminoAcidsText}</p>
                <p class="sequence-text" style="font-family: monospace; margin-top: 10px; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; font-size: 12px;">${sequence}</p>
            `;
            card.appendChild(infoDiv);
        }

        // 创建相似肽段卡片
        function createSimilarPeptidesCard(container, data) {
            const card = document.createElement('div');
            card.className = 'viz-card viz-card-full';
            
            // 获取当前语言翻译
            const currentLang = document.documentElement.lang;
            const translations = getTranslations(currentLang);
            const similarPeptidesTitle = translations['Similar Peptides'] || '相似肽段';
            const loadingText = translations['Loading similar peptides...'] || '加载相似肽段数据...';
            
            // 显示加载指示器
            card.innerHTML = `
                <h3>${similarPeptidesTitle}</h3>
                <div class="loading-indicator">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>${loadingText}</p>
                </div>
            `;
            container.appendChild(card);
            
            // 获取肽ID
            const peptideId = findValueInObject(data, "DRAMP ID");
            
            // 首先检查当前数据中是否已包含相似肽段信息，使用与peptide_card.html一致的字段名
            const currentSimilarPeptides = findValueInObject(data, "Similar Sequences") ||
                                         findValueInObject(data, "similar_sequences") || 
                                         findValueInObject(data, "similar_peptides") || 
                                         findValueInObject(data, "similarities") || [];
            
            console.log('当前数据中的相似肽段检查:', {
                hasData: !!currentSimilarPeptides,
                isArray: Array.isArray(currentSimilarPeptides),
                length: currentSimilarPeptides ? currentSimilarPeptides.length : 0,
                sampleItem: currentSimilarPeptides && currentSimilarPeptides[0] ? Object.keys(currentSimilarPeptides[0]) : null
            });
            
            if (currentSimilarPeptides && Array.isArray(currentSimilarPeptides) && currentSimilarPeptides.length > 0) {
                // 直接使用当前数据中的相似肽段信息
                updateSimilarPeptidesCard(card, currentSimilarPeptides, similarPeptidesTitle);
                return;
            }
            
            // 如果当前数据中没有相似肽段信息，尝试从detail数据中获取
            if (!peptideId) {
                const noDataText = translations['No peptide ID found for similar peptides search'] || '未找到肽ID，无法搜索相似肽段';
                card.innerHTML = `
                    <h3>${similarPeptidesTitle}</h3>
                    <p class="empty-info">${noDataText}</p>
                `;
                return;
            }
            
            // 从detail目录获取数据
            const loadDetailDataForSimilar = async (id) => {
                console.log('相似肽段加载 - 开始处理肽ID:', id);
                
                // 使用智能路径识别
                const possiblePaths = determineDataPath(id);
                console.log('相似肽段加载 - 可能的路径:', possiblePaths);
                
                let detailData = null;
                let successPath = '';
                
                for (const path of possiblePaths) {
                    try {
                        console.log(`相似肽段加载 - 尝试路径: ${path}`);
                        detailData = await loadDataWithCache(path);
                        successPath = path;
                        console.log(`相似肽段加载 - 成功从 ${path} 加载数据`);
                        return detailData;
                    } catch (error) {
                        console.log(`相似肽段加载 - 路径 ${path} 失败: ${error.message}`);
                        continue;
                    }
                }
                
                console.warn('相似肽段加载 - 所有路径都无法加载数据');
                throw new Error('所有路径都无法加载相似肽段数据');
            };
            
            loadDetailDataForSimilar(peptideId)
                .then(fullData => {
                    updateSimilarPeptidesCard(card, fullData, similarPeptidesTitle);
                })
                .catch(error => {
                    console.error('相似肽段数据加载错误:', error);
                    
                    let errorMessage = '';
                    if (error.message.includes('404')) {
                        errorMessage = translations['Similar peptides data file not found'] || '相似肽段数据文件未找到';
                    } else if (error.message.includes('访问被限制') || error.message.includes('请求频率')) {
                        errorMessage = translations['Access temporarily limited. Please try again in a moment.'] || '访问暂时受限，请稍后重试';
                    } else {
                        errorMessage = translations['Error loading similar peptides data'] || '加载相似肽段信息时出错';
                        errorMessage += `: ${error.message}`;
                    }
                    
                    card.innerHTML = `
                        <h3>${similarPeptidesTitle}</h3>
                        <p class="empty-info">${errorMessage}</p>
                    `;
                });
        }
        
        // 使用获取的数据更新相似肽段信息卡片
        function updateSimilarPeptidesCard(card, data, titleText = null) {
            // 获取翻译
            const currentLang = document.documentElement.lang;
            const translations = getTranslations(currentLang);
            
            const similarPeptidesTitle = titleText || translations['Similar Peptides'] || '相似肽段';
            const noDataText = translations['No similar peptides information available'] || '暂无相似肽段信息';
            const viewDetailsText = translations['View Details'] || '查看详情';
            const similarityText = translations['Similarity'] || '相似度';
            
            let similarPeptides = [];
            
            // 如果data是数组，直接使用
            if (Array.isArray(data)) {
                similarPeptides = data;
            } else {
                // 使用与peptide_card.html一致的字段查找逻辑
                const finder = new DataFinder(data);
                
                // 首先查找"Similar Sequences"字段（与peptide_card.html一致）
                similarPeptides = finder.findValue("Similar Sequences") || 
                                finder.findValue("similar_sequences") || 
                                finder.findValue("similar_peptides") || 
                                finder.findValue("similarities") || [];
                
                // 检查数据是否有效并过滤空项
                if (Array.isArray(similarPeptides)) {
                    similarPeptides = similarPeptides.filter(item => {
                        if (!item || typeof item !== 'object') return false;
                        // 检查是否有SPADE_ID或序列信息
                        return (item.SPADE_ID && item.SPADE_ID.trim() !== '') || 
                               (item.Sequence && item.Sequence.trim() !== '') ||
                               (item.id && item.id.trim() !== '') ||
                               (item.sequence && item.sequence.trim() !== '');
                    });
                } else {
                    similarPeptides = [];
                }
            }
            
            console.log('相似肽段数据查找结果:', {
                totalCount: similarPeptides.length,
                sampleData: similarPeptides.slice(0, 3),
                dataKeys: Object.keys(data),
                hasDetailData: !!data
            });
            
            let similarPeptidesHtml = '';
            if (Array.isArray(similarPeptides) && similarPeptides.length > 0) {
                similarPeptidesHtml = `
                    <div class="similar-peptides-list">
                        ${similarPeptides.slice(0, 10).map((peptide, index) => { // 只显示前10个
                            // 使用与peptide_card.html一致的字段名
                            const id = peptide.SPADE_ID || peptide.id || peptide.peptide_id || 'N/A';
                            const sequence = peptide.Sequence || peptide.sequence || peptide.seq || '';
                            const similarity = peptide.Similarity || peptide.similarity || peptide.score || 0;
                            const name = peptide.name || peptide.peptide_name || id;
                            
                            return `
                                <div class="similar-peptide-item">
                                    <div class="similar-peptide-header">
                                        <div class="similar-peptide-info">
                                            <h4 class="similar-peptide-name">${name}</h4>
                                            <span class="similar-peptide-id">ID: ${id}</span>
                                        </div>
                                        <div class="similar-peptide-similarity">
                                            <span class="similarity-label">${similarityText}:</span>
                                            <span class="similarity-value">${(similarity * 100).toFixed(1)}%</span>
                                        </div>
                                    </div>
                                    ${sequence ? `
                                        <div class="similar-peptide-sequence">
                                            <span class="sequence-label">Sequence:</span>
                                            <span class="sequence-text">${sequence}</span>
                                        </div>
                                    ` : ''}
                                    <div class="similar-peptide-actions">
                                        <button class="peptide-link-btn" onclick="viewSimilarPeptide('${id}')" 
                                                title="${viewDetailsText}">
                                            <i class="fas fa-external-link-alt"></i> ${viewDetailsText}
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    ${similarPeptides.length > 10 ? `
                        <p class="similar-peptides-note" style="text-align: center; margin-top: 15px; color: rgba(255, 255, 255, 0.7); font-size: 0.9em;">
                            显示前10个相似肽段，共${similarPeptides.length}个
                        </p>
                    ` : ''}
                `;
            } else {
                similarPeptidesHtml = `<p class="empty-info">${noDataText}</p>`;
            }
            
            card.innerHTML = `
                <h3>${similarPeptidesTitle}</h3>
                ${similarPeptidesHtml}
            `;
        }
        
        // 查看相似肽段详情的函数
        function viewSimilarPeptide(peptideId) {
            if (peptideId && peptideId !== 'N/A') {
                // 在新标签页中打开相似肽段的可视化页面
                const url = `amp_visualization.html?id=${encodeURIComponent(peptideId)}`;
                window.open(url, '_blank', 'noopener,noreferrer');
            } else {
                alert('肽段ID无效，无法查看详情');
            }
        }

        // 跳转到搜索页面的函数
        function goToSearch() {
            window.location.href = 'search.html';
        }

        // 切换文本显示的函数
        function toggleText(button) {
            const container = button.closest('.collapsible-text');
            const shortText = container.querySelector('.short-text');
            const fullText = container.querySelector('.full-text');
            
            if (fullText.style.display === 'none') {
                shortText.style.display = 'none';
                fullText.style.display = 'block';
                button.textContent = '显示较少';
            } else {
                shortText.style.display = 'block';
                fullText.style.display = 'none';
                button.textContent = '显示更多';
            }
        }

        // 辅助函数：递归查找对象中的值
        function findValueInObject(obj, key) {
            // 如果对象为空，返回undefined
            if (!obj) return undefined;
            
            // 如果是数组，遍历每个元素并递归查找
            if (Array.isArray(obj)) {
                for (let i = 0; i < obj.length; i++) {
                    const result = findValueInObject(obj[i], key);
                    if (result !== undefined) return result;
                }
                return undefined;
            }
            
            // 如果是对象，检查key是否存在
            if (typeof obj === 'object') {
                // 直接检查属性是否存在
                if (obj.hasOwnProperty(key)) {
                    return obj[key];
                }
                
                // 递归检查每个属性
                for (const k in obj) {
                    if (obj.hasOwnProperty(k)) {
                        // 如果key和当前遍历的key相同（不区分大小写），返回对应值
                        if (k.toLowerCase() === key.toLowerCase()) {
                            return obj[k];
                        }
                        
                        // 递归检查子对象
                        if (typeof obj[k] === 'object' && obj[k] !== null) {
                            const result = findValueInObject(obj[k], key);
                            if (result !== undefined) return result;
                        }
                    }
                }
            }
            
            return undefined;
        }

        // 阅读进度和返回顶部功能已移至独立组件 js/reading-progress.js
        // 组件会自动初始化，无需手动调用
    </script>
</body>
</html>